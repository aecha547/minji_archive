<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SIDE C: THORNS</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='thorn' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23cc4444' stop-opacity='.8'/%3E%3Cstop offset='100%25' stop-color='%23661111' stop-opacity='.6'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' fill='%23050505'/%3E%3Cpath d='M16 2 L20 12 L16 8 L12 12 Z' fill='url(%23thorn)'/%3E%3Cpath d='M16 30 L20 20 L16 24 L12 20 Z' fill='url(%23thorn)'/%3E%3Cpath d='M2 16 L12 12 L8 16 L12 20 Z' fill='url(%23thorn)'/%3E%3Cpath d='M30 16 L20 12 L24 16 L20 20 Z' fill='url(%23thorn)'/%3E%3C/svg%3E">
<style>
@import url('https://fonts.googleapis.com/css2?family=VT323&family=Caveat:wght@400;600;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Space+Mono:wght@400;700&family=DM+Serif+Display:ital@0;1&display=swap');

:root {
  --bg-deep: #010101; --bg: #030303;
  --thorn-deep: #2a0808; --thorn: #5a1515; --thorn-light: #8a2828;
  --thorn-glow: #cc4040; --thorn-pale: #e88080;
  --blood: #aa2020; --void-deep: #101020; --void: #202040; --void-light: #404080;
  --pink-deep: #5a1025; --pink: #802845; --pink-soft: #d87895; --pink-glow: #ff5080;
  --gold: #907030; --gold-glow: #e0c080; --white: #e0dcd5; --dim: #5a5550;
  --trust: #4a8040; --determination: #ffcc00;
  --font-crt: 'VT323', monospace; --font-hand: 'Caveat', cursive;
  --font-serif: 'Cormorant Garamond', serif; --font-body: 'EB Garamond', serif;
  --font-mono: 'Space Mono', monospace; --font-display: 'DM Serif Display', serif;
  --ease: cubic-bezier(.4,0,.2,1); --ease-b: cubic-bezier(.34,1.56,.64,1);
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; overflow: hidden; background: var(--bg-deep);
  font-family: var(--font-body); color: var(--white);
  -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }

/* ‚ïê‚ïê‚ïê NOISE / CRT ‚ïê‚ïê‚ïê */
#noise-layer{position:fixed;inset:0;z-index:2;pointer-events:none;opacity:.05;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  animation:noiseShift .4s steps(5) infinite}
@keyframes noiseShift{0%,100%{transform:translate(0)}25%{transform:translate(-2%,-2%)}50%{transform:translate(2%,0)}75%{transform:translate(-1%,2%)}}

.crt-screen{position:relative;overflow:hidden;min-height:100vh}
.crt-screen::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.15) 2px,rgba(0,0,0,.15) 4px);pointer-events:none;z-index:100}
.crt-screen::after{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center,transparent 40%,rgba(0,0,0,.82) 100%);pointer-events:none;z-index:101}
.scan-bar{position:fixed;top:0;left:0;width:100%;height:10px;background:linear-gradient(180deg,transparent,rgba(204,64,64,.06),transparent);opacity:.6;z-index:102;pointer-events:none;animation:scanbar 6s linear infinite}
@keyframes scanbar{from{top:-8%}to{top:108%}}

/* ‚ïê‚ïê‚ïê SCREEN SHAKE ‚ïê‚ïê‚ïê */
@keyframes shake-sm{0%,100%{transform:translate(0)}20%{transform:translate(-2px,1px)}40%{transform:translate(2px,-1px)}60%{transform:translate(-1px,2px)}80%{transform:translate(1px,-2px)}}
@keyframes shake-md{0%,100%{transform:translate(0)}20%{transform:translate(-4px,3px)}40%{transform:translate(4px,-2px)}60%{transform:translate(-3px,4px)}80%{transform:translate(3px,-3px)}}
@keyframes shake-lg{0%,100%{transform:translate(0)}15%{transform:translate(-6px,4px)}30%{transform:translate(6px,-5px)}45%{transform:translate(-5px,6px)}60%{transform:translate(5px,-4px)}75%{transform:translate(-3px,3px)}}
.shake-sm{animation:shake-sm .3s ease-out!important}
.shake-md{animation:shake-md .4s ease-out!important}
.shake-lg{animation:shake-lg .5s ease-out!important}

/* ‚ïê‚ïê‚ïê FLASH / VFX OVERLAYS ‚ïê‚ïê‚ïê */
#flash-overlay{position:fixed;inset:0;z-index:200;pointer-events:none;opacity:0;transition:opacity .1s ease}
#flash-overlay.active{opacity:1}
#vignette{position:fixed;inset:0;z-index:150;pointer-events:none;opacity:0;transition:opacity 2s;
  background:radial-gradient(ellipse at center,transparent 30%,rgba(0,0,0,.9) 100%)}
#vignette.active{opacity:1}

/* ‚ïê‚ïê‚ïê PARTICLES ‚ïê‚ïê‚ïê */
#particle-container{position:fixed;inset:0;z-index:180;pointer-events:none;overflow:hidden}
.particle{position:absolute;border-radius:50%;pointer-events:none}
@keyframes pFly{0%{opacity:1;transform:translate(0) scale(1)}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0)}}
.sparkle{position:absolute;width:4px;height:4px;border-radius:50%;pointer-events:none}
@keyframes sparklePop{0%{transform:scale(0);opacity:1}50%{transform:scale(2);opacity:.7}100%{transform:scale(0);opacity:0}}
.thorn-ambient{position:fixed;width:3px;height:8px;pointer-events:none;z-index:3;opacity:0;
  clip-path:polygon(50% 0%,100% 50%,50% 100%,0% 50%)}
@keyframes ambFloat{0%{transform:translateY(100vh) rotate(0);opacity:0}10%{opacity:.08}90%{opacity:.08}100%{transform:translateY(-30px) rotate(180deg);opacity:0}}

/* ‚ïê‚ïê‚ïê LOADING ‚ïê‚ïê‚ïê */
#loading-overlay{position:fixed;inset:0;z-index:9999;background:var(--bg-deep);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;opacity:1;transition:opacity 2.5s var(--ease)}
#loading-overlay.hidden{opacity:0;pointer-events:none}
.thorn-loading{width:clamp(90px,24vw,130px);height:clamp(90px,24vw,130px);animation:thornPulse 3s ease-in-out infinite}
@keyframes thornPulse{0%,100%{transform:scale(1) rotate(0)}50%{transform:scale(1.08) rotate(4deg)}}
#loading-overlay h1{font-family:var(--font-display);font-size:clamp(1.4rem,5vw,2.1rem);font-weight:400;color:var(--thorn-glow);letter-spacing:4px;text-shadow:0 0 50px var(--thorn);text-align:center;margin-top:22px;animation:titleGlow 3s ease-in-out infinite}
@keyframes titleGlow{0%,100%{opacity:.6;text-shadow:0 0 30px var(--thorn)}50%{opacity:1;text-shadow:0 0 60px var(--thorn-glow)}}
#loading-overlay .sub{font-family:var(--font-hand);font-size:clamp(1rem,2.8vw,1.3rem);color:var(--thorn-pale);margin-top:10px;opacity:.4}
.boot-text{color:var(--thorn-light);font-family:var(--font-crt);font-size:clamp(12px,2vw,14px);margin-top:36px;text-align:left;width:min(340px,84vw);line-height:2.2;min-height:160px;white-space:pre-wrap}
.boot-cursor{display:inline-block;width:8px;height:1.1em;background:var(--thorn-light);vertical-align:text-bottom;margin-left:2px;animation:blink .8s step-end infinite}
@keyframes blink{50%{opacity:0}}

/* ‚ïê‚ïê‚ïê VIDEO OVERLAY ‚ïê‚ïê‚ïê */
#video-overlay{position:fixed;inset:0;z-index:10000;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 2s ease}
#video-overlay.active{opacity:1;pointer-events:auto}
#video-overlay video{max-width:94%;max-height:60vh;border-radius:4px;box-shadow:0 0 80px rgba(204,64,64,.2)}
.video-text{font-family:var(--font-serif);color:var(--white);text-align:center;margin-top:22px;font-size:clamp(1rem,3vw,1.2rem);line-height:2;max-width:500px;padding:0 18px;opacity:0;transition:opacity 2s ease 1s}
.video-text.show{opacity:1}
.video-continue{background:none;border:1px solid var(--thorn-light);color:var(--thorn-pale);font-family:var(--font-crt);font-size:.95rem;padding:9px 26px;cursor:pointer;border-radius:6px;margin-top:18px;transition:all .4s;opacity:0;pointer-events:none}
.video-continue.show{opacity:1;pointer-events:auto}
.video-continue:hover{background:var(--thorn);color:var(--white);border-color:var(--thorn-glow)}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.header{position:fixed;top:0;left:0;right:0;z-index:50;display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:linear-gradient(180deg,rgba(0,0,0,.92),transparent);pointer-events:none}
.header>*{pointer-events:auto}
.back-btn{color:var(--dim);text-decoration:none;font-family:var(--font-crt);font-size:.85rem;transition:all .5s;padding:5px 9px;border-radius:5px}
.back-btn:hover{color:var(--thorn-glow);text-shadow:0 0 18px var(--thorn);background:rgba(90,21,21,.15)}
.tape-label{background:linear-gradient(180deg,#f5efe5,#d8d0c0);color:#1a1510;padding:4px 12px;font-family:var(--font-crt);font-size:.6rem;text-transform:uppercase;letter-spacing:2px;border:1px solid #888;box-shadow:0 4px 12px rgba(0,0,0,.5)}
.scene-counter{font-family:var(--font-crt);font-size:11px;color:var(--dim);letter-spacing:2px}

/* ‚ïê‚ïê‚ïê CONTROLS ‚ïê‚ïê‚ïê */
.control-buttons{position:fixed;top:10px;right:10px;z-index:200;display:flex;gap:5px}
.ctrl-btn{background:rgba(0,0,0,.75);border:1px solid #2a2520;border-radius:5px;color:var(--dim);font-family:var(--font-crt);font-size:11px;padding:4px 10px;cursor:pointer;transition:all .4s;min-height:30px;backdrop-filter:blur(4px)}
.ctrl-btn:hover,.ctrl-btn.on{color:var(--thorn-glow);border-color:var(--thorn);box-shadow:0 0 10px rgba(204,64,64,.2)}
.ctrl-btn.music-on{color:var(--pink-soft);border-color:var(--pink);animation:musicP 2s ease-in-out infinite}
@keyframes musicP{0%,100%{box-shadow:0 0 6px rgba(216,120,149,.12)}50%{box-shadow:0 0 14px rgba(216,120,149,.25)}}

/* ‚ïê‚ïê‚ïê ARENA ‚ïê‚ïê‚ïê */
.arena-container{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:65px 16px 180px;z-index:10;transition:opacity 1s}

.turn-state{font-family:var(--font-crt);font-size:clamp(.7rem,2vw,.85rem);letter-spacing:3px;margin-bottom:6px;transition:all .4s;color:var(--pink-soft);min-height:20px}
.turn-state.dodge{color:var(--thorn-glow);animation:dodgePulse .5s ease-in-out infinite}
@keyframes dodgePulse{0%,100%{opacity:.7}50%{opacity:1}}

.boss-container{text-align:center;margin-bottom:10px;min-height:80px;position:relative}
.boss-sprite{font-size:clamp(2.8rem,9vw,4.5rem);filter:drop-shadow(0 0 18px rgba(204,64,64,.4));animation:bossIdle 2.5s ease-in-out infinite;transition:all .5s;display:inline-block;position:relative}
@keyframes bossIdle{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.boss-sprite.damaged{animation:bossDmg .35s ease-out!important;filter:drop-shadow(0 0 35px rgba(255,100,100,.8))!important}
@keyframes bossDmg{0%{transform:scale(1) translateX(0)}15%{transform:scale(1.12) translateX(-4px)}30%{transform:scale(.95) translateX(4px)}50%{transform:scale(1.05) translateX(-2px)}100%{transform:scale(1) translateX(0)}}
.boss-sprite.cracking{filter:drop-shadow(0 0 40px rgba(255,200,100,.5))}
.boss-sprite.dying{animation:bossDie 2.5s ease-out forwards!important}
@keyframes bossDie{0%{transform:scale(1);opacity:1}40%{transform:scale(1.4);filter:drop-shadow(0 0 80px rgba(255,255,255,.9))}100%{transform:scale(0);opacity:0}}
.boss-name{font-family:var(--font-crt);font-size:clamp(.8rem,2.5vw,1.1rem);color:var(--thorn-pale);letter-spacing:4px;margin-top:6px;text-shadow:0 0 16px var(--thorn);transition:all .8s}
.boss-hp-container{margin-top:6px;width:clamp(170px,42vw,260px);margin-inline:auto}
.boss-hp-bar{height:6px;background:var(--thorn-deep);border-radius:3px;border:1px solid var(--thorn);overflow:hidden}
.boss-hp-fill{height:100%;background:linear-gradient(90deg,var(--blood),var(--thorn-glow));transition:width .6s var(--ease);box-shadow:0 0 8px var(--thorn-glow)}
.boss-hp-text{font-family:var(--font-crt);font-size:10px;color:var(--dim);margin-top:2px;letter-spacing:1px}
.boss-quote{position:absolute;width:200px;left:50%;transform:translateX(-50%);top:-35px;font-family:var(--font-hand);font-size:.75rem;color:rgba(232,128,128,.4);pointer-events:none;white-space:nowrap;text-align:center;opacity:0;transition:opacity .5s}
.boss-quote.show{opacity:1}

.arena{width:clamp(230px,60vw,310px);height:clamp(230px,60vw,310px);border:3px solid var(--thorn-light);border-radius:10px;position:relative;background:radial-gradient(ellipse at center,rgba(90,21,21,.1),rgba(5,5,5,.97));box-shadow:inset 0 0 50px rgba(90,21,21,.25),0 0 25px rgba(90,21,21,.15);overflow:hidden;transition:border-color 1s,box-shadow 1s}
.arena.phase2{border-color:#556;box-shadow:inset 0 0 50px rgba(30,30,60,.35),0 0 25px rgba(30,30,60,.2)}
.arena.phase3{border-color:var(--pink);box-shadow:inset 0 0 50px rgba(128,40,69,.25),0 0 25px rgba(128,40,69,.15)}
.arena.phase4{border-color:var(--gold);box-shadow:inset 0 0 50px rgba(144,112,48,.25),0 0 25px rgba(144,112,48,.15)}
.arena::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 22px,rgba(90,21,21,.03) 22px,rgba(90,21,21,.03) 44px);pointer-events:none}

/* Crack overlays on arena */
.crack-overlay{position:absolute;inset:0;pointer-events:none;z-index:3;opacity:0;transition:opacity 1s}
.crack-overlay.show{opacity:1}

/* Player Soul */
.player{width:16px;height:16px;background:var(--pink-soft);position:absolute;transition:top .06s linear,left .06s linear;box-shadow:0 0 12px var(--pink-glow),0 0 24px rgba(255,80,128,.3);clip-path:polygon(50% 0%,100% 35%,80% 100%,50% 75%,20% 100%,0% 35%);z-index:10}
.player.hit{background:#fff;animation:playerHit .15s ease-out}
@keyframes playerHit{0%{transform:scale(1)}50%{transform:scale(.6)}100%{transform:scale(1)}}
.player.invulnerable{animation:iFrames .1s steps(2) infinite}
@keyframes iFrames{0%{opacity:1}50%{opacity:.15}}
.player.graze{box-shadow:0 0 20px var(--gold-glow),0 0 40px rgba(224,192,128,.5)}

/* Bullets */
.bullet{position:absolute;z-index:5}
.bullet.thorn{width:12px;height:18px;clip-path:polygon(50% 0%,100% 50%,50% 100%,0% 50%);background:linear-gradient(180deg,var(--thorn-glow),var(--blood));box-shadow:0 0 6px var(--thorn-glow)}
.bullet.tear{width:10px;height:13px;border-radius:50% 50% 50% 50%/60% 60% 40% 40%;background:linear-gradient(180deg,var(--pink-soft),var(--pink-deep));box-shadow:0 0 8px var(--pink)}
.bullet.word{padding:3px 7px;font-family:var(--font-hand);font-size:.8rem;color:var(--thorn-pale);background:rgba(90,21,21,.75);border:1px solid var(--thorn);border-radius:3px;white-space:nowrap}
.bullet.void{width:8px;height:8px;border-radius:50%;background:radial-gradient(circle,#556,#223);box-shadow:0 0 12px rgba(40,40,80,.6)}
.bullet.memory{padding:2px 6px;font-family:var(--font-serif);font-size:.7rem;color:var(--pink-soft);background:rgba(90,16,37,.6);border:1px solid var(--pink-deep);border-radius:3px;white-space:nowrap;font-style:italic}
.bullet.gold{width:10px;height:10px;border-radius:50%;background:radial-gradient(circle,var(--gold-glow),var(--gold));box-shadow:0 0 10px var(--gold)}
.bullet.chains{width:6px;height:20px;background:linear-gradient(180deg,#666,#333);border-radius:3px;box-shadow:0 0 4px rgba(100,100,100,.4)}

/* Player HP */
.player-hp-container{margin-top:12px;text-align:center;width:clamp(180px,45vw,280px)}
.hp-label{font-family:var(--font-crt);font-size:.85rem;color:var(--pink-soft);letter-spacing:3px;margin-bottom:4px}
.hp-bar-container{display:flex;align-items:center;gap:8px}
.hp-bar{flex:1;height:14px;background:var(--thorn-deep);border:2px solid var(--thorn);border-radius:3px;overflow:hidden}
.hp-fill{height:100%;background:linear-gradient(90deg,var(--pink-deep),var(--pink-soft));transition:width .3s var(--ease);box-shadow:0 0 6px var(--pink)}
.hp-fill.critical{background:linear-gradient(90deg,#600,#a22);animation:hpPulse .5s ease-in-out infinite}
@keyframes hpPulse{0%,100%{opacity:1}50%{opacity:.7}}
.hp-text{font-family:var(--font-crt);font-size:.9rem;color:var(--pink-soft);min-width:48px;text-align:right}
.determination-bar{width:100%;height:3px;background:var(--thorn-deep);border-radius:2px;margin-top:4px;overflow:hidden;opacity:.5}
.determination-fill{height:100%;background:var(--determination);width:0%;transition:width .5s}

/* ‚ïê‚ïê‚ïê DIALOGUE ‚ïê‚ïê‚ïê */
.dialogue-container{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);width:min(540px,92vw);z-index:30}
.dialogue-box{background:linear-gradient(160deg,rgba(42,8,8,.94),rgba(10,5,5,.97));border:2px solid var(--thorn);border-radius:8px;padding:clamp(10px,2.5vw,16px);min-height:70px;box-shadow:0 8px 28px rgba(0,0,0,.6),inset 0 0 18px rgba(90,21,21,.15)}
.dialogue-text{font-family:var(--font-serif);font-size:clamp(.9rem,2.4vw,1.1rem);color:var(--white);line-height:1.7;min-height:42px}
.dialogue-text .her{color:var(--pink-soft)}
.dialogue-text .wall{color:var(--thorn-pale);font-weight:600}
.dialogue-text .echo{color:var(--dim);font-style:italic}
.dialogue-text .damage{color:var(--thorn-glow)}
.dialogue-text .me{color:var(--earth-pale);font-style:italic}
.dialogue-text .gold{color:var(--gold-glow)}
.dialogue-text .void{color:#99a;font-weight:500}
.dialogue-text .crack{color:var(--gold-glow);text-decoration:line-through;text-decoration-color:var(--thorn)}

/* ‚ïê‚ïê‚ïê ACT BUTTONS ‚ïê‚ïê‚ïê */
.act-container{display:flex;justify-content:center;gap:clamp(6px,1.5vw,10px);margin-top:10px;flex-wrap:wrap}
.act-btn{background:rgba(0,0,0,.6);border:2px solid var(--thorn-light);color:var(--thorn-pale);padding:6px clamp(10px,2.5vw,18px);font-family:var(--font-crt);font-size:clamp(.8rem,2vw,1rem);cursor:pointer;transition:all .3s var(--ease);border-radius:5px;min-height:36px}
.act-btn:hover:not(:disabled){background:var(--thorn);border-color:var(--thorn-glow);color:var(--white);box-shadow:0 0 14px rgba(204,64,64,.25);transform:translateY(-2px)}
.act-btn:disabled{opacity:.35;cursor:default}
.act-btn.mercy{border-color:var(--trust);color:#80c080}
.act-btn.mercy:hover:not(:disabled){background:rgba(74,128,64,.25);border-color:var(--trust);box-shadow:0 0 14px rgba(74,128,64,.25)}
.act-btn.fight{border-color:var(--pink);color:var(--pink-soft)}
.act-btn.fight:hover:not(:disabled){background:rgba(128,40,69,.25);border-color:var(--pink-glow);box-shadow:0 0 14px rgba(255,80,128,.25)}
.act-btn.item{border-color:var(--gold);color:var(--gold-glow)}
.act-btn.item:hover:not(:disabled){background:rgba(144,112,48,.2);border-color:var(--gold-glow)}
.act-btn.special{border-color:#88f;color:#aaf}
.act-btn.special:hover:not(:disabled){background:rgba(80,80,200,.2);border-color:#aaf}
.act-btn.locked{border-color:#333;color:#444}

/* ‚ïê‚ïê‚ïê SHEEPY ‚ïê‚ïê‚ïê */
#sheepy{position:fixed;top:65px;left:14px;z-index:40;display:flex;flex-direction:column;align-items:center;gap:6px;opacity:0;transform:translateX(-20px);transition:all .8s var(--ease)}
#sheepy.show{opacity:1;transform:translateX(0)}
#sheepy.hide{opacity:0;transform:translateX(-20px)}
.sheepy-sprite{width:clamp(46px,11vw,64px);height:clamp(46px,11vw,64px)}
.sheepy-text{font-family:var(--font-hand);font-size:clamp(.7rem,1.7vw,.9rem);color:#c9a080;text-align:center;max-width:110px;line-height:1.4}

/* ‚ïê‚ïê‚ïê HUD ‚ïê‚ïê‚ïê */
#hud{position:fixed;bottom:16px;right:14px;z-index:50;text-align:right;opacity:0;transform:translateX(20px);transition:all 1s var(--ease);pointer-events:none}
#hud.show{opacity:1;transform:translateX(0)}
.meter{display:flex;align-items:center;gap:6px;margin-bottom:6px}
.meter-label{font-size:9px;font-family:var(--font-crt);color:var(--dim);width:40px;text-align:right;letter-spacing:1px}
.meter-bar{width:60px;height:4px;background:#0a0a0a;border-radius:2px;overflow:hidden;border:1px solid #1a1a1a}
.meter-fill{height:100%;transition:width .8s var(--ease);border-radius:2px}
.meter-fill.trust{background:linear-gradient(90deg,#2a4020,var(--trust))}
.meter-fill.guard{background:linear-gradient(90deg,#252530,#555)}
.meter-fill.sync{background:linear-gradient(90deg,var(--thorn-deep),var(--thorn-glow))}
.meter-value{font-size:10px;font-family:var(--font-crt);color:var(--thorn-pale);min-width:22px}
.turn-counter{font-family:var(--font-crt);font-size:9px;color:var(--dim);letter-spacing:1px;margin-top:6px}
.streak-indicator{font-family:var(--font-crt);font-size:8px;color:var(--gold-glow);letter-spacing:1px;margin-top:4px;opacity:0;transition:opacity .3s}
.streak-indicator.show{opacity:1}

/* ‚ïê‚ïê‚ïê TOUCH CONTROLS ‚ïê‚ïê‚ïê */
.touch-controls{position:fixed;bottom:180px;right:14px;z-index:60;display:none}
@media(pointer:coarse){.touch-controls{display:block}}
.touch-dpad{width:90px;height:90px;position:relative}
.touch-btn{position:absolute;width:32px;height:32px;background:rgba(90,21,21,.45);border:2px solid var(--thorn-light);border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--thorn-pale);font-size:1rem;cursor:pointer;-webkit-tap-highlight-color:transparent}
.touch-btn:active{background:var(--thorn);border-color:var(--thorn-glow)}
.touch-btn.up{top:0;left:50%;transform:translateX(-50%)}
.touch-btn.down{bottom:0;left:50%;transform:translateX(-50%)}
.touch-btn.left{left:0;top:50%;transform:translateY(-50%)}
.touch-btn.right{right:0;top:50%;transform:translateY(-50%)}

/* ‚ïê‚ïê‚ïê DETERMINATION OVERLAY ‚ïê‚ïê‚ïê */
#determination-overlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.95);display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 1s}
#determination-overlay.active{opacity:1;pointer-events:auto}
.determination-text{font-family:var(--font-serif);font-size:clamp(1rem,3vw,1.3rem);color:var(--determination);text-align:center;max-width:400px;line-height:2.2;opacity:0;transform:translateY(20px);transition:all 1s .5s}
.determination-text.show{opacity:1;transform:translateY(0)}
.determination-icon{font-size:3rem;margin-bottom:20px;opacity:0;transition:opacity 1s 1s}
.determination-icon.show{opacity:1}

/* ‚ïê‚ïê‚ïê ENDING SCREEN ‚ïê‚ïê‚ïê */
.ending-screen{position:fixed;inset:0;z-index:600;background:var(--bg-deep);display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 2s ease}
.ending-screen.active{opacity:1;pointer-events:auto}
.ending-icon{font-size:4rem;margin-bottom:20px}
.ending-title{font-family:var(--font-display);font-size:clamp(1.3rem,4vw,1.8rem);letter-spacing:3px;margin-bottom:14px;text-align:center}
.ending-body{font-family:var(--font-serif);font-size:clamp(.95rem,2.5vw,1.15rem);line-height:2;text-align:center;max-width:450px;padding:0 20px;color:var(--thorn-pale)}
.ending-stats{font-family:var(--font-crt);font-size:.75rem;color:var(--dim);margin-top:24px;line-height:2.2;text-align:center;letter-spacing:1px}
.ending-nav{margin-top:28px}
.ending-nav a{color:var(--dim);font-family:var(--font-crt);text-decoration:none;border:1px solid #2a2520;padding:8px 20px;border-radius:5px;transition:all .4s}
.ending-nav a:hover{color:var(--thorn-glow);border-color:var(--thorn)}

/* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
@media(max-width:500px){
.header{padding:8px 12px}
.dialogue-container{bottom:8px}
.dialogue-box{padding:8px;min-height:58px}
.act-btn{padding:5px 10px;font-size:.78rem}
#sheepy{top:55px;left:8px}
#hud{bottom:8px;right:8px}
.arena-container{padding:60px 12px 170px}
}
</style>
</head>
<body>

<!-- Flash Overlay -->
<div id="flash-overlay"></div>
<div id="vignette"></div>

<!-- Particle Container -->
<div id="particle-container"></div>

<!-- Determination Overlay -->
<div id="determination-overlay">
  <div class="determination-icon" id="determination-icon">üí´</div>
  <div class="determination-text" id="determination-text"></div>
</div>

<!-- Video Overlay -->
<div id="video-overlay">
  <video id="ending-video" playsinline><source src="WONDER.mp4" type="video/mp4"></video>
  <div class="video-text" id="video-text"></div>
  <button class="video-continue" id="video-continue">CONTINUE</button>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay">
  <svg class="thorn-loading" viewBox="0 0 100 100">
    <defs>
      <linearGradient id="thornGrad" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#cc4040"/><stop offset="100%" stop-color="#661111"/>
      </linearGradient>
      <filter id="thornGlow"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
    </defs>
    <path d="M50 5 L60 35 L90 40 L65 60 L75 95 L50 75 L25 95 L35 60 L10 40 L40 35 Z" fill="url(#thornGrad)" filter="url(#thornGlow)">
      <animate attributeName="opacity" values="0.7;1;0.7" dur="2s" repeatCount="indefinite"/>
    </path>
    <circle cx="50" cy="50" r="12" fill="#2a0808" stroke="#cc4040" stroke-width="2"/>
  </svg>
  <h1>SIDE C: THORNS</h1>
  <div class="sub">what grows in the dark</div>
  <div class="boot-text" id="boot-text"></div>
</div>

<!-- Main CRT Screen -->
<div class="crt-screen" id="crt-screen">
  <div class="scan-bar"></div>
  <div id="noise-layer"></div>

  <div class="header">
    <a href="index.html" class="back-btn">‚óÄ EJECT</a>
    <div class="tape-label">SIDE C: THORNS</div>
    <div class="scene-counter" id="counter">TURN 0</div>
  </div>

  <div class="control-buttons">
    <button class="ctrl-btn" id="audio-btn">‚ô™ SFX OFF</button>
    <button class="ctrl-btn" id="music-btn">‚ô´ MUSIC OFF</button>
  </div>

  <audio id="bgm" loop preload="auto"><source src="RUST OF LIFE.mp3" type="audio/mpeg"></audio>

  <div id="sheepy">
    <div class="sheepy-sprite" id="sheepy-sprite"></div>
    <div class="sheepy-text" id="sheepy-text"></div>
  </div>

  <div class="arena-container" id="arena-container">
    <div class="turn-state" id="turn-state">YOUR TURN</div>
    <div class="boss-container" id="boss-container">
      <div class="boss-quote" id="boss-quote"></div>
      <div class="boss-sprite" id="boss-sprite">üß±</div>
      <div class="boss-name" id="boss-name">THE WALL</div>
      <div class="boss-hp-container">
        <div class="boss-hp-bar"><div class="boss-hp-fill" id="boss-hp-fill" style="width:100%"></div></div>
        <div class="boss-hp-text" id="boss-hp-text"></div>
      </div>
    </div>
    <div class="arena" id="arena">
      <svg class="crack-overlay" id="crack-overlay" viewBox="0 0 310 310">
        <path class="crack-path" d="" stroke="rgba(204,64,64,0.3)" stroke-width="2" fill="none"/>
      </svg>
      <div class="player" id="player"></div>
    </div>
    <div class="player-hp-container">
      <div class="hp-label">‚ô• SOUL</div>
      <div class="hp-bar-container">
        <div class="hp-bar"><div class="hp-fill" id="hp-fill" style="width:100%"></div></div>
        <div class="hp-text"><span id="hp-current">20</span> / <span id="hp-max">20</span></div>
      </div>
      <div class="determination-bar"><div class="determination-fill" id="det-fill"></div></div>
    </div>
  </div>

  <div class="dialogue-container" id="dialogue-container">
    <div class="dialogue-box">
      <div class="dialogue-text" id="dialogue">...</div>
      <div class="act-container" id="act-container"></div>
    </div>
  </div>

  <div class="touch-controls">
    <div class="touch-dpad">
      <div class="touch-btn up" data-dir="up">‚ñ≤</div>
      <div class="touch-btn down" data-dir="down">‚ñº</div>
      <div class="touch-btn left" data-dir="left">‚óÑ</div>
      <div class="touch-btn right" data-dir="right">‚ñ∫</div>
    </div>
  </div>

  <div id="hud">
    <div class="meter"><span class="meter-label">TRUST</span><div class="meter-bar"><div class="meter-fill trust" id="tbar" style="width:0%"></div></div><span class="meter-value" id="tval">0</span></div>
    <div class="meter"><span class="meter-label">GUARD</span><div class="meter-bar"><div class="meter-fill guard" id="gbar" style="width:0%"></div></div><span class="meter-value" id="gval">0</span></div>
    <div class="meter"><span class="meter-label">SYNC</span><div class="meter-bar"><div class="meter-fill sync" id="sbar" style="width:0%"></div></div><span class="meter-value" id="sval">0</span></div>
    <div class="turn-counter" id="turn-counter">TURN 0</div>
    <div class="streak-indicator" id="streak-indicator">TALK STREAK x1</div>
  </div>
</div>

<!-- Ending Screen -->
<div class="ending-screen" id="ending-screen">
  <div class="ending-icon" id="ending-icon"></div>
  <div class="ending-title" id="ending-title"></div>
  <div class="ending-body" id="ending-body"></div>
  <div class="ending-stats" id="ending-stats"></div>
  <div class="ending-nav" id="ending-nav"></div>
</div>

<script>
'use strict';

const $ = id => document.getElementById(id);
const sleep = ms => new Promise(r => setTimeout(r, ms));
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
const rand = (min, max) => Math.random() * (max - min) + min;
const pick = arr => arr[Math.floor(Math.random() * arr.length)];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE - Deep integration with tape1 + tape2
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const State = {
  trust: 0, guard: 0, sync: 0, soil: 'barren',
  flags: new Set(),
  wallMaxHp: 100, wallHp: 100,
  playerHp: 20, playerMaxHp: 20,
  phase: 1, turn: 0,
  talkCount: 0, checkCount: 0, fightCount: 0, mercyAttempts: 0,
  talkStreak: 0, maxTalkStreak: 0,
  itemsUsed: 0, maxItems: 3, availableItems: [],
  iFrames: 0,
  grazes: 0,
  determination: 0, determinationUsed: false,
  totalDamageDealt: 0, totalDamageTaken: 0,
  phaseHistory: [],
  
  load() {
    try {
      const saved = JSON.parse(localStorage.getItem('seed_archive_v3') || '{}');
      if (saved.tape1) {
        this.trust = saved.tape1.trust || 0;
        this.guard = saved.tape1.guard || 0;
        this.soil = saved.tape1.soil || 'barren';
        if (saved.tape1.flags) saved.tape1.flags.forEach(f => this.flags.add(f));
      }
      if (saved.tape2) {
        this.sync = saved.tape2.sync || 0;
        this.trust = Math.max(this.trust, saved.tape2.trust || 0);
        this.guard = Math.max(this.guard, saved.tape2.guard || 0);
        if (saved.tape2.flags) saved.tape2.flags.forEach(f => this.flags.add(f));
      }
      
      // Wall scales with guard - but capped
      const guardBonus = Math.min(this.guard, 50);
      this.wallMaxHp = 100 + Math.floor(guardBonus * 0.8);
      this.wallHp = this.wallMaxHp;
      
      // Player HP scales with trust + sync
      this.playerMaxHp = 20;
      if (this.trust > 30) this.playerMaxHp = 24;
      if (this.trust > 60) this.playerMaxHp = 28;
      if (this.sync > 70) this.playerMaxHp = 32;
      if (this.trust > 80 && this.sync > 80) this.playerMaxHp = 35;
      this.playerHp = this.playerMaxHp;
      
      // Determination based on trust
      this.determination = Math.min(this.trust, 100);
      
      // Build available items based on tape history
      this.availableItems = [];
      if (this.has('e_voice_shared')) this.availableItems.push({id:'voice',name:'Her Voice Note',heal:8,guard:-5,used:false});
      if (this.has('e_sunrise_together')) this.availableItems.push({id:'sunrise',name:'The Sunrise',heal:6,sync:5,used:false});
      if (this.has('e_moment_opened')) this.availableItems.push({id:'moment',name:'That Moment',heal:5,trust:3,used:false});
      if (this.has('e_shared_laughter')) this.availableItems.push({id:'laughter',name:'Her Laugh',heal:4,used:false});
      if (this.has('e_physical_contact')) this.availableItems.push({id:'touch',name:'Three Seconds',heal:7,guard:-3,used:false});
      // Default items if none from history
      if (this.availableItems.length === 0) {
        this.availableItems.push({id:'memory',name:'A Memory',heal:3,used:false});
        this.availableItems.push({id:'hope',name:'Small Hope',heal:2,used:false});
      }
      this.maxItems = this.availableItems.length;
      
    } catch(e) { console.log('No previous state found'); }
  },
  
  has(id) { return this.flags.has(id); },
  
  save(endType) {
    try {
      const s = JSON.parse(localStorage.getItem('seed_archive_v3') || '{}');
      s.tape3 = {
        complete: true,
        ending: endType,
        trust: this.trust,
        guard: this.guard,
        sync: this.sync,
        soil: this.soil,
        flags: [...this.flags],
        turns: this.turn,
        damageDealt: this.totalDamageDealt,
        damageTaken: this.totalDamageTaken,
        grazes: this.grazes,
        maxStreak: this.maxTalkStreak,
        phases: this.phaseHistory
      };
      localStorage.setItem('seed_archive_v3', JSON.stringify(s));
    } catch(e) {}
  },
  
  updateHUD() {
    $('tbar').style.width = Math.min(this.trust, 100) + '%';
    $('gbar').style.width = Math.min(this.guard, 100) + '%';
    $('sbar').style.width = Math.min(this.sync, 100) + '%';
    $('tval').textContent = this.trust;
    $('gval').textContent = this.guard;
    $('sval').textContent = this.sync;
    $('turn-counter').textContent = 'TURN ' + this.turn;
    $('counter').textContent = 'T' + this.turn + ' P' + this.phase;
    $('det-fill').style.width = this.determination + '%';
    
    // Streak indicator
    if (this.talkStreak >= 2) {
      $('streak-indicator').textContent = `TALK STREAK x${this.talkStreak}`;
      $('streak-indicator').classList.add('show');
    } else {
      $('streak-indicator').classList.remove('show');
    }
  },
  
  updateHP() {
    const pct = Math.max(0, this.playerHp / this.playerMaxHp * 100);
    $('hp-fill').style.width = pct + '%';
    $('hp-current').textContent = Math.max(0, Math.floor(this.playerHp));
    $('hp-max').textContent = this.playerMaxHp;
    
    // Critical HP effect
    if (pct < 30) {
      $('hp-fill').classList.add('critical');
    } else {
      $('hp-fill').classList.remove('critical');
    }
  },
  
  updateBossHP() {
    const pct = Math.max(0, this.wallHp / this.wallMaxHp * 100);
    $('boss-hp-fill').style.width = pct + '%';
    $('boss-hp-text').textContent = Math.max(0, Math.ceil(this.wallHp)) + ' / ' + this.wallMaxHp;
    
    // Update crack overlay based on damage
    this.updateCracks();
  },
  
  updateCracks() {
    const dmg = 1 - (this.wallHp / this.wallMaxHp);
    const overlay = $('crack-overlay');
    if (dmg > 0.2) {
      overlay.classList.add('show');
      // More cracks as damage increases
      const intensity = Math.min(dmg * 2, 1);
      overlay.style.opacity = intensity * 0.5;
    }
  }
};

State.load();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   VFX
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const VFX = {
  flash(color = 'rgba(204,64,64,.25)', dur = 150) {
    const el = $('flash-overlay');
    el.style.background = color;
    el.classList.add('active');
    setTimeout(() => el.classList.remove('active'), dur);
  },
  shake(level = 'sm') {
    const s = $('crt-screen');
    s.classList.remove('shake-sm','shake-md','shake-lg');
    void s.offsetWidth;
    s.classList.add('shake-' + level);
    setTimeout(() => s.classList.remove('shake-' + level), 600);
  },
  particles(x, y, count = 8, color = '#cc4040') {
    const c = $('particle-container');
    for (let i = 0; i < count; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      const sz = rand(3, 7);
      p.style.cssText = `left:${x}px;top:${y}px;width:${sz}px;height:${sz}px;background:${color};--tx:${rand(-60,60)}px;--ty:${rand(-60,60)}px;animation:pFly ${rand(.4,.8)}s ease-out forwards`;
      c.appendChild(p);
      setTimeout(() => p.remove(), 1000);
    }
  },
  sparkles(x, y, count = 5, color = '#fff') {
    const c = $('particle-container');
    for (let i = 0; i < count; i++) {
      const s = document.createElement('div');
      s.className = 'sparkle';
      s.style.cssText = `left:${x + rand(-30,30)}px;top:${y + rand(-30,30)}px;background:${color};animation:sparklePop ${rand(.3,.6)}s ease-out forwards;animation-delay:${rand(0,.2)}s`;
      c.appendChild(s);
      setTimeout(() => s.remove(), 800);
    }
  },
  bossQuote(text, dur = 2000) {
    const q = $('boss-quote');
    q.textContent = text;
    q.classList.add('show');
    setTimeout(() => q.classList.remove('show'), dur);
  },
  damageNumber(x, y, num, color = '#cc4040') {
    const c = $('particle-container');
    const d = document.createElement('div');
    d.style.cssText = `position:absolute;left:${x}px;top:${y}px;font-family:var(--font-crt);font-size:1.2rem;color:${color};pointer-events:none;transition:all 1s ease-out;text-shadow:0 0 8px ${color}`;
    d.textContent = num > 0 ? '-' + num : '+' + Math.abs(num);
    c.appendChild(d);
    requestAnimationFrame(() => { d.style.top = (y - 40) + 'px'; d.style.opacity = '0'; });
    setTimeout(() => d.remove(), 1200);
  },
  vignette(on = true) {
    if (on) $('vignette').classList.add('active');
    else $('vignette').classList.remove('active');
  },
  grazeEffect(x, y) {
    this.sparkles(x, y, 3, '#e0c080');
  }
};

// Ambient floating thorns
function spawnAmbientThorns() {
  for (let i = 0; i < 8; i++) {
    const t = document.createElement('div');
    t.className = 'thorn-ambient';
    t.style.cssText = `left:${rand(5,95)}%;background:var(--thorn-deep);animation:ambFloat ${rand(12,22)}s linear infinite;animation-delay:${rand(0,12)}s`;
    document.body.appendChild(t);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUDIO
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const Snd = {
  ctx: null, master: null, on: false,
  init() { if(this.ctx)return; this.ctx = new(window.AudioContext||window.webkitAudioContext)(); this.master = this.ctx.createGain(); this.master.gain.value = 0; this.master.connect(this.ctx.destination); },
  resume() { if(this.ctx?.state==='suspended')this.ctx.resume(); },
  vol(v, t=.5) { if(!this.master)return; const n=this.ctx.currentTime; this.master.gain.cancelScheduledValues(n); this.master.gain.setValueAtTime(this.master.gain.value,n); this.master.gain.linearRampToValueAtTime(v,n+t); },
  _osc(freq, dur, type='sine', vol=.05, delay=0) {
    if(!this.ctx||!this.on)return;
    const t=this.ctx.currentTime+delay, o=this.ctx.createOscillator(), g=this.ctx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+.015); g.gain.exponentialRampToValueAtTime(.001,t+dur);
    o.connect(g); g.connect(this.master); o.start(t); o.stop(t+dur+.05);
  },
  type() { this._osc(400+Math.random()*200,.02,'triangle',.015); },
  click() { this._osc(350,.06,'sine',.05); },
  select() { this._osc(300,.15,'sine',.05); this._osc(450,.12,'sine',.04,.06); },
  damage() { this._osc(100,.2,'sawtooth',.08); this._osc(80,.25,'square',.05); },
  heal() { this._osc(400,.3,'sine',.04); this._osc(500,.25,'sine',.03,.1); this._osc(600,.2,'sine',.02,.2); },
  wallHit() { this._osc(150,.15,'triangle',.06); this._osc(200,.1,'sine',.04,.05); },
  crack() { this._osc(250,.3,'sawtooth',.05); this._osc(400,.2,'sine',.03,.1); this._osc(300,.25,'triangle',.04,.15); },
  phase() { [200,280,360,440].forEach((f,i)=>this._osc(f,.5,'sine',.04,i*.12)); },
  victory() { [300,380,460,540,620,700].forEach((f,i)=>this._osc(f,.8,'sine',.05,i*.15)); },
  death() { [400,300,200,100,60].forEach((f,i)=>this._osc(f,.7,'sawtooth',.06,i*.22)); },
  mercyChime() { [400,500,600,700,800].forEach((f,i)=>this._osc(f,.6,'sine',.04,i*.18)); },
  tension() { this._osc(80,.8,'sawtooth',.03); this._osc(85,.8,'sawtooth',.03,.05); },
  heartbeat() { this._osc(60,.15,'sine',.06); this._osc(55,.1,'sine',.04,.2); },
  graze() { this._osc(800,.05,'sine',.02); this._osc(1000,.03,'sine',.015,.02); },
  determination() { [200,300,400,500,600,700,800].forEach((f,i)=>this._osc(f,.5,'sine',.04,i*.1)); },
  ensure() { this.init(); this.resume(); if(!this.on){this.on=true;this.vol(.5,1.2);$('audio-btn').textContent='‚ô™ SFX ON';$('audio-btn').classList.add('on');} },
  toggle() { this.init();this.resume();this.on=!this.on; if(this.on){this.vol(.5,1);$('audio-btn').textContent='‚ô™ SFX ON';$('audio-btn').classList.add('on');}else{this.vol(0,.6);$('audio-btn').textContent='‚ô™ SFX OFF';$('audio-btn').classList.remove('on');} }
};

const Music = {
  el: $('bgm'), playing: false,
  toggle() {
    if(this.playing){this.el.pause();this.playing=false;$('music-btn').textContent='‚ô´ MUSIC OFF';$('music-btn').classList.remove('music-on');}
    else{this.el.volume=.25;const p=this.el.play();if(p)p.then(()=>{this.playing=true;$('music-btn').textContent='‚ô´ RUST ‚ñ∏';$('music-btn').classList.add('music-on');}).catch(()=>{});}
  },
  fadeOut(dur=2) {
    if(!this.playing)return;
    const start=this.el.volume,steps=30,step=start/steps;let i=0;
    const iv=setInterval(()=>{i++;this.el.volume=Math.max(0,start-step*i);if(i>=steps){clearInterval(iv);this.el.pause();this.playing=false;}},dur*1000/steps);
  }
};

$('audio-btn').onclick = () => Snd.toggle();
$('music-btn').onclick = () => Music.toggle();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SHEEPY - Enhanced emotional states
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const Sheepy = {
  moods: {
    nervous:'M-6 6 Q-4 3 0 5 Q4 7 6 5',
    protective:'M-8 5 Q-4 9 0 7 Q4 9 8 5',
    wounded:'M-7 7 Q0 4 7 7',
    fierce:'M-8 3 Q-4 7 0 5 Q4 7 8 3',
    breaking:'M-6 8 Q0 3 6 8',
    peaceful:'M-6 6 Q0 10 6 6',
    shadowed:'M-7 6 Q0 2 7 6',
    hopeful:'M-6 5 Q0 9 6 5',
    determined:'M-7 4 Q-3 8 0 6 Q3 8 7 4',
    grieving:'M-6 9 Q0 2 6 9',
    proud:'M-6 3 Q0 12 6 3'
  },
  svg(mood, size=64) {
    const m = this.moods[mood]||this.moods.nervous;
    const bodyColor = mood === 'breaking' ? '#d8c0b8' : mood === 'peaceful' ? '#f0e8e0' : '#e4dcd0';
    const faceColor = mood === 'fierce' ? '#f0d0d0' : mood === 'determined' ? '#e8d8d0' : '#ffeef2';
    return `<svg width="${size}" height="${size}" viewBox="0 0 120 120">
      <ellipse cx="60" cy="78" rx="38" ry="30" fill="${bodyColor}"/>
      <ellipse cx="36" cy="70" rx="14" ry="12" fill="#faf8f5"/>
      <ellipse cx="84" cy="70" rx="14" ry="12" fill="#faf8f5"/>
      <ellipse cx="60" cy="32" rx="22" ry="18" fill="${faceColor}"/>
      <ellipse cx="30" cy="22" rx="8" ry="6" fill="#c8a0a0" transform="rotate(-20 30 22)"/>
      <ellipse cx="90" cy="22" rx="8" ry="6" fill="#c8a0a0" transform="rotate(20 90 22)"/>
      <ellipse cx="48" cy="30" rx="5" ry="6" fill="#1a1a1a"><animate attributeName="ry" values="6;6;1;6;6" keyTimes="0;.4;.5;.6;1" dur="4s" repeatCount="indefinite"/></ellipse>
      <ellipse cx="72" cy="30" rx="5" ry="6" fill="#1a1a1a"><animate attributeName="ry" values="6;6;1;6;6" keyTimes="0;.4;.5;.6;1" dur="4s" repeatCount="indefinite"/></ellipse>
      <circle cx="49" cy="28" r="2" fill="#fff"/><circle cx="73" cy="28" r="2" fill="#fff"/>
      <ellipse cx="60" cy="44" rx="4" ry="3" fill="#b8a098"/>
      <g transform="translate(60 52)"><path d="${m}" stroke="#a89088" stroke-width="2.5" fill="none" stroke-linecap="round"/></g>
    </svg>`;
  },
  show(mood) { $('sheepy-sprite').innerHTML = this.svg(mood); $('sheepy').classList.add('show'); $('sheepy').classList.remove('hide'); },
  hide() { $('sheepy').classList.add('hide'); setTimeout(()=>$('sheepy').classList.remove('show'),500); },
  text(t) { $('sheepy-text').textContent = t; }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PLAYER
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const Player = {
  x:0, y:0, speed:4.5, el:null, arena:null,
  keys: {up:false,down:false,left:false,right:false},
  grazedThisFrame: false,
  
  init() {
    this.el=$('player'); this.arena=$('arena');
    this.x=this.arena.offsetWidth/2-8; this.y=this.arena.offsetHeight/2-8;
    this.updatePos();
    document.addEventListener('keydown',e=>this.setKey(e.key,true));
    document.addEventListener('keyup',e=>this.setKey(e.key,false));
    document.querySelectorAll('.touch-btn').forEach(btn=>{
      const d=btn.dataset.dir;
      btn.addEventListener('touchstart',e=>{e.preventDefault();this.keys[d]=true;});
      btn.addEventListener('touchend',e=>{e.preventDefault();this.keys[d]=false;});
      btn.addEventListener('touchcancel',()=>this.keys[d]=false);
    });
  },
  setKey(k,v) {
    if(k==='ArrowUp'||k==='w')this.keys.up=v;
    if(k==='ArrowDown'||k==='s')this.keys.down=v;
    if(k==='ArrowLeft'||k==='a')this.keys.left=v;
    if(k==='ArrowRight'||k==='d')this.keys.right=v;
  },
  update() {
    const spd = this.speed * (State.guard > 60 ? 0.85 : 1);
    if(this.keys.up)this.y-=spd;
    if(this.keys.down)this.y+=spd;
    if(this.keys.left)this.x-=spd;
    if(this.keys.right)this.x+=spd;
    this.x=clamp(this.x,0,this.arena.offsetWidth-16);
    this.y=clamp(this.y,0,this.arena.offsetHeight-16);
    this.updatePos();
  },
  updatePos() { this.el.style.left=this.x+'px'; this.el.style.top=this.y+'px'; },
  hit() { this.el.classList.add('hit'); setTimeout(()=>this.el.classList.remove('hit'),150); },
  setInvulnerable(ms) { State.iFrames=ms; this.el.classList.add('invulnerable'); setTimeout(()=>{this.el.classList.remove('invulnerable');State.iFrames=0;},ms); },
  reset() { this.x=this.arena.offsetWidth/2-8; this.y=this.arena.offsetHeight/2-8; this.updatePos(); },
  graze() { if(!this.grazedThisFrame){this.el.classList.add('graze');setTimeout(()=>this.el.classList.remove('graze'),100);this.grazedThisFrame=true;} }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BULLETS - Enhanced with graze detection
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const Bullets = {
  list:[], arena:null,
  init() { this.arena=$('arena'); },
  clear() { this.list.forEach(b=>b.el.remove()); this.list=[]; },
  spawn(type, x, y, vx, vy, opts={}) {
    const el=document.createElement('div');
    el.className=`bullet ${type}`;
    if((type==='word'||type==='memory')&&opts.text) el.textContent=opts.text;
    this.arena.appendChild(el);
    el.style.left=x+'px'; el.style.top=y+'px';
    const b={el,x,y,vx,vy,type,size:opts.size||10,damage:opts.damage||1,age:0,grazed:false};
    this.list.push(b);
    return b;
  },
  update() {
    const aw=this.arena.offsetWidth, ah=this.arena.offsetHeight;
    for(let i=this.list.length-1;i>=0;i--){
      const b=this.list[i];
      b.x+=b.vx; b.y+=b.vy; b.age++;
      b.el.style.left=b.x+'px'; b.el.style.top=b.y+'px';
      if(b.x<-40||b.x>aw+40||b.y<-40||b.y>ah+40||b.age>600){b.el.remove();this.list.splice(i,1);}
    }
  },
  checkCollision() {
    if(State.iFrames>0) return 'alive';
    const px=Player.x+8, py=Player.y+8;
    const grazeDist = 18; // Distance for graze
    
    for(let i=this.list.length-1;i>=0;i--){
      const b=this.list[i];
      const dist=Math.hypot(b.x+b.size/2-px, b.y+b.size/2-py);
      
      // Graze detection - close but not hit
      if(!b.grazed && dist < grazeDist && dist >= b.size/2+5){
        b.grazed = true;
        State.grazes++;
        Snd.graze();
        const rect = $('arena').getBoundingClientRect();
        VFX.grazeEffect(rect.left + b.x, rect.top + b.y);
        // Small trust bonus for grazing
        State.trust = clamp(State.trust + 0.5, 0, 100);
      }
      
      // Actual hit
      if(dist<b.size/2+5){
        State.playerHp-=b.damage;
        State.totalDamageTaken += b.damage;
        State.updateHP();
        Player.hit();
        Player.setInvulnerable(400);
        Snd.damage();
        VFX.flash('rgba(255,50,50,.25)',120);
        VFX.shake('sm');
        b.el.remove(); this.list.splice(i,1);
        if(State.playerHp<=0) return 'death';
      }
    }
    Player.grazedThisFrame = false;
    return 'alive';
  }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BOSS ATTACKS - Narratively meaningful patterns
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const Boss = {
  attackPatterns: {
    1: ['rainDown','sideWave','crossFire','thornCurtain','brickStorm'],
    2: ['spiralOut','wordStream','thornBurst','voidPulse','echoes'],
    3: ['heartBreak','memoryFlood','shadowDance','tearRain','chainsOfPast'],
    4: ['finalStand','everythingAtOnce','lastWords','desperateGrasp','truth']
  },
  
  // Boss quotes during attacks
  quotes: {
    1: ['Remember this?','You built me.','Every "it\'s fine."','Still protecting you.','I keep you safe.'],
    2: ['What if...','The uncertainty.','You don\'t know.','The void knows.','So many questions.'],
    3: ['She\'ll leave you.','Not good enough.','She\'ll see the cracks.','You\'ll ruin it.','Just like before.'],
    4: ['I tried to help.','We\'re the same.','Don\'t leave me.','I\'m all you have.','I AM you.']
  },
  
  startPhase(p) {
    State.phase=p; 
    State.phaseHistory.push(p);
    Snd.phase(); 
    VFX.shake('md'); 
    VFX.flash('rgba(255,255,255,.15)',300);
    VFX.vignette(true);
    setTimeout(() => VFX.vignette(false), 2000);
    
    const sp=$('boss-sprite'), nm=$('boss-name'), ar=$('arena');
    ar.classList.remove('phase2','phase3','phase4');
    
    if(p===2){
      sp.textContent='üï≥Ô∏è';
      nm.textContent='THE VOID';
      ar.classList.add('phase2');
      nm.style.color='#8090b0';
    } else if(p===3){
      sp.textContent='üë§';
      nm.textContent='HER SHADOW';
      ar.classList.add('phase3');
      sp.classList.add('cracking');
      nm.style.color='var(--pink-soft)';
    } else if(p===4){
      sp.textContent='üíî';
      nm.textContent='THE CORE';
      ar.classList.add('phase4');
      sp.classList.add('cracking');
      nm.style.color='var(--gold-glow)';
    }
  },
  
  async runAttack() {
    const patterns=this.attackPatterns[State.phase]||this.attackPatterns[1];
    const name=pick(patterns);
    
    // Show boss quote
    const quotes = this.quotes[State.phase];
    VFX.bossQuote(pick(quotes), 1500);
    
    $('turn-state').textContent='DODGE!';
    $('turn-state').classList.add('dodge');
    Snd.tension();
    
    await this.patterns[name]();
    
    // Let remaining bullets travel
    await sleep(1200);
    Bullets.clear();
    $('turn-state').textContent='YOUR TURN';
    $('turn-state').classList.remove('dodge');
  },
  
  patterns: {
    // ‚îÄ‚îÄ‚îÄ Phase 1: The Wall - Past Hurts ‚îÄ‚îÄ‚îÄ
    async rainDown() {
      // Callback: if player has 'e_door_closed', more intense
      const intensity = State.has('e_door_closed') ? 1.3 : 1;
      setDialogue('<span class="wall">THE WALL</span> rains down past hurts.');
      const count = Math.floor(25 * intensity);
      for(let i=0;i<count;i++){
        Bullets.spawn('thorn',rand(10,290),-15,0,rand(2.5,5.5)*intensity,{damage:State.guard>50?2:1});
        await sleep(85);
      }
    },
    async sideWave() {
      setDialogue('Waves of doubt crash from both sides.');
      for(let w=0;w<4;w++){
        // From left
        for(let i=0;i<7;i++) Bullets.spawn('thorn',-10,i*42,3.5,0);
        await sleep(280);
        // From right
        for(let i=0;i<7;i++) Bullets.spawn('thorn',320,i*42,-3.5,0);
        await sleep(280);
      }
    },
    async crossFire() {
      setDialogue('Thorns cross from every angle. Find the gaps.');
      // Center burst
      for(let a=0;a<Math.PI*2;a+=Math.PI/10){
        Bullets.spawn('thorn',150,150,Math.cos(a)*2.5,Math.sin(a)*2.5);
      }
      await sleep(600);
      // Offset burst
      for(let a=Math.PI/20;a<Math.PI*2;a+=Math.PI/10){
        Bullets.spawn('thorn',150,150,Math.cos(a)*3,Math.sin(a)*3);
      }
      await sleep(500);
    },
    async thornCurtain() {
      setDialogue('A curtain of thorns descends. Find the safe path.');
      for(let row=0;row<5;row++){
        const gap=rand(40,240);
        for(let x=0;x<300;x+=20){
          if(Math.abs(x-gap)>40) Bullets.spawn('thorn',x,-10,0,3);
        }
        await sleep(500);
      }
    },
    async brickStorm() {
      setDialogue('The Wall throws pieces of itself.');
      for(let i=0;i<20;i++){
        const x = rand(20,280);
        const y = rand(20,280);
        // Spawn at random positions and move toward player
        const px = Player.x, py = Player.y;
        const angle = Math.atan2(py - y, px - x);
        Bullets.spawn('thorn',x,y,Math.cos(angle)*2,Math.sin(angle)*2,{damage:1});
        await sleep(120);
      }
    },
    
    // ‚îÄ‚îÄ‚îÄ Phase 2: The Void - Uncertainty ‚îÄ‚îÄ‚îÄ
    async spiralOut() {
      setDialogue('<span class="void">THE VOID</span> spirals with uncertainty.');
      let a=0;
      for(let i=0;i<40;i++){
        const x=150+Math.cos(a)*15, y=150+Math.sin(a)*15;
        Bullets.spawn('void',x,y,Math.cos(a)*2.2,Math.sin(a)*2.2);
        a+=.3; await sleep(60);
      }
    },
    async wordStream() {
      // Callback: use tape1/tape2 specific words
      let words;
      if(State.has('e_voice_shared')){
        words=['what if she heard','too late now','she knows you saved it','creepy?','or sweet?','you can\'t tell'];
      } else if(State.has('e_door_closed')){
        words=['nvm','nvm','nvm','you closed the door','she won\'t open it again','nvm'];
      } else {
        words=['what if','not enough','she\'ll leave','you\'ll fail','why try','it won\'t last'];
      }
      setDialogue('The questions you whisper at 3am.');
      for(const w of words){
        Bullets.spawn('word',-50,rand(40,260),2.2,0,{text:w,size:40,damage:2});
        await sleep(350);
      }
    },
    async thornBurst() {
      setDialogue('<span class="void">THE VOID</span> bursts outward.');
      for(let b=0;b<5;b++){
        const x=rand(40,260),y=rand(40,260);
        VFX.particles(x+$('arena').getBoundingClientRect().left,y+$('arena').getBoundingClientRect().top,4,'#404080');
        for(let a=0;a<Math.PI*2;a+=Math.PI/5)Bullets.spawn('void',x,y,Math.cos(a)*2.5,Math.sin(a)*2.5);
        await sleep(400);
      }
    },
    async voidPulse() {
      setDialogue('The void pulses. <span class="echo">Stay centered.</span>');
      for(let ring=0;ring<3;ring++){
        for(let a=0;a<Math.PI*2;a+=Math.PI/8){
          const r=30+ring*35;
          Bullets.spawn('void',150+Math.cos(a)*r,150+Math.sin(a)*r,Math.cos(a)*1.5,Math.sin(a)*1.5);
        }
        await sleep(450);
      }
    },
    async echoes() {
      setDialogue('Echoes of what could have been.');
      for(let i=0;i<15;i++){
        const x=rand(0,300), y=rand(0,300);
        const delay = rand(0.5, 1.5);
        // Spawn delayed bullet
        setTimeout(() => {
          if(Bullets.arena) Bullets.spawn('void',x,y,rand(-1,1),rand(-1,1),{damage:1});
        }, delay * 1000);
        await sleep(100);
      }
      await sleep(1500);
    },
    
    // ‚îÄ‚îÄ‚îÄ Phase 3: Her Shadow - Fear ‚îÄ‚îÄ‚îÄ
    async heartBreak() {
      setDialogue('<span class="her">Her shadow</span> shows you what could break you.');
      for(let t=0;t<Math.PI*2;t+=.18){
        const x=150+50*Math.pow(Math.sin(t),3);
        const y=130-40*(.8*Math.cos(t)-.2*Math.cos(2*t)-.1*Math.cos(3*t));
        Bullets.spawn('tear',x,y,(x-150)/25,(y-130)/25,{damage:2});
        await sleep(40);
      }
    },
    async memoryFlood() {
      // Deep callback to tape1/tape2 specific memories
      let mems;
      if(State.has('e_voice_shared') && State.has('e_sunrise_together')){
        mems=['her laugh at 3am','that pause before she spoke','the way she typed ...','silence after goodnight','her voice cracking','she remembered','the sunrise you shared','her voice in the dark'];
      } else if(State.has('e_physical_contact')){
        mems=['three seconds','her hand in yours','the scratch you noticed','that first touch','she didn\'t pull away','you didn\'t breathe'];
      } else if(State.has('e_missed_moment')){
        mems=['the moment you missed','chose safe','the what-if','it could have been','but you didn\'t','safe doesn\'t warm you'];
      } else {
        mems=['missed chances','words unsaid','every "nvm"','typing...','left on read','almost said it'];
      }
      setDialogue('<span class="echo">Memories flood the arena.</span>');
      for(let i=0;i<25;i++){
        Bullets.spawn('memory',rand(-40,300),-15,rand(-.3,.3),rand(2,3.5),{text:pick(mems),size:35,damage:2});
        await sleep(120);
      }
    },
    async shadowDance() {
      setDialogue('<span class="her">Her shadow</span> dances around you.');
      let a=0;
      for(let i=0;i<45;i++){
        const r=80+Math.sin(i*.3)*40;
        const x=150+Math.cos(a)*r, y=150+Math.sin(a)*r;
        Bullets.spawn('tear',x,y,-Math.cos(a)*1.8,-Math.sin(a)*1.8,{damage:1});
        a+=.22; await sleep(55);
      }
    },
    async tearRain() {
      setDialogue('Tears fall like rain.');
      for(let i=0;i<35;i++){
        Bullets.spawn('tear',rand(10,290),-10,rand(-.5,.5),rand(3,5.5),{damage:1});
        await sleep(70);
      }
    },
    async chainsOfPast() {
      setDialogue('Chains of the past bind the arena.');
      // Vertical chains
      for(let x=30;x<300;x+=60){
        for(let y=-20;y<320;y+=25){
          Bullets.spawn('chains',x,y,0,2,{size:8,damage:1});
        }
        await sleep(200);
      }
    },
    
    // ‚îÄ‚îÄ‚îÄ Phase 4: The Core - Final Battle ‚îÄ‚îÄ‚îÄ
    async finalStand() {
      setDialogue('<span class="damage">THE FINAL STAND.</span> Everything at once.');
      for(let i=0;i<18;i++){
        Bullets.spawn('thorn',rand(0,300),-10,0,3.5,{damage:2});
        Bullets.spawn('tear',-10,rand(0,300),3,0,{damage:1});
        await sleep(85);
      }
      await sleep(250);
      for(let a=0;a<Math.PI*2;a+=Math.PI/12) Bullets.spawn('thorn',150,150,Math.cos(a)*3.5,Math.sin(a)*3.5,{damage:2});
    },
    async everythingAtOnce() {
      setDialogue('Every fear. Every doubt. <span class="damage">All at once.</span>');
      const words=['failure','alone','not enough','too late','broken'];
      for(let i=0;i<30;i++){
        if(i%6===0) Bullets.spawn('word',rand(-30,300),-15,0,2.5,{text:pick(words),size:40,damage:2});
        Bullets.spawn('thorn',rand(0,300),-10,rand(-.5,.5),rand(3,5),{damage:1});
        await sleep(70);
      }
    },
    async lastWords() {
      // Callback to tape1 choices
      let lw;
      if(State.has('e_voice_shared')){
        lw=['I should have said it','she deserved to hear','my voice at 3am','I was scared','it\'s too late now'];
      } else if(State.has('e_pushed_away')){
        lw=['I pushed her away','she was trying','I was scared','why didn\'t I stay','my fault'];
      } else {
        lw=['I never said it','she deserved better','I was scared','it\'s too late now','why didn\'t I try'];
      }
      setDialogue('The last words you never said.');
      for(const w of lw){
        Bullets.spawn('memory',-60,rand(30,270),2,0,{text:w,size:45,damage:3});
        await sleep(450);
        for(let a=0;a<Math.PI*2;a+=Math.PI/4) Bullets.spawn('thorn',150,150,Math.cos(a)*2,Math.sin(a)*2);
        await sleep(250);
      }
    },
    async desperateGrasp() {
      setDialogue('<span class="damage">THE CORE</span> grasps desperately.');
      // Converging rings
      for(let ring=4;ring>=0;ring--){
        for(let a=0;a<Math.PI*2;a+=Math.PI/8){
          const r=120-ring*25;
          Bullets.spawn('tear',150+Math.cos(a)*r,150+Math.sin(a)*r,-Math.cos(a)*2.2,-Math.sin(a)*2.2,{damage:2});
        }
        await sleep(350);
      }
    },
    async truth() {
      setDialogue('<span class="gold">The truth emerges.</span> It was never about her.');
      // Golden bullets - the real core
      for(let a=0;a<Math.PI*2;a+=Math.PI/16){
        Bullets.spawn('gold',150,150,Math.cos(a)*1.8,Math.sin(a)*1.8,{damage:3});
      }
      await sleep(800);
      for(let a=Math.PI/32;a<Math.PI*2;a+=Math.PI/16){
        Bullets.spawn('gold',150,150,Math.cos(a)*2.2,Math.sin(a)*2.2,{damage:3});
      }
    }
  }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DIALOGUE & ACTS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setDialogue(text) { $('dialogue').innerHTML = text; }

function setActs(acts) {
  const c=$('act-container'); c.innerHTML='';
  for(const a of acts){
    const b=document.createElement('button');
    b.className=`act-btn ${a.type||''}`;
    b.textContent=a.label;
    if(a.disabled)b.disabled=true;
    if(a.locked){b.disabled=true;b.classList.add('locked');}
    b.addEventListener('click',()=>{Snd.select();a.action();});
    c.appendChild(b);
  }
}

function disableActs() { document.querySelectorAll('.act-btn').forEach(b=>b.disabled=true); }
function enableActs() { document.querySelectorAll('.act-btn').forEach(b=>{if(!b.classList.contains('locked'))b.disabled=false;}); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GAME LOOP
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let gameActive=false, inDodge=false, gameLoop=null, gameEnded=false;

function startGameLoop() {
  gameActive=true;
  gameLoop=setInterval(()=>{
    if(!gameActive)return;
    Player.update();
    Bullets.update();
    if(inDodge){
      const st=Bullets.checkCollision();
      if(st==='death' && !gameEnded) handleDeath();
    }
  },1000/60);
}
function stopGameLoop() { gameActive=false; if(gameLoop)clearInterval(gameLoop); }

async function dodgePhase() {
  inDodge=true; disableActs();
  await Boss.runAttack();
  inDodge=false;
  if(!gameEnded) showTurnActs();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PHASE-SPECIFIC TALK DIALOGUE - Deep callbacks to tape1/tape2
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const PhaseTalks = {
  1: [
    {text:'You whisper: <span class="me">"It\'s different this time."</span><br><span class="wall">THE WALL</span> shudders. It\'s heard that before.',dmg:3,trust:1},
    {text:'You say: <span class="me">"She makes me want to try again."</span><br>Cracks form in the mortar.',dmg:6,trust:2},
    {text:'You admit: <span class="me">"I\'m scared she\'ll be like the others."</span><br>Honesty cuts deeper than blades.',dmg:10,trust:4,guard:-3},
    {text:'You say: <span class="me">"But what if she\'s worth it?"</span><br>Bricks begin to fall.',dmg:12,trust:3},
    {text:'You speak: <span class="me">"I built you. I know your weakness."</span><br>The Wall trembles.',dmg:15,trust:5,guard:-5},
  ],
  2: [
    {text:'You ask: <span class="me">"What if I\'m too broken?"</span><br><span class="void">THE VOID</span> answers: <span class="echo">"Then she\'ll see the cracks."</span>',dmg:4,trust:1},
    {text:'You say: <span class="me">"What if she leaves?"</span><br><span class="echo">Then at least you\'ll have had her.</span>',dmg:8,trust:3},
    {text:'You admit: <span class="me">"What if I\'m not enough?"</span><br>The Void flickers. <span class="void">"What if you are?"</span>',dmg:12,trust:5},
    {text:'You declare: <span class="me">"\'What if\' doesn\'t matter. She does."</span><br>The Void contracts.',dmg:16,trust:5,guard:-5},
  ],
  3: [
    {text:'You speak to her shadow: <span class="me">"I see you. I see past you."</span><br><span class="her">"Do you? Really?"</span>',dmg:5,trust:2},
    {text:'<span class="me">"You\'re not her. You\'re my fear of her."</span><br>The shadow wavers.',dmg:10,trust:4},
    {text:'<span class="me">"Minji is real. I choose reality over fear."</span><br>The shadow <span class="damage">cracks</span>.',dmg:15,trust:8,guard:-8},
    {text:'<span class="me">"I trust her. I trust myself."</span><br>The shadow <span class="damage">shatters</span>.',dmg:20,trust:10,guard:-12},
  ],
  4: [
    {text:'You face the core: <span class="me">"You\'ve protected me. But I don\'t need you anymore."</span>',dmg:8,trust:5},
    {text:'<span class="me">"Thank you for keeping me safe. But safe isn\'t living."</span><br>The core <span class="gold">glows</span>.',dmg:15,trust:8,guard:-10},
    {text:'<span class="me">"I forgive you. I forgive myself."</span><br>The core begins to <span class="gold">dissolve</span>.',dmg:25,trust:12,guard:-15},
  ]
};

// Special dialogue based on tape history
function getSpecialTalkDialog() {
  if(State.has('e_door_closed') && State.talkCount === 1) {
    return {text:'You remember the door you closed. <span class="me">"I closed it. I can open it."</span><br>The Wall remembers too.',dmg:8,trust:3,guard:-4};
  }
  if(State.has('e_pushed_away') && State.talkCount === 2) {
    return {text:'You remember pushing her away. <span class="me">"I was scared. I pushed. That was me."</span><br>Admitting it hurts. That\'s the point.',dmg:10,trust:4,guard:-5};
  }
  if(State.has('e_voice_shared') && State.talkCount === 3) {
    return {text:'You remember her voice at 3am. <span class="me">"She shared that with me. She trusted me first."</span><br>The Wall cracks deeper.',dmg:12,trust:6,guard:-6};
  }
  if(State.has('e_sunrise_together') && State.talkCount === 4) {
    return {text:'You remember the sunrise. <span class="me">"We shared something real. I want more of that."</span><br>Light seeps through the cracks.',dmg:15,trust:8,guard:-8};
  }
  return null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ACT HANDLERS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function doCheck() {
  State.checkCount++;
  const checks = [
    '<span class="wall">THE WALL</span> ‚Äî ATK 10 DEF 99.<br>Built from every time you said <span class="echo">"it\'s fine."</span>',
    'Inside the cracks: <span class="echo">old conversations you memorized at 2am.</span>',
    'The mortar between bricks: <span class="echo">every "nvm" she ever sent. Every time you didn\'t ask why.</span>',
    'At its core: <span class="damage">the fear of being known, and found lacking.</span>',
    'You sense weakness. The Wall\'s foundation is built on <span class="echo">sand</span>. Not stone.',
    'Deep inside: <span class="her">a heartbeat that isn\'t yours.</span>'
  ];
  
  // Special checks based on history
  if(State.checkCount === 1 && State.has('e_pushed_away'))
    setDialogue('You recognize this Wall. <span class="echo">You built it the day you pushed her away.</span>');
  else if(State.checkCount === 2 && State.has('e_door_closed'))
    setDialogue('The Wall remembers the door. <span class="echo">The one you closed. It\'s still echoing.</span>');
  else if(State.checkCount === 3 && State.has('e_voice_shared'))
    setDialogue('Her voice echoes inside. <span class="her">"You saved it. That means something."</span>');
  else
    setDialogue(checks[Math.min(State.checkCount-1,checks.length-1)]);
  
  if(State.checkCount>=3){
    State.wallHp-=4;
    State.updateBossHP();
    Snd.wallHit();
  }
  State.turn++; State.updateHUD();
  await sleep(2200);
  await dodgePhase();
}

async function doTalk() {
  State.talkCount++;
  State.talkStreak++;
  State.maxTalkStreak = Math.max(State.maxTalkStreak, State.talkStreak);
  
  // Check for special dialogue
  let talk = getSpecialTalkDialog();
  if(!talk) {
    const talks=PhaseTalks[State.phase]||PhaseTalks[1];
    talk=talks[Math.min(State.talkCount-1,talks.length-1)];
  }
  
  // Streak bonus
  let streakBonus = Math.min(State.talkStreak - 1, 5);
  let dmg = talk.dmg + streakBonus;
  
  // Sync bonus
  if(State.sync>50) dmg = Math.floor(dmg * 1.2);
  if(State.sync>80) dmg = Math.floor(dmg * 1.4);
  
  setDialogue(talk.text);
  State.wallHp-=dmg;
  State.totalDamageDealt += dmg;
  State.updateBossHP();
  
  if(dmg>0){
    Snd.crack();
    VFX.shake(dmg>15?'md':'sm');
    $('boss-sprite').classList.add('damaged');
    setTimeout(()=>$('boss-sprite').classList.remove('damaged'),350);
    const br=$('boss-container').getBoundingClientRect();
    VFX.particles(br.left+br.width/2,br.top+br.height/2,6,'#cc4040');
    VFX.damageNumber(br.left+br.width/2,br.top+20,dmg);
  }
  if(talk.trust)State.trust=clamp(State.trust+talk.trust,0,100);
  if(talk.guard)State.guard=clamp(State.guard+talk.guard,0,100);
  State.turn++; State.updateHUD();
  await sleep(2500);
  await checkPhaseTransition();
  if(!gameEnded) await dodgePhase();
}

async function doFight() {
  State.fightCount++;
  State.talkStreak = 0; // Break streak
  
  const baseDmg=4+Math.floor(State.sync/12);
  const dmg=baseDmg+State.fightCount*2;
  State.wallHp-=dmg;
  State.totalDamageDealt += dmg;
  State.updateBossHP();
  Snd.crack(); VFX.shake('md'); VFX.flash('rgba(255,80,128,.2)',120);
  $('boss-sprite').classList.add('damaged');
  setTimeout(()=>$('boss-sprite').classList.remove('damaged'),350);
  const br=$('boss-container').getBoundingClientRect();
  VFX.particles(br.left+br.width/2,br.top+br.height/2,12,State.phase>=3?'#d87895':'#cc4040');
  VFX.damageNumber(br.left+br.width/2,br.top+20,dmg,'#ff5080');
  
  // Fighting builds guard
  State.guard+=5;
  State.trust=Math.max(0,State.trust-2);
  
  if(State.fightCount<=2) setDialogue(`You strike at <span class="damage">THE WALL</span>. Dealt ${dmg} damage.<br><span class="echo">But violence builds walls too.</span>`);
  else if(State.fightCount<=4) setDialogue(`You slam against the barrier. ${dmg} damage.<br><span class="echo">Your hands are bleeding. Guard +5.</span>`);
  else setDialogue(`Another blow. ${dmg} damage.<br><span class="damage">Are you fighting the wall, or yourself?</span>`);
  
  State.turn++; State.updateHUD();
  await sleep(2000);
  await checkPhaseTransition();
  if(!gameEnded) await dodgePhase();
}

async function doMercy() {
  State.mercyAttempts++;
  State.talkStreak = 0;
  
  const wallPct = State.wallHp / State.wallMaxHp;
  
  // Mercy conditions: HP low, trust high, talked enough
  if(wallPct<=.15 && State.talkCount>=4 && State.trust>=25) {
    await mercyVictory();
    return;
  } else if(wallPct<=.25 && State.talkCount>=3 && State.trust>=15) {
    setDialogue('The barrier trembles. <span class="echo">Almost... keep trying. It\'s listening now.</span>');
    State.wallHp -= 8;
    State.updateBossHP();
    Snd.mercyChime();
    VFX.sparkles(window.innerWidth/2,window.innerHeight/3,10,'#80c080');
  } else if(wallPct<=.50) {
    setDialogue('The Wall considers your mercy.<br><span class="wall">"...why?"</span><br><span class="echo">It doesn\'t understand kindness. Not yet.</span>');
    State.wallHp -= 3;
    State.updateBossHP();
  } else if(State.fightCount > State.talkCount) {
    setDialogue('<span class="wall">THE WALL</span> sneers.<br><span class="damage">"You chose violence. Now you want mercy?"</span><br><span class="echo">Actions have consequences.</span>');
    State.guard += 3;
  } else {
    setDialogue('<span class="wall">THE WALL</span> stands firm.<br>Mercy requires understanding first.<br><span class="echo">Talk more. Check deeper. Learn its cracks.</span>');
  }
  
  State.turn++; State.updateHUD();
  await sleep(2500);
  await dodgePhase();
}

async function doItem() {
  // Find first unused item
  const item = State.availableItems.find(i => !i.used);
  if(!item){
    setDialogue('<span class="echo">Nothing left to use.</span>');
    State.turn++; State.updateHUD();
    await sleep(1500);
    await dodgePhase();
    return;
  }
  item.used = true;
  State.itemsUsed++;
  
  let healText = '';
  if(item.heal) {
    State.playerHp = Math.min(State.playerMaxHp, State.playerHp + item.heal);
    healText = `Healed ${item.heal} HP.`;
  }
  if(item.trust) State.trust = clamp(State.trust + item.trust, 0, 100);
  if(item.guard) State.guard = clamp(State.guard + item.guard, 0, 100);
  if(item.sync) State.sync = clamp(State.sync + item.sync, 0, 100);
  
  State.updateHP();
  State.updateHUD();
  Snd.heal();
  VFX.sparkles(window.innerWidth/2,window.innerHeight/2,8,'#d87895');
  
  // Custom text based on item
  const itemTexts = {
    voice: `You play her voice note again.<br><span class="her">That laugh.</span> It mends something broken.`,
    sunrise: `You remember the sunrise you shared.<br>Warmth lingers where the light touched.`,
    moment: `You recall the moment you opened up.<br><span class="echo">That courage still burns.</span>`,
    laughter: `You replay her laugh in your mind.<br><span class="her">It echoes against the walls.</span>`,
    touch: `You remember those three seconds.<br>Your hand in hers. <span class="echo">Real.</span>`,
    memory: `You hold onto a fragment of kindness.<br><span class="echo">It\'s small. But it\'s yours.</span>`,
    hope: `You find a spark of hope.<br><span class="echo">Barely there. But present.</span>`
  };
  
  setDialogue(itemTexts[item.id] || `You use ${item.name}. ${healText}`);
  
  State.turn++; State.updateHUD();
  await sleep(2200);
  await dodgePhase();
}

async function doRemember() {
  State.talkStreak = 0;
  let dmg = 0;
  
  if(State.sync>70){
    dmg=15;
    setDialogue('You remember her patterns. Her laugh. Her silence.<br><span class="her">You know her frequency.</span> The Wall has no answer for this.');
  } else if(State.sync>50){
    dmg=10;
    setDialogue('Most patterns are clear. Some still blur.<br><span class="echo">But the signal strengthens.</span>');
    State.sync+=5;
  } else if(State.sync>30){
    dmg=5;
    setDialogue('Some patterns emerge from the noise.<br><span class="echo">You\'re starting to understand.</span>');
  } else {
    dmg=2;
    setDialogue('You strain to remember...<br><span class="echo">The signal is too weak. You never tuned in enough.</span>');
  }
  
  State.wallHp-=dmg;
  State.totalDamageDealt += dmg;
  State.updateBossHP();
  if(dmg>5){Snd.crack();VFX.shake('sm');$('boss-sprite').classList.add('damaged');setTimeout(()=>$('boss-sprite').classList.remove('damaged'),350);}
  
  State.turn++; State.updateHUD();
  await sleep(2200);
  await checkPhaseTransition();
  if(!gameEnded) await dodgePhase();
}

async function doConfess() {
  State.talkStreak = 0;
  // Only available in phase 4 with high trust
  const dmg = 30 + Math.floor(State.trust / 2);
  State.wallHp -= dmg;
  State.totalDamageDealt += dmg;
  State.trust = clamp(State.trust - 10, 0, 100);
  State.guard = clamp(State.guard - 15, 0, 100);
  
  Snd.crack();
  VFX.shake('lg');
  VFX.flash('rgba(255,200,100,.3)',200);
  
  $('boss-sprite').classList.add('damaged');
  setTimeout(()=>$('boss-sprite').classList.remove('damaged'),350);
  
  const br=$('boss-container').getBoundingClientRect();
  VFX.particles(br.left+br.width/2,br.top+br.height/2,15,'#e0c080');
  VFX.damageNumber(br.left+br.width/2,br.top+20,dmg,'#e0c080');
  
  setDialogue(`<span class="gold">You confess:</span> <span class="me">"I\'m terrified. But I\'d rather be terrified with her than safe without her."</span><br>The core <span class="gold">resonates</span>.`);
  
  State.turn++; State.updateHUD();
  await sleep(3000);
  await checkPhaseTransition();
  if(!gameEnded) await dodgePhase();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SHOW TURN ACTS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showTurnActs() {
  if(gameEnded) return;
  enableActs();
  
  const acts = [
    {label:'CHECK',action:doCheck},
    {label:'TALK',action:doTalk},
  ];
  
  // Add REMEMBER only if sync > 15
  if(State.sync > 15) acts.push({label:'REMEMBER',type:'special',action:doRemember});
  
  acts.push({label:'FIGHT',type:'fight',action:doFight});
  
  // Item button - shows remaining count
  const remainingItems = State.availableItems.filter(i => !i.used).length;
  acts.push({
    label: remainingItems > 0 ? `ITEM (${remainingItems})` : 'ITEM',
    type:'item',
    action:doItem,
    disabled: remainingItems === 0
  });
  
  // CONFESS - only in phase 4 with high trust
  if(State.phase === 4 && State.trust >= 50) {
    acts.push({label:'CONFESS',type:'special',action:doConfess});
  }
  
  acts.push({label:'MERCY',type:'mercy',action:doMercy});
  
  setActs(acts);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PHASE TRANSITIONS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function checkPhaseTransition() {
  if(gameEnded) return;
  if(State.wallHp<=0) { await fightVictory(); return; }
  
  const pct = State.wallHp / State.wallMaxHp;
  
  if(State.phase===1 && pct<=.65){
    State.phase=2; Boss.startPhase(2);
    State.talkCount=0;
    
    setDialogue('<span class="damage">THE WALL cracks open.</span><br>Inside: a void of <span class="void">"what if"</span>');
    Sheepy.show('wounded'); Sheepy.text('The deeper wounds.');
    
    await sleep(3000);
  } else if(State.phase===2 && pct<=.35){
    State.phase=3; Boss.startPhase(3);
    State.talkCount=0;
    
    setDialogue('From the void emerges... <span class="her">her shadow</span>.<br>The barrier you feared most: your image of her.');
    Sheepy.show('fierce'); Sheepy.text('Face her. Face yourself.');
    Snd.heartbeat();
    
    await sleep(3000);
  } else if(State.phase===3 && pct<=.15){
    State.phase=4; Boss.startPhase(4);
    State.talkCount=0;
    
    setDialogue('The shadow dissolves. What remains is <span class="gold">the core</span>.<br>Your oldest wound. The first betrayal that taught you to build walls.');
    Sheepy.show('determined'); Sheepy.text('This is the last one.');
    
    await sleep(3500);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DETERMINATION SAVE - One chance if trust is high enough
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function showDetermination() {
  return new Promise(resolve => {
    const overlay = $('determination-overlay');
    const icon = $('determination-icon');
    const text = $('determination-text');
    
    overlay.classList.add('active');
    Music.fadeOut(1);
    Snd.determination();
    
    setTimeout(() => {
      icon.classList.add('show');
      icon.textContent = 'üí´';
    }, 500);
    
    setTimeout(() => {
      text.classList.add('show');
      text.innerHTML = `<span style="color:var(--determination)">Your determination refuses to fade.</span><br><br>"But it refused."`;
    }, 1200);
    
    setTimeout(() => {
      text.innerHTML += '<br><br><span class="echo" style="font-size:0.85em">You remember why you started. That\'s enough.</span>';
    }, 2500);
    
    setTimeout(() => {
      overlay.classList.remove('active');
      icon.classList.remove('show');
      text.classList.remove('show');
      resolve();
    }, 4000);
  });
}

async function handleDeath() {
  gameEnded = true;
  stopGameLoop();
  Bullets.clear();
  disableActs();
  
  // Check for determination save
  if(State.determination >= 30 && !State.determinationUsed) {
    State.determinationUsed = true;
    await showDetermination();
    
    // Revive with partial HP
    State.playerHp = Math.floor(State.playerMaxHp * 0.4);
    State.updateHP();
    gameEnded = false;
    
    Sheepy.show('hopeful');
    Sheepy.text('One more chance.');
    
    setDialogue('<span class="gold">You stand again.</span> Make it count.');
    
    await sleep(2000);
    startGameLoop();
    showTurnActs();
    return;
  }
  
  // True death
  await gameOver();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MERCY VICTORY ‚Äî GOOD ENDING WITH VIDEO
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function mercyVictory() {
  gameEnded=true; stopGameLoop(); Bullets.clear(); disableActs();
  
  Snd.mercyChime();
  VFX.flash('rgba(255,255,255,.25)',500);
  VFX.shake('md');
  VFX.vignette(true);
  
  $('boss-sprite').classList.add('dying');
  $('boss-name').textContent='FREED';
  
  setDialogue('<span class="gold">The barrier dissolves.</span><br>Not broken. <em>Released.</em><br>You chose to understand. That changes everything.');
  
  Sheepy.show('peaceful'); Sheepy.text('You did it. With kindness.');
  
  // Shower of gold particles
  for(let i=0;i<30;i++){
    setTimeout(()=>VFX.sparkles(rand(100,window.innerWidth-100),rand(100,window.innerHeight-100),4,'#e0c080'),i*150);
  }
  
  State.flags.add('e_mercy_ending');
  State.flags.add('e_wall_freed');
  State.save('mercy');
  
  await sleep(5000);
  Music.fadeOut(3);
  
  // Play WONDER.mp4
  await playEndingVideo();
  
  // Show ending screen
  showEnding('mercy');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FIGHT VICTORY
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function fightVictory() {
  gameEnded=true; stopGameLoop(); Bullets.clear(); disableActs();
  
  Snd.victory();
  VFX.flash('rgba(204,64,64,.35)',400);
  VFX.shake('lg');
  
  $('boss-sprite').textContent='üí•';
  $('boss-sprite').classList.add('damaged');
  $('boss-name').textContent='BROKEN';
  
  setDialogue('<span class="damage">The Wall crumbles.</span><br>Broken by force, not by understanding.<br>You can move forward... but the rubble remains inside.');
  
  Sheepy.show('shadowed'); Sheepy.text('It\'s over. But...');
  
  State.flags.add('e_fight_ending');
  State.guard += 12;
  State.save('fight');
  
  await sleep(5000);
  Music.fadeOut(3);
  showEnding('fight');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GAME OVER ‚Äî NO RETRY. THAT'S LIFE.
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function gameOver() {
  stopGameLoop(); Bullets.clear();
  
  Snd.death();
  VFX.flash('rgba(0,0,0,.7)',800);
  VFX.shake('lg');
  VFX.vignette(true);
  
  $('boss-sprite').textContent='üß±';
  $('player').style.opacity='0';
  
  Sheepy.show('breaking'); Sheepy.text('...');
  
  setDialogue('<span class="damage">Your soul breaks.</span><br>The Wall remains. The thorns grow thicker.');
  
  await sleep(3000);
  
  // Different messages based on how far they got
  let finalMessage;
  if(State.fightCount > State.talkCount * 2) {
    finalMessage = '<span class="echo">You chose violence. Violence answers with walls.</span>';
  } else if(State.phase === 1) {
    finalMessage = '<span class="echo">The first barrier was too much. Sometimes you\'re not ready. That\'s okay.</span>';
  } else if(State.phase === 2) {
    finalMessage = '<span class="echo">The uncertainty consumed you. The void has that effect.</span>';
  } else if(State.phase === 3) {
    finalMessage = '<span class="echo">Her shadow was too real. Some fears take more than one attempt.</span>';
  } else {
    finalMessage = '<span class="echo">So close. The core remains. Maybe next time.</span>';
  }
  
  setDialogue(finalMessage);
  
  await sleep(3500);
  
  setDialogue('<span class="echo">Some barriers outlast us.<br>Some walls never come down.<br>That\'s not always a failure. Sometimes it\'s just... how it is.</span>');
  
  Sheepy.text('I\'m sorry.');
  
  State.flags.add('e_wall_won');
  State.save('defeat');
  
  await sleep(4000);
  
  setDialogue('<span class="echo">The thorns close in.<br>Maybe in another life. But not this one.</span>');
  
  await sleep(4000);
  Music.fadeOut(3);
  showEnding('defeat');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ENDING VIDEO (MERCY ONLY)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function playEndingVideo() {
  return new Promise(resolve => {
    const overlay = $('video-overlay');
    const video = $('ending-video');
    const text = $('video-text');
    const btn = $('video-continue');
    
    overlay.classList.add('active');
    
    video.volume = 0.35;
    const playPromise = video.play();
    
    if(playPromise) {
      playPromise.then(() => {
        setTimeout(() => {
          text.innerHTML = 'The thorns part.<br>What grows next is up to you.<br><br><span class="her">She\'s waiting.</span>';
          text.classList.add('show');
        }, 2000);
        
        video.addEventListener('ended', () => {
          btn.classList.add('show');
          btn.onclick = () => { overlay.classList.remove('active'); resolve(); };
        });
        
        // Fallback timeout
        setTimeout(() => {
          if(!btn.classList.contains('show')) {
            btn.classList.add('show');
            btn.onclick = () => { video.pause(); overlay.classList.remove('active'); resolve(); };
          }
        }, 25000);
        
      }).catch(() => {
        text.innerHTML = 'The thorns part.<br>What grows next is up to you.<br><br><em style="color:var(--dim);font-size:.8rem">(Video could not load)</em>';
        text.classList.add('show');
        setTimeout(() => { btn.classList.add('show'); btn.onclick = () => { overlay.classList.remove('active'); resolve(); }; }, 2500);
      });
    } else {
      text.innerHTML = 'The thorns part.<br>What grows next is up to you.';
      text.classList.add('show');
      setTimeout(() => { btn.classList.add('show'); btn.onclick = () => { overlay.classList.remove('active'); resolve(); }; }, 2500);
    }
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ENDING SCREEN
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showEnding(type) {
  const es = $('ending-screen');
  const icon = $('ending-icon');
  const title = $('ending-title');
  const body = $('ending-body');
  const stats = $('ending-stats');
  const nav = $('ending-nav');
  
  if(type==='mercy'){
    icon.textContent = 'üå∏';
    title.textContent = 'THE WALL BECOMES A GATE';
    title.style.color = 'var(--gold-glow)';
    body.innerHTML = 'You chose understanding over destruction.<br>The thorns part. What grows next<br>depends on the soil you\'ve tended.<br><br><em style="color:var(--pink-soft)">She\'s worth it. You know that now.</em>';
  } else if(type==='fight'){
    icon.textContent = '‚öîÔ∏è';
    title.textContent = 'THE WALL CRUMBLES';
    title.style.color = 'var(--thorn-glow)';
    body.innerHTML = 'Broken by force, not by understanding.<br>You can move forward‚Äî<br>but the ground is scarred.<br><br><em style="color:var(--dim)">The rubble becomes the foundation of the next wall.</em>';
  } else {
    icon.textContent = 'ü•Ä';
    title.textContent = 'THE THORNS REMAIN';
    title.style.color = 'var(--dim)';
    body.innerHTML = 'Some walls don\'t come down.<br>Some barriers outlast the one who built them.<br><br>That\'s not always a tragedy.<br>Sometimes it\'s just the shape of a life.<br><br><em style="color:var(--thorn-pale)">The next version of you will be stronger.</em>';
  }
  
  const phNames = {1:'THE WALL',2:'THE VOID',3:'HER SHADOW',4:'THE CORE'};
  stats.innerHTML = `
    TURNS: ${State.turn} | PHASE: ${phNames[State.phase] || State.phase}<br>
    TRUST: ${State.trust} | GUARD: ${State.guard} | SYNC: ${State.sync}<br>
    DAMAGE DEALT: ${State.totalDamageDealt} | DAMAGE TAKEN: ${State.totalDamageTaken}<br>
    GRAZES: ${State.grazes} | MAX STREAK: ${State.maxTalkStreak}<br>
    SOIL: ${State.soil.toUpperCase()} | TALKS: ${State.talkCount} | FIGHTS: ${State.fightCount}<br>
    ${State.determinationUsed ? 'üí´ DETERMINATION USED' : ''}
  `;
  
  if(type==='defeat'){
    nav.innerHTML = '<a href="index.html">EJECT ‚Äî RETURN TO ARCHIVE</a>';
  } else {
    nav.innerHTML = '<a href="index.html">CONTINUE TO SIDE D ‚Üí</a>';
  }
  
  setTimeout(() => es.classList.add('active'), 500);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BOOT SEQUENCE - Contextual based on tape history
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function typeBootLine(el, text, spd=18) {
  for(let i=0;i<text.length;i++){ el.textContent+=text[i]; Snd.type(); await sleep(spd); }
  el.textContent+='\n';
}

async function boot() {
  const bt = $('boot-text');
  spawnAmbientThorns();
  
  await sleep(1200);
  await typeBootLine(bt,'> SEED ARCHIVE v3.0',14);
  await sleep(300);
  await typeBootLine(bt,'> LOADING SIDE C: THORNS...',16);
  await sleep(250);
  await typeBootLine(bt,`> SOIL TYPE: ${State.soil.toUpperCase()}`,12);
  await sleep(150);
  await typeBootLine(bt,`> TRUST LEVEL: ${State.trust}`,12);
  await sleep(150);
  await typeBootLine(bt,`> SYNC LEVEL: ${State.sync}`,12);
  await sleep(150);
  await typeBootLine(bt,`> GUARD LEVEL: ${State.guard}`,12);
  await sleep(200);
  
  Snd.ensure();
  
  const wallStr = State.guard>60?'REINFORCED':State.guard>30?'STANDARD':'WEAKENED';
  await typeBootLine(bt,`> WALL INTEGRITY: ${wallStr}`,14);
  await sleep(200);
  
  // Contextual boot messages based on history
  if(State.guard>60) await typeBootLine(bt,'> ‚ö† HIGH GUARD DETECTED ‚Äî SLOW MOVEMENT',14);
  if(State.sync>70) await typeBootLine(bt,'> ‚ú¶ FREQUENCY ALIGNED ‚Äî PATTERN BONUS',14);
  if(State.trust>70) await typeBootLine(bt,'> ‚ô• HIGH TRUST ‚Äî DETERMINATION ARMED',14);
  
  // Specific flag callbacks
  if(State.has('e_voice_shared')) await typeBootLine(bt,'> ‚ô™ VOICE NOTE LOADED AS ITEM',14);
  if(State.has('e_sunrise_together')) await typeBootLine(bt,'> ‚òÄ SUNRISE MEMORY LOADED',14);
  if(State.has('e_pushed_away')) await typeBootLine(bt,'> ‚óÑ WALL REMEMBERS THE PUSH',14);
  if(State.has('e_door_closed')) await typeBootLine(bt,'> ‚úï DOOR ECHO DETECTED',14);
  if(State.has('e_physical_contact')) await typeBootLine(bt,'> ‚úã TOUCH MEMORY AVAILABLE',14);
  
  await typeBootLine(bt,`> HP: ${State.playerMaxHp} / WALL: ${State.wallMaxHp}`,14);
  await sleep(200);
  await typeBootLine(bt,'> READY.',22);
  
  const cur=document.createElement('span');cur.className='boot-cursor';bt.appendChild(cur);
  
  await sleep(1800);
  $('loading-overlay').classList.add('hidden');
  await sleep(2200);
  startBattle();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   START BATTLE - Contextual intro
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function startBattle() {
  $('hud').classList.add('show');
  State.updateHUD();
  State.updateHP();
  State.updateBossHP();
  
  Player.init();
  Bullets.init();
  
  // Sheepy context
  if(State.guard>50){Sheepy.show('protective');Sheepy.text('This wall is strong. Be careful.');}
  else if(State.sync>60){Sheepy.show('fierce');Sheepy.text('You know her patterns. Use that.');}
  else if(State.trust>50){Sheepy.show('hopeful');Sheepy.text('Your heart is ready. Trust it.');}
  else if(State.trust>20){Sheepy.show('determined');Sheepy.text('You have warmth. Use it.');}
  else{Sheepy.show('nervous');Sheepy.text('Be careful in there.');}
  
  // Intro dialogue - deep callbacks to tape history
  let intro;
  if(State.has('e_pushed_away') && State.has('e_door_closed'))
    intro='<span class="wall">THE WALL</span> looms before you.<br><span class="echo">Built from every door you closed and every push you gave. It remembers.</span>';
  else if(State.has('e_pushed_away'))
    intro='<span class="wall">THE WALL</span> looms before you.<br><span class="echo">Built from every time you pushed her away. It knows your patterns.</span>';
  else if(State.has('e_door_closed'))
    intro='<span class="wall">THE WALL</span> looms before you.<br><span class="echo">It remembers the door closing. That echo never stopped.</span>';
  else if(State.has('e_moment_opened'))
    intro='<span class="wall">THE WALL</span> looms before you.<br><span class="echo">But there are cracks. You opened a moment once. You can do it again.</span>';
  else if(State.has('e_voice_shared'))
    intro='<span class="wall">THE WALL</span> looms before you.<br><span class="echo">Her voice still echoes inside. You carry something real.</span>';
  else
    intro='<span class="wall">THE WALL</span> looms before you.<br>Built from past betrayals. Mortared with <span class="echo">"it\'s fine."</span> Armed with thorns.';
  
  setDialogue(intro);
  showTurnActs();
  startGameLoop();
}

// Start
boot();
</script>
</body>
</html>
