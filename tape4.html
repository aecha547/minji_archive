<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SIDE D: BLOOM</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3CradialGradient id='bloom' cx='50%25' cy='50%25'%3E%3Cstop offset='0%25' stop-color='%23d87895' stop-opacity='.9'/%3E%3Cstop offset='100%25' stop-color='%23802845' stop-opacity='.5'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='32' height='32' fill='%23050505'/%3E%3Ccircle cx='16' cy='16' r='10' fill='url(%23bloom)'/%3E%3C/svg%3E">
<style>
@import url('https://fonts.googleapis.com/css2?family=VT323&family=Caveat:wght@400;600;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Space+Mono:wght@400;700&family=DM+Serif+Display:ital@0;1&display=swap');

:root {
  --bg-deep: #010101; --bg: #030303;
  --bloom-deep: #2a0a15; --bloom: #5a1830; --bloom-light: #8a2850;
  --bloom-glow: #d85080; --bloom-pale: #f8a0c0;
  --gold: #907030; --gold-glow: #e0c080;
  --pink-deep: #5a1025; --pink: #802845; --pink-soft: #d87895; --pink-glow: #ff5080;
  --white: #e0dcd5; --dim: #5a5550; --trust: #4a8040;
  --font-crt: 'VT323', monospace; --font-hand: 'Caveat', cursive;
  --font-serif: 'Cormorant Garamond', serif; --font-body: 'EB Garamond', serif;
  --font-display: 'DM Serif Display', serif;
  --ease: cubic-bezier(.4,0,.2,1); --ease-b: cubic-bezier(.34,1.56,.64,1);
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; overflow: hidden; background: var(--bg-deep);
  font-family: var(--font-body); color: var(--white);
  -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }

/* â•â•â• NOISE / CRT â•â•â• */
#noise-layer{position:fixed;inset:0;z-index:2;pointer-events:none;opacity:.035;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  animation:noiseShift .5s steps(5) infinite}
@keyframes noiseShift{0%,100%{transform:translate(0)}25%{transform:translate(-2%,-2%)}50%{transform:translate(2%,0)}75%{transform:translate(-1%,2%)}}

.crt-screen{position:relative;overflow:hidden;min-height:100vh}
.crt-screen::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.15) 2px,rgba(0,0,0,.15) 4px);pointer-events:none;z-index:100}
.crt-screen::after{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center,transparent 40%,rgba(0,0,0,.82) 100%);pointer-events:none;z-index:101}
.scan-bar{position:fixed;top:0;left:0;width:100%;height:10px;background:linear-gradient(180deg,transparent,rgba(216,80,128,.06),transparent);opacity:.6;z-index:102;pointer-events:none;animation:scanbar 6s linear infinite}
@keyframes scanbar{from{top:-8%}to{top:108%}}

/* â•â•â• FLASH / OVERLAYS â•â•â• */
#flash-overlay{position:fixed;inset:0;z-index:200;pointer-events:none;opacity:0;transition:opacity .1s ease}
#flash-overlay.active{opacity:1}
#vignette{position:fixed;inset:0;z-index:150;pointer-events:none;opacity:0;transition:opacity 2s;
  background:radial-gradient(ellipse at center,transparent 30%,rgba(0,0,0,.9) 100%)}
#vignette.active{opacity:1}

/* â•â•â• CANVAS PARTICLES â•â•â• */
#particle-canvas{position:fixed;inset:0;z-index:180;pointer-events:none}

/* â•â•â• LOADING â•â•â• */
#loading-overlay{position:fixed;inset:0;z-index:9999;background:var(--bg-deep);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;opacity:1;transition:opacity 2.5s var(--ease)}
#loading-overlay.hidden{opacity:0;pointer-events:none}
.bloom-loading{width:clamp(90px,24vw,130px);height:clamp(90px,24vw,130px);animation:bloomPulse 3s ease-in-out infinite}
@keyframes bloomPulse{0%,100%{transform:scale(1) rotate(0)}50%{transform:scale(1.08) rotate(4deg)}}
#loading-overlay h1{font-family:var(--font-display);font-size:clamp(1.4rem,5vw,2.1rem);font-weight:400;color:var(--bloom-glow);letter-spacing:4px;text-shadow:0 0 50px var(--bloom);text-align:center;margin-top:22px;animation:titleGlow 3s ease-in-out infinite}
@keyframes titleGlow{0%,100%{opacity:.6;text-shadow:0 0 30px var(--bloom)}50%{opacity:1;text-shadow:0 0 60px var(--bloom-glow)}}
#loading-overlay .sub{font-family:var(--font-hand);font-size:clamp(1rem,2.8vw,1.3rem);color:var(--bloom-pale);margin-top:10px;opacity:.4}
.boot-text{color:var(--bloom-light);font-family:var(--font-crt);font-size:clamp(12px,2vw,14px);margin-top:36px;text-align:left;width:min(340px,84vw);line-height:2.2;min-height:160px;white-space:pre-wrap}
.boot-cursor{display:inline-block;width:8px;height:1.1em;background:var(--bloom-light);vertical-align:text-bottom;margin-left:2px;animation:blink .8s step-end infinite}
@keyframes blink{50%{opacity:0}}

/* â•â•â• HEADER â•â•â• */
.header{position:fixed;top:0;left:0;right:0;z-index:50;display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:linear-gradient(180deg,rgba(0,0,0,.92),transparent);pointer-events:none}
.header>*{pointer-events:auto}
.back-btn{color:var(--dim);text-decoration:none;font-family:var(--font-crt);font-size:.85rem;transition:all .5s;padding:5px 9px;border-radius:5px}
.back-btn:hover{color:var(--bloom-glow);text-shadow:0 0 18px var(--bloom);background:rgba(90,24,48,.15)}
.tape-label{background:linear-gradient(180deg,#f5efe5,#d8d0c0);color:#1a1510;padding:4px 12px;font-family:var(--font-crt);font-size:.6rem;text-transform:uppercase;letter-spacing:2px;border:1px solid #888;box-shadow:0 4px 12px rgba(0,0,0,.5)}

/* â•â•â• CONTROLS â•â•â• */
.control-buttons{position:fixed;top:10px;right:10px;z-index:200;display:flex;gap:5px}
.ctrl-btn{background:rgba(0,0,0,.75);border:1px solid #2a2520;border-radius:5px;color:var(--dim);font-family:var(--font-crt);font-size:11px;padding:4px 10px;cursor:pointer;transition:all .4s;min-height:30px;backdrop-filter:blur(4px)}
.ctrl-btn:hover,.ctrl-btn.on{color:var(--bloom-glow);border-color:var(--bloom);box-shadow:0 0 10px rgba(216,80,128,.2)}
.ctrl-btn.music-on{color:var(--pink-soft);border-color:var(--pink);animation:musicP 2s ease-in-out infinite}
@keyframes musicP{0%,100%{box-shadow:0 0 6px rgba(216,120,149,.12)}50%{box-shadow:0 0 14px rgba(216,120,149,.25)}}

/* â•â•â• MAIN CONTAINER â•â•â• */
.main-container{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:70px 16px 20px;z-index:10;opacity:0;transition:opacity 2s}
.main-container.show{opacity:1}

.scene-container{max-width:600px;width:100%;text-align:center;padding:20px;position:relative}

.scene-title{font-family:var(--font-display);font-size:clamp(1.5rem,5vw,2.2rem);color:var(--bloom-glow);letter-spacing:4px;margin-bottom:20px;opacity:0;transform:translateY(30px) scale(.95);transition:all 1.8s var(--ease);filter:blur(8px)}
.scene-title.show{opacity:1;transform:translateY(0) scale(1);filter:blur(0)}
.scene-text{font-family:var(--font-serif);font-size:clamp(1rem,2.8vw,1.3rem);line-height:2.4;color:var(--white);margin-bottom:24px;opacity:0;transform:translateY(20px);transition:all 1.4s var(--ease) .2s;filter:blur(4px)}
.scene-text.show{opacity:1;transform:translateY(0);filter:blur(0)}
.scene-text .her{color:var(--pink-soft);text-shadow:0 0 30px rgba(216,120,149,.4)}
.scene-text .me{color:var(--gold-glow);font-style:italic}
.scene-text .memory{color:var(--bloom-pale);font-style:italic;font-size:.9em;opacity:.8}
.scene-text .damage{color:var(--bloom-glow)}
.scene-text .gold{color:var(--gold-glow)}
.scene-text .echo{color:var(--dim);font-style:italic}

.scene-subtitle{font-family:var(--font-hand);font-size:clamp(1rem,2.5vw,1.3rem);color:var(--bloom-pale);margin-bottom:30px;opacity:.7}

/* â•â•â• LETTER â•â•â• */
.letter-container{max-width:480px;margin:0 auto;background:linear-gradient(145deg,rgba(30,15,20,.8),rgba(10,5,8,.9));border:1px solid var(--bloom-deep);border-radius:3px;padding:30px 35px;position:relative;opacity:0;transform:translateY(30px) rotate(-0.5deg);transition:all 1.5s var(--ease);box-shadow:0 20px 60px rgba(0,0,0,.5),inset 0 0 40px rgba(216,80,128,.03)}
.letter-container.show{opacity:1;transform:translateY(0) rotate(0)}
.letter-container::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,var(--bloom-light),transparent)}
.letter-text{font-family:var(--font-hand);font-size:clamp(1.1rem,3vw,1.4rem);color:var(--bloom-pale);line-height:2.2;text-align:left}
.letter-signature{font-family:var(--font-hand);font-size:1rem;color:var(--dim);text-align:right;margin-top:20px;font-style:italic}

/* â•â•â• MINJI DISPLAY â•â•â• */
.minji-container{position:relative;margin:30px auto;opacity:0;transform:scale(.85);transition:all 2s var(--ease);filter:blur(10px)}
.minji-container.show{opacity:1;transform:scale(1);filter:blur(0)}
.minji-avatar{width:clamp(120px,30vw,180px);height:clamp(120px,30vw,180px);border-radius:50%;margin:0 auto;display:flex;align-items:center;justify-content:center;position:relative;overflow:visible}
.minji-avatar svg{width:100%;height:100%}
.minji-ring{position:absolute;inset:-8px;border-radius:50%;border:2px solid var(--bloom-glow);opacity:.3;animation:ringPulse 3s ease-in-out infinite}
.minji-ring:nth-child(2){inset:-16px;border-color:var(--bloom-light);opacity:.15;animation-delay:1s;animation-duration:4s}
@keyframes ringPulse{0%,100%{opacity:.15;transform:scale(1)}50%{opacity:.35;transform:scale(1.03)}}
.minji-name{font-family:var(--font-display);font-size:clamp(1rem,3vw,1.4rem);color:var(--bloom-pale);margin-top:16px;letter-spacing:3px}
.minji-status{font-family:var(--font-hand);font-size:clamp(.8rem,2vw,1rem);color:var(--dim);margin-top:4px}
.minji-status .dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--trust);margin-right:6px;animation:dotPulse 2s ease-in-out infinite}
@keyframes dotPulse{0%,100%{opacity:.5;box-shadow:0 0 4px rgba(74,128,64,.3)}50%{opacity:1;box-shadow:0 0 10px rgba(74,128,64,.6)}}

/* Voice indicator */
.voice-indicator{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;background:rgba(90,24,48,.3);border:1px solid var(--bloom);border-radius:20px;margin-top:16px;opacity:0;transition:all .5s}
.voice-indicator.show{opacity:1}
.voice-waves{display:flex;gap:2px;align-items:center}
.voice-wave{width:3px;background:var(--bloom-glow);border-radius:2px}
.voice-wave:nth-child(1){height:8px;animation:wave .45s ease-in-out infinite}
.voice-wave:nth-child(2){height:14px;animation:wave .35s ease-in-out infinite .08s}
.voice-wave:nth-child(3){height:10px;animation:wave .5s ease-in-out infinite .16s}
.voice-wave:nth-child(4){height:16px;animation:wave .3s ease-in-out infinite .05s}
.voice-wave:nth-child(5){height:6px;animation:wave .55s ease-in-out infinite .12s}
.voice-wave:nth-child(6){height:12px;animation:wave .4s ease-in-out infinite .2s}
@keyframes wave{0%,100%{transform:scaleY(1)}50%{transform:scaleY(.3)}}
.voice-text{font-family:var(--font-crt);font-size:.8rem;color:var(--bloom-pale);letter-spacing:1px}

/* â•â•â• MINI GAME â•â•â• */
.minigame-container{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.97);display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 1.5s}
.minigame-container.active{opacity:1;pointer-events:auto}
.minigame-title{font-family:var(--font-display);font-size:clamp(1.2rem,4vw,1.6rem);color:var(--gold-glow);letter-spacing:4px;margin-bottom:20px}
.minigame-area{width:clamp(280px,70vw,400px);height:clamp(280px,70vw,400px);border:3px solid var(--bloom);border-radius:50%;position:relative;background:radial-gradient(circle,rgba(90,24,48,.15),rgba(5,5,5,.95));overflow:hidden}
.minigame-area::before{content:'';position:absolute;inset:0;border-radius:50%;background:conic-gradient(from 0deg,transparent,rgba(216,80,128,.05),transparent,rgba(216,80,128,.03),transparent);animation:areaSpin 12s linear infinite}
@keyframes areaSpin{to{transform:rotate(360deg)}}
.minigame-target{position:absolute;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .2s;opacity:0;transform:scale(0)}
.minigame-target.show{opacity:1;transform:scale(1);animation:targetAppear .4s var(--ease-b)}
@keyframes targetAppear{from{transform:scale(0) rotate(-20deg)}to{transform:scale(1) rotate(0)}}
.minigame-target:hover{transform:scale(1.15)}
.minigame-target:active{transform:scale(.9)}
.minigame-instruction{font-family:var(--font-hand);font-size:1.1rem;color:var(--bloom-pale);margin-top:20px;text-align:center}
.minigame-progress{display:flex;gap:6px;margin-top:16px}
.minigame-dot{width:12px;height:12px;border-radius:50%;background:var(--bloom-deep);border:1px solid var(--bloom);transition:all .4s var(--ease-b)}
.minigame-dot.filled{background:var(--bloom-glow);box-shadow:0 0 12px var(--bloom-glow);transform:scale(1.2)}
.minigame-dot.missed{background:transparent;border-color:var(--dim);opacity:.4}
.minigame-combo{font-family:var(--font-crt);font-size:.9rem;color:var(--gold-glow);margin-top:10px;opacity:0;transition:all .3s}
.minigame-combo.show{opacity:1}

/* â•â•â• STATS â•â•â• */
.stats-container{max-width:420px;margin:30px auto;padding:24px;background:linear-gradient(145deg,rgba(42,10,21,.5),rgba(10,5,8,.7));border:1px solid var(--bloom-deep);border-radius:12px;opacity:0;transform:translateY(30px);transition:all 1.2s var(--ease);backdrop-filter:blur(4px)}
.stats-container.show{opacity:1;transform:translateY(0)}
.stats-title{font-family:var(--font-crt);font-size:.9rem;color:var(--bloom-pale);letter-spacing:2px;margin-bottom:16px;text-align:center}
.stat-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(90,24,48,.2);font-family:var(--font-crt);font-size:.85rem;opacity:0;transform:translateX(-10px);transition:all .6s var(--ease)}
.stat-row.show{opacity:1;transform:translateX(0)}
.stat-label{color:var(--dim)}
.stat-value{color:var(--white);transition:color .5s}
.stat-value.good{color:var(--trust)}
.stat-value.warn{color:var(--gold-glow)}
.stat-value.bad{color:var(--bloom-glow)}

/* â•â•â• VALENTINE â•â•â• */
.valentine-container{max-width:500px;margin:30px auto;opacity:0;transform:scale(.9);transition:all 2s var(--ease);filter:blur(6px)}
.valentine-container.show{opacity:1;transform:scale(1);filter:blur(0)}
.valentine-question{font-family:var(--font-hand);font-size:clamp(1.3rem,4vw,1.8rem);color:var(--pink-soft);text-align:center;line-height:2;margin-bottom:30px}
.valentine-heart{text-align:center;margin-bottom:20px}
.valentine-options{display:flex;flex-direction:column;gap:16px;max-width:350px;margin:0 auto}
.valentine-btn{padding:18px 24px;background:linear-gradient(145deg,rgba(90,24,48,.5),rgba(40,10,20,.7));border:2px solid var(--bloom-light);border-radius:12px;color:var(--white);font-family:var(--font-serif);font-size:1.1rem;cursor:pointer;transition:all .5s var(--ease);position:relative;overflow:hidden}
.valentine-btn::after{content:'';position:absolute;inset:0;background:radial-gradient(circle at var(--mx,50%) var(--my,50%),rgba(216,80,128,.15),transparent 60%);opacity:0;transition:opacity .3s}
.valentine-btn:hover::after{opacity:1}
.valentine-btn:hover{border-color:var(--bloom-glow);box-shadow:0 0 30px rgba(216,80,128,.2);transform:translateY(-3px)}
.valentine-btn.yes{border-color:var(--trust)}
.valentine-btn.yes:hover{border-color:#80c080;box-shadow:0 0 30px rgba(74,128,64,.3)}
.valentine-btn .preview{display:block;font-size:.75rem;color:var(--dim);margin-top:6px;font-family:var(--font-hand)}
.valentine-btn.selected{border-color:var(--gold-glow);background:linear-gradient(145deg,rgba(144,112,48,.3),rgba(90,70,30,.15));pointer-events:none}

/* â•â•â• ENDING â•â•â• */
.ending-container{position:fixed;inset:0;z-index:400;background:var(--bg-deep);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px;opacity:0;pointer-events:none;transition:opacity 4s}
.ending-container.show{opacity:1;pointer-events:auto}
.ending-icon{margin-bottom:24px}
.ending-title{font-family:var(--font-display);font-size:clamp(1.4rem,5vw,2rem);letter-spacing:4px;margin-bottom:16px;text-align:center;opacity:0;transform:translateY(20px);transition:all 2s var(--ease) 1s}
.ending-container.show .ending-title{opacity:1;transform:translateY(0)}
.ending-body{font-family:var(--font-serif);font-size:clamp(1rem,3vw,1.2rem);color:var(--bloom-pale);line-height:2.4;text-align:center;max-width:500px;margin-bottom:30px;opacity:0;transition:opacity 2s ease 2s}
.ending-container.show .ending-body{opacity:1}
.ending-song{font-family:var(--font-hand);font-size:1.1rem;color:var(--pink-soft);margin-top:20px;opacity:0;transition:opacity 2s ease 3s}
.ending-container.show .ending-song{opacity:.8}
.ending-nav{margin-top:30px;display:flex;gap:16px;flex-wrap:wrap;justify-content:center;opacity:0;transition:opacity 2s ease 4s}
.ending-container.show .ending-nav{opacity:1}
.ending-nav a{color:var(--dim);font-family:var(--font-crt);text-decoration:none;border:1px solid #2a2520;padding:10px 20px;border-radius:6px;transition:all .4s;font-size:.85rem}
.ending-nav a:hover{color:var(--bloom-glow);border-color:var(--bloom)}

.tape5-locked{margin-top:40px;text-align:center;opacity:0;transition:opacity 2s ease 5s}
.ending-container.show .tape5-locked{opacity:1}
.tape5-icon{width:60px;height:60px;border-radius:8px;background:rgba(30,30,30,.8);border:1px solid #333;display:flex;align-items:center;justify-content:center;margin:0 auto;filter:grayscale(1) brightness(.4)}
.tape5-label{font-family:var(--font-crt);font-size:.7rem;color:#444;letter-spacing:2px;margin-top:8px}
.tape5-hint{font-family:var(--font-hand);font-size:.8rem;color:#333;margin-top:4px}

/* â•â•â• SHEEPY â•â•â• */
#sheepy{position:fixed;top:65px;left:14px;z-index:40;display:flex;flex-direction:column;align-items:center;gap:6px;opacity:0;transform:translateX(-20px);transition:all .8s var(--ease)}
#sheepy.show{opacity:1;transform:translateX(0)}
#sheepy.hide{opacity:0;transform:translateX(-20px)}
.sheepy-sprite{width:clamp(46px,11vw,64px);height:clamp(46px,11vw,64px)}
.sheepy-text{font-family:var(--font-hand);font-size:clamp(.7rem,1.7vw,.9rem);color:#c9a080;text-align:center;max-width:110px;line-height:1.4}

/* â•â•â• RESPONSIVE â•â•â• */
@media(max-width:500px){
.header{padding:8px 12px}
.main-container{padding:60px 16px 16px}
.scene-container{padding:16px}
#sheepy{top:55px;left:8px}
.letter-container{padding:20px 24px}
}
</style>
</head>
<body>

<!-- Flash Overlay -->
<div id="flash-overlay"></div>
<div id="vignette"></div>

<!-- Particle Canvas -->
<canvas id="particle-canvas"></canvas>

<!-- Loading Overlay -->
<div id="loading-overlay">
  <svg class="bloom-loading" viewBox="0 0 100 100">
    <defs>
      <radialGradient id="bloomGrad" cx="50%" cy="50%">
        <stop offset="0%" stop-color="#d85080"/>
        <stop offset="50%" stop-color="#8a2850"/>
        <stop offset="100%" stop-color="#5a1830"/>
      </radialGradient>
      <filter id="bloomGlow"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
    </defs>
    <path d="M50 5 L60 35 L90 40 L65 60 L75 95 L50 75 L25 95 L35 60 L10 40 L40 35 Z" fill="url(#bloomGrad)" filter="url(#bloomGlow)">
      <animate attributeName="opacity" values="0.7;1;0.7" dur="2s" repeatCount="indefinite"/>
    </path>
    <circle cx="50" cy="50" r="12" fill="#2a0a15" stroke="#d85080" stroke-width="2"/>
  </svg>
  <h1>SIDE D: BLOOM</h1>
  <div class="sub">what the seeds became</div>
  <div class="boot-text" id="boot-text"></div>
</div>

<!-- Main CRT Screen -->
<div class="crt-screen" id="crt-screen">
  <div class="scan-bar"></div>
  <div id="noise-layer"></div>

  <div class="header">
    <a href="index.html" class="back-btn">â—€ EJECT</a>
    <div class="tape-label">SIDE D: BLOOM</div>
  </div>

  <div class="control-buttons">
    <button class="ctrl-btn" id="audio-btn">â™ª SFX OFF</button>
    <button class="ctrl-btn" id="music-btn">â™« MUSIC OFF</button>
    <button class="ctrl-btn" id="voice-btn">ğŸ”Š VOICE OFF</button>
  </div>

  <audio id="bgm" loop preload="auto"><source src="Wgft BURNER BOY.mp3" type="audio/mpeg"></audio>

  <div id="sheepy">
    <div class="sheepy-sprite" id="sheepy-sprite"></div>
    <div class="sheepy-text" id="sheepy-text"></div>
  </div>

  <div class="main-container" id="main-container">
    <div class="scene-container" id="scene-container"></div>
  </div>

  <!-- Mini Game -->
  <div class="minigame-container" id="minigame-container">
    <div class="minigame-title">CATCH THE MOMENTS</div>
    <div class="minigame-area" id="minigame-area"></div>
    <div class="minigame-instruction" id="minigame-instruction">Tap the memories as they appear</div>
    <div class="minigame-combo" id="minigame-combo">Ã—1</div>
    <div class="minigame-progress" id="minigame-progress"></div>
  </div>

  <!-- Ending -->
  <div class="ending-container" id="ending-container">
    <div class="ending-icon" id="ending-icon"></div>
    <div class="ending-title" id="ending-title"></div>
    <div class="ending-body" id="ending-body"></div>
    <div class="ending-song" id="ending-song"></div>
    <div class="ending-nav" id="ending-nav"></div>
    <div class="tape5-locked" id="tape5-locked">
      <div class="tape5-icon">
        <svg width="32" height="32" viewBox="0 0 32 32"><rect x="4" y="8" width="24" height="16" rx="2" fill="#222"/><rect x="8" y="12" width="16" height="8" rx="1" fill="#111"/><circle cx="12" cy="16" r="2" fill="#333"/><circle cx="20" cy="16" r="2" fill="#333"/></svg>
      </div>
      <div class="tape5-label">SIDE E: ???</div>
      <div class="tape5-hint">the future holds more</div>
    </div>
  </div>
</div>

<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILITIES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const $ = id => document.getElementById(id);
const sleep = ms => new Promise(r => setTimeout(r, ms));
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
const pick = arr => arr[Math.floor(Math.random() * arr.length)];
const rand = (min, max) => min + Math.random() * (max - min);
const lerp = (a, b, t) => a + (b - a) * t;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE - Deep integration with tape1 + tape2 + tape3
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const State = {
  trust: 0, guard: 0, sync: 0, soil: 'barren',
  flags: new Set(),
  ending: null,
  turns: 0, damageDealt: 0, damageTaken: 0, grazes: 0,
  maxStreak: 0, phases: [], determinationUsed: false,
  fightCount: 0,
  moments: [], valentineAnswer: null,
  
  load() {
    try {
      const saved = JSON.parse(localStorage.getItem('seed_archive_v3') || '{}');
      if (saved.tape1) {
        this.trust = saved.tape1.trust || 0;
        this.guard = saved.tape1.guard || 0;
        this.soil = saved.tape1.soil || 'barren';
        if (saved.tape1.flags) saved.tape1.flags.forEach(f => this.flags.add(f));
      }
      if (saved.tape2) {
        this.sync = saved.tape2.sync || 0;
        this.trust = Math.max(this.trust, saved.tape2.trust || 0);
        this.guard = Math.max(this.guard, saved.tape2.guard || 0);
        if (saved.tape2.flags) saved.tape2.flags.forEach(f => this.flags.add(f));
      }
      if (saved.tape3) {
        this.ending = saved.tape3.ending || 'defeat';
        this.turns = saved.tape3.turns || 0;
        this.damageDealt = saved.tape3.damageDealt || 0;
        this.damageTaken = saved.tape3.damageTaken || 0;
        this.grazes = saved.tape3.grazes || 0;
        this.maxStreak = saved.tape3.maxStreak || 0;
        this.phases = saved.tape3.phases || [];
        this.determinationUsed = saved.tape3.determinationUsed || false;
        this.fightCount = saved.tape3.fightCount || 0;
        if (saved.tape3.flags) saved.tape3.flags.forEach(f => this.flags.add(f));
      }
      // Set ending flags for callbacks
      if (this.ending === 'mercy') this.flags.add('e_mercy_ending');
      if (this.ending === 'fight') this.flags.add('e_fight_ending');
    } catch(e) { console.log('No previous state found'); }
  },
  
  has(id) { return this.flags.has(id); },
  
  save() {
    try {
      const s = JSON.parse(localStorage.getItem('seed_archive_v3') || '{}');
      s.tape4 = {
        complete: true,
        ending: this.valentineAnswer || this.ending,
        moments: this.moments,
        trust: this.trust, guard: this.guard, sync: this.sync,
        flags: [...this.flags]
      };
      localStorage.setItem('seed_archive_v3', JSON.stringify(s));
    } catch(e) {}
  },
  
  getRelationshipScore() {
    let score = 0;
    score += this.trust * 0.4;
    score -= this.guard * 0.3;
    score += this.sync * 0.3;
    if (this.ending === 'mercy') score += 20;
    if (this.ending === 'fight') score -= 10;
    if (this.ending === 'defeat') score -= 30;
    if (this.has('e_voice_shared')) score += 5;
    if (this.has('e_sunrise_together')) score += 5;
    if (this.has('e_physical_contact')) score += 5;
    if (this.has('e_door_closed')) score -= 5;
    if (this.has('e_pushed_away')) score -= 5;
    return clamp(Math.round(score), 0, 100);
  }
};

State.load();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIO ENGINE - Gemini's architecture with Claude's reliability
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Audio = {
  ctx: null, master: null, sfx: null, music: null, comp: null,
  musicSource: null, on: false,
  
  init() {
    if (this.ctx) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    this.ctx = new AC();
    
    this.master = this.ctx.createGain();
    this.sfx = this.ctx.createGain();
    this.music = this.ctx.createGain();
    
    // Compressor for "glue"
    this.comp = this.ctx.createDynamicsCompressor();
    this.comp.threshold.value = -24;
    this.comp.knee.value = 18;
    this.comp.ratio.value = 8;
    this.comp.attack.value = 0.004;
    this.comp.release.value = 0.18;
    
    this.sfx.gain.value = 0.9;
    this.music.gain.value = 0.35;
    this.master.gain.value = 0;
    
    this.sfx.connect(this.master);
    this.music.connect(this.master);
    this.master.connect(this.comp);
    this.comp.connect(this.ctx.destination);
  },
  
  resume() {
    if (this.ctx?.state === 'suspended') this.ctx.resume();
  },
  
  setMaster(v, t = 0.25) {
    if (!this.master) return;
    const n = this.ctx.currentTime;
    this.master.gain.cancelScheduledValues(n);
    this.master.gain.setValueAtTime(this.master.gain.value, n);
    this.master.gain.linearRampToValueAtTime(v, n + t);
  },
  
  attachMusicElement(el) {
    if (this.musicSource) return;
    this.musicSource = this.ctx.createMediaElementSource(el);
    this.musicSource.connect(this.music);
  },
  
  _note(freq, dur, type = 'sine', vol = 0.05, delay = 0) {
    if (!this.ctx || !this.on) return;
    const t = this.ctx.currentTime + delay;
    const o = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    const f = this.ctx.createBiquadFilter();
    
    o.type = type;
    o.frequency.value = freq;
    f.type = 'lowpass';
    f.frequency.value = 2000;
    f.Q.value = 1;
    
    g.gain.setValueAtTime(0, t);
    g.gain.linearRampToValueAtTime(vol, t + 0.02);
    g.gain.exponentialRampToValueAtTime(0.001, t + dur);
    
    o.connect(f);
    f.connect(g);
    g.connect(this.sfx);
    
    o.start(t);
    o.stop(t + dur + 0.05);
  },
  
  bloom() {
    [261.6, 329.6, 392, 523.3].forEach((f, i) => {
      this._note(f, 0.9, 'sine', 0.035, i * 0.12);
      this._note(f * 2, 0.6, 'triangle', 0.015, i * 0.12 + 0.05);
    });
  },
  
  heart() {
    // Heartbeat thump
    this._note(60, 0.3, 'sine', 0.08);
    this._note(60, 0.25, 'sine', 0.06, 0.18);
    // Shimmer
    [440, 554, 659, 880].forEach((f, i) => {
      this._note(f, 1.2, 'sine', 0.025, 0.4 + i * 0.15);
    });
  },
  
  memory() {
    const notes = [523.3, 659.3, 784];
    notes.forEach((f, i) => {
      this._note(f, 0.5, 'sine', 0.03, i * 0.08);
      this._note(f * 0.5, 0.8, 'triangle', 0.015, i * 0.08);
    });
  },
  
  sadness() {
    const notes = [440, 415.3, 349.2, 329.6, 293.7];
    notes.forEach((f, i) => {
      this._note(f, 0.8, 'sine', 0.035, i * 0.25);
      this._note(f * 0.5, 1, 'triangle', 0.02, i * 0.25 + 0.05);
    });
  },
  
  hope() {
    const notes = [261.6, 329.6, 392, 523.3, 659.3];
    notes.forEach((f, i) => {
      this._note(f, 1, 'sine', 0.03, i * 0.15);
      this._note(f * 1.5, 0.6, 'sine', 0.015, i * 0.15 + 0.08);
      this._note(f * 2, 0.4, 'triangle', 0.01, i * 0.15 + 0.12);
    });
  },
  
  catch() {
    this._note(800, 0.08, 'sine', 0.05);
    this._note(1200, 0.06, 'sine', 0.04, 0.03);
    this._note(1600, 0.1, 'triangle', 0.03, 0.06);
  },
  
  miss() {
    this._note(200, 0.3, 'sine', 0.04);
    this._note(150, 0.4, 'triangle', 0.03, 0.1);
  },
  
  click() { this._note(350, 0.06, 'sine', 0.05); },
  select() { this._note(300, 0.15, 'sine', 0.05); this._note(450, 0.12, 'sine', 0.04, 0.06); },
  
  ensure() {
    this.init();
    this.resume();
    if (!this.on) {
      this.on = true;
      this.setMaster(0.6, 1.2);
      $('audio-btn').textContent = 'â™ª SFX ON';
      $('audio-btn').classList.add('on');
      this.attachMusicElement($('bgm'));
    }
  },
  
  toggle() {
    this.init();
    this.resume();
    this.on = !this.on;
    if (this.on) {
      this.setMaster(0.6, 1);
      $('audio-btn').textContent = 'â™ª SFX ON';
      $('audio-btn').classList.add('on');
    } else {
      this.setMaster(0, 0.6);
      $('audio-btn').textContent = 'â™ª SFX OFF';
      $('audio-btn').classList.remove('on');
    }
  }
};

const Music = {
  el: $('bgm'),
  playing: false,
  
  toggle() {
    if (this.playing) {
      this.el.pause();
      this.playing = false;
      $('music-btn').textContent = 'â™« MUSIC OFF';
      $('music-btn').classList.remove('music-on');
    } else {
      this.el.volume = 0.18;
      const p = this.el.play();
      if (p) p.then(() => {
        this.playing = true;
        $('music-btn').textContent = 'â™« BURNER â–¸';
        $('music-btn').classList.add('music-on');
      }).catch(() => {});
    }
  },
  
  fadeOut(dur = 3) {
    if (!this.playing) return;
    const start = this.el.volume;
    const steps = 60;
    const step = start / steps;
    let i = 0;
    const iv = setInterval(() => {
      i++;
      this.el.volume = Math.max(0, start - step * i);
      if (i >= steps) {
        clearInterval(iv);
        this.el.pause();
        this.playing = false;
        $('music-btn').textContent = 'â™« MUSIC OFF';
        $('music-btn').classList.remove('music-on');
      }
    }, dur * 1000 / steps);
  }
};

 $('audio-btn').onclick = () => Audio.toggle();
 $('music-btn').onclick = () => Music.toggle();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TTS ENGINE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Voice = {
  synth: window.speechSynthesis,
  voice: null,
  enabled: false,
  speaking: false,
  
  init() {
    if (!('speechSynthesis' in window)) return false;
    const voices = this.synth.getVoices();
    // Score voices
    this.voice = voices.find(v => v.name.includes('Samantha')) ||
                 voices.find(v => v.name.includes('Karen')) ||
                 voices.find(v => v.name.includes('Moira')) ||
                 voices.find(v => /female/i.test(v.name) && v.lang.includes('en')) ||
                 voices.find(v => v.lang.includes('en-US')) ||
                 voices[0];
    return !!this.voice;
  },
  
  speak(text, rate = 0.82, pitch = 1.15) {
    if (!this.enabled || !this.synth || !this.voice) return Promise.resolve();
    return new Promise(resolve => {
      this.synth.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.voice = this.voice;
      u.rate = rate;
      u.pitch = pitch;
      u.volume = 0.75;
      this.speaking = true;
      showVoiceIndicator(true);
      u.onend = () => {
        this.speaking = false;
        showVoiceIndicator(false);
        resolve();
      };
      u.onerror = () => {
        this.speaking = false;
        showVoiceIndicator(false);
        resolve();
      };
      this.synth.speak(u);
    });
  },
  
  stop() {
    if (this.synth) this.synth.cancel();
    this.speaking = false;
    showVoiceIndicator(false);
  },
  
  toggle() {
    this.enabled = !this.enabled;
    $('voice-btn').textContent = this.enabled ? 'ğŸ”Š VOICE ON' : 'ğŸ”Š VOICE OFF';
    $('voice-btn').classList.toggle('on', this.enabled);
  }
};

if ('speechSynthesis' in window) {
  speechSynthesis.onvoiceschanged = () => Voice.init();
  setTimeout(() => Voice.init(), 200);
}
 $('voice-btn').onclick = () => Voice.toggle();

function showVoiceIndicator(show) {
  const ind = document.querySelector('.voice-indicator');
  if (ind) ind.classList.toggle('show', show);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CANVAS PARTICLE SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Particles = {
  canvas: null, ctx: null, w: 0, h: 0,
  list: [], raf: null, active: false,
  
  init() {
    this.canvas = $('particle-canvas');
    this.ctx = this.canvas.getContext('2d');
    this.resize();
    window.addEventListener('resize', () => this.resize());
  },
  
  resize() {
    this.w = this.canvas.width = window.innerWidth;
    this.h = this.canvas.height = window.innerHeight;
  },
  
  spawn(x, y, count = 8, color = '#d85080') {
    for (let i = 0; i < count; i++) {
      this.list.push({
        x, y,
        vx: rand(-3, 3),
        vy: rand(-3, 3),
        size: rand(2, 6),
        life: 1,
        color,
        decay: rand(0.015, 0.03)
      });
    }
    if (!this.active) {
      this.active = true;
      this.loop();
    }
  },
  
  petal(count = 15) {
    for (let i = 0; i < count; i++) {
      this.list.push({
        x: rand(0, this.w),
        y: -20,
        vx: rand(-0.5, 0.5),
        vy: rand(1, 3),
        size: rand(6, 14),
        life: 1,
        decay: 0.003,
        color: `hsla(${rand(330, 360)}, 60%, 70%, .6)`,
        petal: true,
        angle: rand(0, Math.PI * 2),
        spin: rand(-0.05, 0.05)
      });
    }
    if (!this.active) {
      this.active = true;
      this.loop();
    }
  },
  
  clear() {
    this.list = [];
  },
  
  stop() {
    this.active = false;
    if (this.raf) cancelAnimationFrame(this.raf);
  },
  
  loop() {
    if (!this.active && this.list.length === 0) return;
    
    const ctx = this.ctx;
    ctx.clearRect(0, 0, this.w, this.h);
    
    for (let i = this.list.length - 1; i >= 0; i--) {
      const p = this.list[i];
      
      p.x += p.vx + (p.petal ? Math.sin(Date.now() / 1000 + p.y / 100) * 0.5 : 0);
      p.y += p.vy;
      
      if (p.petal) {
        p.angle += p.spin;
      }
      
      p.life -= p.decay;
      
      if (p.life <= 0 || p.y > this.h + 20) {
        this.list.splice(i, 1);
        continue;
      }
      
      ctx.save();
      ctx.globalAlpha = p.life;
      ctx.fillStyle = p.color;
      
      if (p.petal) {
        ctx.translate(p.x, p.y);
        ctx.rotate(p.angle);
        ctx.beginPath();
        ctx.ellipse(0, 0, p.size, p.size * 1.5, 0, 0, Math.PI * 2);
        ctx.fill();
      } else {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
        ctx.fill();
      }
      
      ctx.restore();
    }
    
    this.raf = requestAnimationFrame(() => this.loop());
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VFX
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const VFX = {
  flash(color = 'rgba(216,80,128,.2)', dur = 150) {
    const el = $('flash-overlay');
    el.style.background = color;
    el.classList.add('active');
    setTimeout(() => el.classList.remove('active'), dur);
  },
  
  vignette(on = true) {
    $('vignette').classList.toggle('active', on);
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHEEPY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Sheepy = {
  moods: {
    nervous: 'M-6 6 Q-4 3 0 5 Q4 7 6 5',
    peaceful: 'M-6 6 Q0 10 6 6',
    sad: 'M-7 8 Q0 2 7 8',
    hopeful: 'M-6 5 Q0 9 6 5',
    determined: 'M-7 4 Q-3 8 0 6 Q3 8 7 4',
    grieving: 'M-6 9 Q0 2 6 9',
    proud: 'M-6 3 Q0 12 6 3',
    love: 'M-6 4 Q-3 10 0 8 Q3 10 6 4'
  },
  
  svg(mood, size = 64) {
    const m = this.moods[mood] || this.moods.nervous;
    const faceColor = mood === 'love' ? '#ffe0e8' : mood === 'proud' ? '#f0e8e0' : '#ffeef2';
    return `<svg width="${size}" height="${size}" viewBox="0 0 120 120">
      <ellipse cx="60" cy="78" rx="38" ry="30" fill="#e4dcd0"/>
      <ellipse cx="36" cy="70" rx="14" ry="12" fill="#faf8f5"/>
      <ellipse cx="84" cy="70" rx="14" ry="12" fill="#faf8f5"/>
      <ellipse cx="60" cy="32" rx="22" ry="18" fill="${faceColor}"/>
      <ellipse cx="30" cy="22" rx="8" ry="6" fill="#c8a0a0" transform="rotate(-20 30 22)"/>
      <ellipse cx="90" cy="22" rx="8" ry="6" fill="#c8a0a0" transform="rotate(20 90 22)"/>
      <ellipse cx="48" cy="30" rx="5" ry="6" fill="#1a1a1a"><animate attributeName="ry" values="6;6;1;6;6" keyTimes="0;.4;.5;.6;1" dur="4s" repeatCount="indefinite"/></ellipse>
      <ellipse cx="72" cy="30" rx="5" ry="6" fill="#1a1a1a"><animate attributeName="ry" values="6;6;1;6;6" keyTimes="0;.4;.5;.6;1" dur="4s" repeatCount="indefinite"/></ellipse>
      <circle cx="49" cy="28" r="2" fill="#fff"/>
      <circle cx="73" cy="28" r="2" fill="#fff"/>
      <ellipse cx="60" cy="44" rx="4" ry="3" fill="#b8a098"/>
      <g transform="translate(60 52)"><path d="${m}" stroke="#a89088" stroke-width="2.5" fill="none" stroke-linecap="round"/></g>
      ${mood === 'love' ? '<text x="78" y="24" font-size="16" fill="#ff5080" opacity=".8">â™¡</text>' : ''}
    </svg>`;
  },
  
  show(mood) {
    $('sheepy-sprite').innerHTML = this.svg(mood);
    $('sheepy').classList.add('show');
    $('sheepy').classList.remove('hide');
  },
  
  hide() {
    $('sheepy').classList.add('hide');
    setTimeout(() => $('sheepy').classList.remove('show'), 500);
  },
  
  text(t) {
    $('sheepy-text').textContent = t;
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SVG GENERATORS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SVG = {
  heartbeat(width = 400, height = 60, color = '#d85080', speed = 1.5) {
    const midY = height / 2;
    const w = width;
    const path = `M0,${midY} L${w*.15},${midY} L${w*.2},${midY-5} L${w*.25},${midY} L${w*.35},${midY} L${w*.38},${midY-20} L${w*.42},${midY+15} L${w*.45},${midY-25} L${w*.48},${midY+10} L${w*.52},${midY} L${w*.65},${midY} L${w*.7},${midY-5} L${w*.75},${midY} L${w},${midY}`;
    const totalLength = w * 2;

    return `<svg viewBox="0 0 ${w} ${height}" width="100%" height="${height}" style="overflow:visible">
      <defs>
        <filter id="hbGlow"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        <linearGradient id="hbGrad" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="${color}" stop-opacity=".2"/>
          <stop offset="50%" stop-color="${color}" stop-opacity="1"/>
          <stop offset="100%" stop-color="${color}" stop-opacity=".2"/>
        </linearGradient>
      </defs>
      <path d="${path}" stroke="rgba(90,24,48,.3)" stroke-width="1" fill="none"/>
      <path d="${path}" stroke="url(#hbGrad)" stroke-width="2" fill="none" filter="url(#hbGlow)"
        stroke-dasharray="${totalLength}" stroke-dashoffset="${totalLength}">
        <animate attributeName="stroke-dashoffset" from="${totalLength}" to="${-totalLength}" dur="${speed}s" repeatCount="indefinite"/>
      </path>
      <circle r="3" fill="${color}" filter="url(#hbGlow)">
        <animateMotion dur="${speed}s" repeatCount="indefinite" path="${path}"/>
      </circle>
    </svg>`;
  },
  
  valentineHeart(size = 80) {
    return `<svg viewBox="0 0 100 100" width="${size}" height="${size}" style="overflow:visible;filter:drop-shadow(0 0 15px rgba(216,80,128,.4))">
      <defs>
        <linearGradient id="heartGrad" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#ff5080"/>
          <stop offset="100%" stop-color="#d85080"/>
        </linearGradient>
        <filter id="heartGlow">
          <feGaussianBlur stdDeviation="3" result="g"/>
          <feMerge><feMergeNode in="g"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>
      <path d="M50,88 C25,65 5,50 5,30 C5,15 18,5 30,5 C40,5 48,12 50,20 C52,12 60,5 70,5 C82,5 95,15 95,30 C95,50 75,65 50,88z"
        fill="url(#heartGrad)" filter="url(#heartGlow)" opacity=".9">
        <animate attributeName="d"
          values="M50,88 C25,65 5,50 5,30 C5,15 18,5 30,5 C40,5 48,12 50,20 C52,12 60,5 70,5 C82,5 95,15 95,30 C95,50 75,65 50,88z;
                  M50,85 C28,65 8,52 8,32 C8,17 20,8 32,8 C42,8 48,14 50,22 C52,14 58,8 68,8 C80,8 92,17 92,32 C92,52 72,65 50,85z;
                  M50,88 C25,65 5,50 5,30 C5,15 18,5 30,5 C40,5 48,12 50,20 C52,12 60,5 70,5 C82,5 95,15 95,30 C95,50 75,65 50,88z"
          dur="1.2s" repeatCount="indefinite"/>
      </path>
      <ellipse cx="35" cy="30" rx="8" ry="6" fill="rgba(255,255,255,.15)" transform="rotate(-20 35 30)">
        <animate attributeName="opacity" values=".15;.25;.15" dur="1.2s" repeatCount="indefinite"/>
      </ellipse>
    </svg>`;
  },
  
  minjiAvatar(mood = 'neutral') {
    const colors = {
      neutral: { bg: '#5a1830', ring: '#d85080', inner: '#8a2850' },
      happy: { bg: '#3a5828', ring: '#80c060', inner: '#5a8840' },
      sad: { bg: '#2a2050', ring: '#8080d0', inner: '#4a3878' },
      love: { bg: '#5a1838', ring: '#ff5080', inner: '#d85080' }
    };
    const c = colors[mood] || colors.neutral;

    return `<svg viewBox="0 0 200 200" width="100%" height="100%">
      <defs>
        <radialGradient id="mjBg" cx="35%" cy="35%">
          <stop offset="0%" stop-color="${c.inner}"/>
          <stop offset="100%" stop-color="${c.bg}"/>
        </radialGradient>
        <filter id="mjGlow">
          <feGaussianBlur stdDeviation="4" result="g"/>
          <feMerge><feMergeNode in="g"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
        <clipPath id="mjClip"><circle cx="100" cy="100" r="85"/></clipPath>
      </defs>

      <circle cx="100" cy="100" r="88" fill="none" stroke="${c.ring}" stroke-width="2" opacity=".4">
        <animate attributeName="r" values="86;90;86" dur="4s" repeatCount="indefinite"/>
        <animate attributeName="opacity" values=".3;.5;.3" dur="4s" repeatCount="indefinite"/>
      </circle>
      <circle cx="100" cy="100" r="85" fill="url(#mjBg)"/>

      <g clip-path="url(#mjClip)" filter="url(#mjGlow)">
        <ellipse cx="100" cy="65" rx="55" ry="50" fill="#1a0810"/>
        <ellipse cx="100" cy="55" rx="48" ry="40" fill="#2a1018"/>
        <ellipse cx="100" cy="100" rx="35" ry="42" fill="#c8a090" opacity=".6"/>
        <ellipse cx="86" cy="92" rx="5" ry="3.5" fill="#1a0a05" opacity=".8">
          <animate attributeName="ry" values="3.5;3.5;.5;3.5;3.5" keyTimes="0;.4;.45;.5;1" dur="5s" repeatCount="indefinite"/>
        </ellipse>
        <ellipse cx="114" cy="92" rx="5" ry="3.5" fill="#1a0a05" opacity=".8">
          <animate attributeName="ry" values="3.5;3.5;.5;3.5;3.5" keyTimes="0;.4;.45;.5;1" dur="5s" repeatCount="indefinite"/>
        </ellipse>
        <circle cx="88" cy="91" r="1.5" fill="rgba(255,255,255,.5)"/>
        <circle cx="116" cy="91" r="1.5" fill="rgba(255,255,255,.5)"/>
        <path d="M92,110 Q100,${mood === 'happy' || mood === 'love' ? '118' : '114'} 108,110"
          stroke="#8a6050" stroke-width="1.5" fill="none" stroke-linecap="round" opacity=".6"/>
        ${mood === 'love' ? '<text x="120" y="80" font-size="16" fill="#ff5080" opacity=".6">â™¡</text>' : ''}
        <circle cx="78" cy="105" r="8" fill="#d87895" opacity=".15"/>
        <circle cx="122" cy="105" r="8" fill="#d87895" opacity=".15"/>
      </g>

      <circle cx="40" cy="50" r="2" fill="${c.ring}" opacity="0">
        <animate attributeName="opacity" values="0;.4;0" dur="5s" repeatCount="indefinite"/>
        <animate attributeName="cy" values="50;40;50" dur="5s" repeatCount="indefinite"/>
      </circle>
      <circle cx="160" cy="60" r="1.5" fill="${c.ring}" opacity="0">
        <animate attributeName="opacity" values="0;.3;0" dur="4s" repeatCount="indefinite" begin="1s"/>
        <animate attributeName="cy" values="60;52;60" dur="4s" repeatCount="indefinite" begin="1s"/>
      </circle>
    </svg>`;
  },
  
  bloomingFlower(size = 100) {
    return `<svg viewBox="0 0 100 120" width="${size}" height="${size * 1.2}" style="filter:drop-shadow(0 0 20px rgba(216,80,128,.3))">
      <defs>
        <linearGradient id="stemBG" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#6a9040"/>
          <stop offset="100%" stop-color="#3a5828"/>
        </linearGradient>
        <radialGradient id="petalG" cx="50%" cy="30%">
          <stop offset="0%" stop-color="#ff80a0"/>
          <stop offset="100%" stop-color="#d85080"/>
        </radialGradient>
        <filter id="flGlow"><feGaussianBlur stdDeviation="2" result="g"/><feMerge><feMergeNode in="g"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
      </defs>
      <path d="M50,120 C50,90 50,70 50,45" stroke="url(#stemBG)" stroke-width="3" fill="none" stroke-linecap="round"/>
      <ellipse cx="42" cy="85" rx="12" ry="5" fill="#5a8040" opacity=".7" transform="rotate(-30 42 85)"/>
      <ellipse cx="58" cy="75" rx="10" ry="4" fill="#4a7030" opacity=".6" transform="rotate(25 58 75)"/>
      <g transform="translate(50,38)" filter="url(#flGlow)">
        <ellipse cx="0" cy="-14" rx="9" ry="16" fill="url(#petalG)" opacity=".85" transform="rotate(0)">
          <animateTransform attributeName="transform" type="rotate" values="0;3;0" dur="4s" repeatCount="indefinite"/>
        </ellipse>
        <ellipse cx="0" cy="-14" rx="9" ry="16" fill="url(#petalG)" opacity=".8" transform="rotate(72)">
          <animateTransform attributeName="transform" type="rotate" values="72;75;72" dur="3.5s" repeatCount="indefinite"/>
        </ellipse>
        <ellipse cx="0" cy="-14" rx="9" ry="16" fill="url(#petalG)" opacity=".85" transform="rotate(144)">
          <animateTransform attributeName="transform" type="rotate" values="144;147;144" dur="4.2s" repeatCount="indefinite"/>
        </ellipse>
        <ellipse cx="0" cy="-14" rx="9" ry="16" fill="url(#petalG)" opacity=".8" transform="rotate(216)">
          <animateTransform attributeName="transform" type="rotate" values="216;219;216" dur="3.8s" repeatCount="indefinite"/>
        </ellipse>
        <ellipse cx="0" cy="-14" rx="9" ry="16" fill="url(#petalG)" opacity=".85" transform="rotate(288)">
          <animateTransform attributeName="transform" type="rotate" values="288;291;288" dur="4.5s" repeatCount="indefinite"/>
        </ellipse>
        <circle cx="0" cy="0" r="7" fill="#e0c080" opacity=".8">
          <animate attributeName="r" values="6;8;6" dur="3s" repeatCount="indefinite"/>
        </circle>
        <circle cx="0" cy="0" r="3" fill="#c0a060" opacity=".6"/>
        <circle cx="5" cy="-5" r="1" fill="#f8d080" opacity="0">
          <animate attributeName="opacity" values="0;.8;0" dur="3s" repeatCount="indefinite"/>
          <animate attributeName="cy" values="-5;-12;-5" dur="3s" repeatCount="indefinite"/>
        </circle>
      </g>
    </svg>`;
  },
  
  wiltedFlower(size = 100) {
    return `<svg viewBox="0 0 100 120" width="${size}" height="${size * 1.2}" style="filter:drop-shadow(0 0 10px rgba(90,24,48,.3))">
      <defs>
        <linearGradient id="stemG" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#4a6030"/>
          <stop offset="100%" stop-color="#2a3818"/>
        </linearGradient>
      </defs>
      <path d="M50,120 C50,90 48,70 42,55" stroke="url(#stemG)" stroke-width="3" fill="none" stroke-linecap="round"/>
      <g transform="translate(42,55) rotate(-15)">
        <ellipse cx="0" cy="-12" rx="8" ry="14" fill="#8a3040" opacity=".5" transform="rotate(-30)"/>
        <ellipse cx="0" cy="-12" rx="8" ry="14" fill="#6a2030" opacity=".4" transform="rotate(10)"/>
        <ellipse cx="0" cy="-12" rx="7" ry="12" fill="#8a3040" opacity=".3" transform="rotate(50)"/>
        <ellipse cx="0" cy="-12" rx="7" ry="13" fill="#6a2030" opacity=".35" transform="rotate(-60)"/>
        <circle cx="0" cy="0" r="6" fill="#3a1520" opacity=".7"/>
      </g>
      <ellipse cx="65" cy="110" rx="6" ry="4" fill="#8a3040" opacity=".3" transform="rotate(25 65 110)"/>
      <ellipse cx="72" cy="115" rx="5" ry="3" fill="#6a2030" opacity=".2" transform="rotate(-10 72 115)"/>
    </svg>`;
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCENE RENDERING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function showScene(content, tapToContinue = false) {
  const container = $('scene-container');
  container.innerHTML = content.html;
  $('main-container').classList.add('show');
  
  await sleep(100);
  
  // Animate elements
  const title = container.querySelector('.scene-title');
  if (title) {
    await sleep(300);
    title.classList.add('show');
  }
  
  const texts = container.querySelectorAll('.scene-text');
  for (const t of texts) {
    await sleep(500);
    t.classList.add('show');
    Audio.click();
  }
  
  const minji = container.querySelector('.minji-container');
  if (minji) {
    await sleep(600);
    minji.classList.add('show');
  }
  
  const letter = container.querySelector('.letter-container');
  if (letter) {
    await sleep(500);
    letter.classList.add('show');
  }
  
  const stats = container.querySelector('.stats-container');
  if (stats) {
    await sleep(300);
    stats.classList.add('show');
    const rows = stats.querySelectorAll('.stat-row');
    for (const row of rows) {
      await sleep(120);
      row.classList.add('show');
      const bar = row.querySelector('.stat-bar-fill');
      if (bar) setTimeout(() => { bar.style.width = bar.dataset.width; }, 200);
    }
  }
  
  const valentine = container.querySelector('.valentine-container');
  if (valentine) {
    await sleep(700);
    valentine.classList.add('show');
  }
  
  const hb = container.querySelector('.heartbeat-container');
  if (hb) {
    await sleep(300);
    hb.classList.add('show');
  }
  
  if (tapToContinue) await waitForTap();
}

async function clearScene() {
  $('main-container').classList.remove('show');
  await sleep(800);
  $('scene-container').innerHTML = '';
}

function waitForTap() {
  return new Promise(resolve => {
    const handler = () => {
      document.removeEventListener('click', handler);
      document.removeEventListener('keydown', kHandler);
      Audio.click();
      resolve();
    };
    const kHandler = (e) => { if (e.key === ' ' || e.key === 'Enter') handler(); };
    document.addEventListener('click', handler);
    document.addEventListener('keydown', kHandler);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MINI GAME
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const momentMemories = [
  { text: 'The notification at 2:47 PM', emoji: 'ğŸ“±', flag: 'finger_slip' },
  { text: 'Her voice note at 3am', emoji: 'ğŸµ', flag: 'e_voice_shared' },
  { text: 'The sunrise you almost missed', emoji: 'ğŸŒ…', flag: 'e_sunrise_together' },
  { text: 'Three seconds of contact', emoji: 'âœ‹', flag: 'e_physical_contact' },
  { text: 'When she laughed', emoji: 'ğŸ˜„', flag: 'e_shared_laughter' },
  { text: 'When you opened up', emoji: 'ğŸ”“', flag: 'e_moment_opened' },
  { text: 'When you almost said it', emoji: 'ğŸ’­', flag: 'e_hesitated' },
  { text: 'Her typing at midnight', emoji: 'ğŸ’¬', flag: null },
  { text: 'The streak you kept', emoji: 'ğŸ”¥', flag: 'e_snapchat_daily' },
  { text: 'When you pushed away', emoji: 'ğŸšª', flag: 'e_pushed_away', negative: true },
  { text: 'The door you closed', emoji: 'ğŸ”’', flag: 'e_door_closed', negative: true },
];

async function runMiniGame() {
  return new Promise(resolve => {
    const container = $('minigame-container');
    const area = $('minigame-area');
    const progress = $('minigame-progress');
    const combo = $('minigame-combo');
    container.classList.add('active');
    area.innerHTML = '';
    progress.innerHTML = '';
    
    const totalMoments = 7;
    let caught = 0, missed = 0, streak = 0, maxStreak = 0;
    State.moments = [];
    
    for (let i = 0; i < totalMoments; i++) {
      const dot = document.createElement('div');
      dot.className = 'minigame-dot';
      progress.appendChild(dot);
    }
    
    const updateCombo = () => {
      if (streak > 1) {
        combo.textContent = `Ã—${streak} COMBO`;
        combo.classList.add('show');
      } else {
        combo.classList.remove('show');
      }
    };
    
    const spawnMoment = (index) => {
      if (index >= totalMoments) {
        combo.classList.remove('show');
        setTimeout(() => {
          container.classList.remove('active');
          resolve({ caught, missed, maxStreak });
        }, 600);
        return;
      }
      
      const memory = momentMemories[index % momentMemories.length];
      const target = document.createElement('div');
      target.className = 'minigame-target';
      
      const isNeg = memory.negative;
      const color = isNeg ? '#d85080' : '#f8a0c0';
      target.innerHTML = `<svg viewBox="0 0 40 40" width="40" height="40">
        <circle cx="20" cy="20" r="18" fill="${isNeg ? 'rgba(216,80,128,.2)' : 'rgba(248,160,192,.15)'}"
          stroke="${color}" stroke-width="2">
          <animate attributeName="r" values="16;18;16" dur="1s" repeatCount="indefinite"/>
        </circle>
        <text x="20" y="26" text-anchor="middle" font-size="16">${memory.emoji}</text>
      </svg>`;
      
      const maxX = area.offsetWidth - 50;
      const maxY = area.offsetHeight - 50;
      target.style.left = rand(15, maxX) + 'px';
      target.style.top = rand(15, maxY) + 'px';
      
      let handled = false;
      const handleCatch = (e) => {
        if (handled) return;
        handled = true;
        e.preventDefault();
        e.stopPropagation();
        caught++;
        streak++;
        maxStreak = Math.max(maxStreak, streak);
        Audio.catch();
        const rect = target.getBoundingClientRect();
        Particles.spawn(rect.left + 20, rect.top + 20, 5, isNeg ? '#d85080' : '#f8a0c0');
        progress.children[index].classList.add('filled');
        State.moments.push({ text: memory.text, caught: true, negative: memory.negative });
        updateCombo();
        target.style.transition = 'transform .2s, opacity .2s';
        target.style.transform = 'scale(1.5)';
        target.style.opacity = '0';
        setTimeout(() => { target.remove(); spawnMoment(index + 1); }, 250);
      };
      
      target.addEventListener('click', handleCatch);
      target.addEventListener('touchend', handleCatch, { passive: false });
      area.appendChild(target);
      
      requestAnimationFrame(() => target.classList.add('show'));
      
      const timeout = Math.max(1800, 2800 - index * 100);
      setTimeout(() => {
        if (!handled) {
          handled = true;
          missed++;
          streak = 0;
          Audio.miss();
          progress.children[index].classList.add('missed');
          State.moments.push({ text: memory.text, caught: false, negative: memory.negative });
          updateCombo();
          target.style.transition = 'transform .3s, opacity .3s';
          target.style.transform = 'scale(0)';
          target.style.opacity = '0';
          setTimeout(() => { target.remove(); spawnMoment(index + 1); }, 300);
        }
      }, timeout);
    };
    
    setTimeout(() => spawnMoment(0), 800);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT SEQUENCE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function typeBootLine(el, text, spd = 18) {
  for (let i = 0; i < text.length; i++) {
    el.textContent += text[i];
    Audio.click();
    await sleep(spd);
  }
  el.textContent += '\n';
}

async function boot() {
  const bt = $('boot-text');
  Particles.init();
  Particles.petal(8);
  
  await sleep(1200);
  await typeBootLine(bt, '> SEED ARCHIVE v3.0', 14);
  await sleep(300);
  await typeBootLine(bt, '> LOADING SIDE D: BLOOM...', 16);
  await sleep(250);
  
  // CHANGE: Snd.ensure() -> Audio.ensure()
  Audio.ensure();
  
  await typeBootLine(bt, `> JOURNEY SUMMARY:`, 14);
  await sleep(150);
  await typeBootLine(bt, `  SOIL: ${State.soil.toUpperCase()}`, 12);
  await sleep(80);
  await typeBootLine(bt, `  WALL: ${State.ending ? State.ending.toUpperCase() : 'UNKNOWN'}`, 12);
  await sleep(80);
  await typeBootLine(bt, `  TURNS SURVIVED: ${State.turns}`, 12);
  await sleep(80);
  await typeBootLine(bt, `  TRUST: ${State.trust} | GUARD: ${State.guard} | SYNC: ${State.sync}`, 12);
  await sleep(200);
  
  if (State.has('e_voice_shared')) await typeBootLine(bt, '> â™ª VOICE SHARED', 14);
  if (State.has('e_sunrise_together')) await typeBootLine(bt, '> â˜€ SUNRISE TOGETHER', 14);
  if (State.has('e_physical_contact')) await typeBootLine(bt, '> âœ‹ TOUCH MEMORY', 14);
  if (State.has('e_mercy_ending')) await typeBootLine(bt, '> â™¡ WALL FREED', 14);
  if (State.has('e_fight_ending')) await typeBootLine(bt, '> âœ• WALL BROKEN', 14);
  if (State.determinationUsed) await typeBootLine(bt, '> ğŸ’« DETERMINATION SPENT', 14);
  
  const score = State.getRelationshipScore();
  await sleep(200);
  await typeBootLine(bt, `> RELATIONSHIP SCORE: ${score}`, 14);
  await sleep(300);
  Audio.bloom();
  await typeBootLine(bt, '> INITIALIZING BLOOM SEQUENCE...', 16);
  await sleep(400);
  await typeBootLine(bt, '> READY.', 22);
  
  const cur = document.createElement('span');
  cur.className = 'boot-cursor';
  bt.appendChild(cur);
  
  await sleep(1800);
  Particles.stop();
  Particles.clear();
  $('loading-overlay').classList.add('hidden');
  await sleep(2500);
  runStory();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN STORY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function runStory() {
  if (State.ending === 'mercy') await runMercyPath();
  else if (State.ending === 'fight') await runFightPath();
  else await runDefeatPath();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MERCY PATH
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function runMercyPath() {
  Music.toggle();
  VFX.vignette(false);
  Particles.init();
  Particles.petal(15);
  
  Sheepy.show('love');
  Sheepy.text('You did it beautifully.');
  await sleep(2000);
  
  // SCENE 1
  await showScene({
    html: `
      <div class="scene-title">THE GATE OPENS</div>
      <div class="scene-text">The Wall you understoodâ€”no, <span class="me">the Wall you befriended</span>â€”</div>
      <div class="scene-text">It doesn't block you anymore.</div>
      <div class="scene-text memory">It was never about keeping people out. It was about learning who you wanted to let in.</div>
      <div class="heartbeat-container">${SVG.heartbeat(400, 60, '#4a8040', 2)}</div>
    `
  }, true);
  
  await clearScene();
  
  // SCENE 2
  Sheepy.show('proud');
  Sheepy.text('I wrote you something.');
  await showScene({
    html: `
      <div class="letter-container">
        <div class="letter-text">
          You chose to understand instead of destroy.<br><br>
          That matters more than you know. Not because the Wall deserved mercyâ€”
          but because <span class="gold">you</span> deserved to be free of it.<br><br>
          The version of you who walked in here isn't the one standing now.
          Something shifted. Something rooted.
        </div>
        <div class="letter-signature">â€” Sheepy ğŸ‘</div>
      </div>
    `
  }, true);
  
  await clearScene();
  Audio.bloom();
  
  // SCENE 3
  await showScene({
    html: `
      <div class="scene-title">REMEMBER</div>
      <div class="scene-text">Close your eyes. Just for a moment.</div>
      <div class="scene-text memory">Let the memories come back to you.</div>
    `
  }, true);
  
  await clearScene();
  
  // MINI GAME
  const gameResult = await runMiniGame();
  await sleep(500);
  
  // SCENE 4
  Audio.memory();
  let threadHTML = '<div class="thread-container"><div class="thread-line"></div>';
  State.moments.forEach(m => {
    threadHTML += `<div class="thread-node${m.negative ? ' negative' : ''}${m.caught ? '' : ' missed'}">
      <div class="thread-dot"></div>
      <div class="thread-label">${m.caught ? '' : '<span class="echo">missed: </span>'}${m.text}</div>
    </div>`;
  });
  threadHTML += '</div>';
  
  const totalCaught = State.moments.filter(m => m.caught).length;
  
  await showScene({
    html: `
      <div class="scene-title">YOUR MOMENTS</div>
      <div class="scene-text">You caught <span class="gold">${totalCaught}</span> memories.
        ${gameResult.maxStreak >= 3 ? `<br><span class="memory">A streak of ${gameResult.maxStreak}. You were paying attention.</span>` : ''}
      </div>
      ${threadHTML}
    `
  });
  
  await sleep(400);
  const nodes = document.querySelectorAll('.thread-node');
  for (const node of nodes) {
    await sleep(300);
    node.classList.add('show');
  }
  await waitForTap();
  await clearScene();
  
  // SCENE 5
  Sheepy.hide();
  Audio.heart();
  
  await showScene({
    html: `
      <div class="minji-container">
        <div class="minji-avatar">
          <div class="minji-ring"></div>
          <div class="minji-ring"></div>
          ${SVG.minjiAvatar('love')}
        </div>
        <div class="minji-name">MINJI</div>
        <div class="minji-status"><span class="dot"></span>online</div>
        <div class="voice-indicator">
          <div class="voice-waves">
            <div class="voice-wave"></div><div class="voice-wave"></div><div class="voice-wave"></div>
            <div class="voice-wave"></div><div class="voice-wave"></div><div class="voice-wave"></div>
          </div>
          <span class="voice-text">speaking...</span>
        </div>
      </div>
      <div class="scene-text her" style="margin-top:30px">"Hey. You're still awake."</div>
    `
  });
  
  if (Voice.enabled) await Voice.speak("Hey. You're still awake.");
  await waitForTap();
  await clearScene();
  
  // SCENE 6
  let herDialogue;
  if (State.trust > 60 && State.sync > 60) {
    herDialogue = `"I can tell something's different. You seem... <span class="gold">lighter</span>.<br><br>Sheepy told me you faced yourself. That takes more courage than most people ever find."`;
  } else if (State.trust > 40) {
    herDialogue = `"You've been quiet lately. But it's a <span class="gold">good quiet</span>. Like you're finally listening to something you've been drowning out."`;
  } else {
    herDialogue = `"I was worried about you. But you seem... okay.<br><br>More than okay, actually. Something <span class="gold">grew</span>."`;
  }
  
  await showScene({ html: `<div class="scene-text her">${herDialogue}</div>` });
  if (Voice.enabled) await Voice.speak(herDialogue.replace(/<[^>]*>/g, ''));
  await waitForTap();
  await clearScene();
  
  // SCENE 7
  VFX.flash('rgba(216,80,128,.08)', 300);
  await showScene({ html: `<div class="scene-text her">"Can I tell you something?"</div>` });
  await sleep(2500);
  await clearScene();
  
  const confession = State.has('e_voice_shared')
    ? `"That voice note you saved? I know you listen to it sometimes.<br><br>I listen to yours too.<br><br><span class="memory">Every night before I sleep."</span>`
    : `"When you added me back that day... I wasn't sure if you would.<br><br>I refreshed the app twelve times.<br><br><span class="memory">I'm glad you did."</span>`;
  
  await showScene({ html: `<div class="scene-text her">${confession}</div>` });
  if (Voice.enabled) await Voice.speak(confession.replace(/<[^>]*>/g, ''));
  Audio.hope();
  await waitForTap();
  await clearScene();
  
  // SCENE 8
  await showScene({
    html: `
      <div class="scene-title">WHAT GREW</div>
      <div style="display:flex;justify-content:center;margin:30px 0">${SVG.bloomingFlower(140)}</div>
      <div class="scene-text memory">From barren soil, something bloomed.</div>
    `
  }, true);
  await clearScene();
  
  // SCENE 9
  const sc = State.getRelationshipScore();
  await showScene({
    html: `
      <div class="scene-title">YOUR JOURNEY</div>
      <div class="stats-container">
        <div class="stats-title">WHAT YOU BUILT</div>
        <div class="stat-row"><span class="stat-label">TRUST</span><span class="stat-value ${State.trust > 50 ? 'good' : ''}">${State.trust}%</span></div>
        <div class="stat-row"><span class="stat-label">GUARD</span><span class="stat-value ${State.guard > 50 ? 'bad' : 'good'}">${State.guard}%</span></div>
        <div class="stat-row"><span class="stat-label">SYNC</span><span class="stat-value ${State.sync > 50 ? 'good' : ''}">${State.sync}%</span></div>
        <div class="stat-row"><span class="stat-label">WALL</span><span class="stat-value good">FREED â™¡</span></div>
        <div class="stat-row"><span class="stat-label">MOMENTS</span><span class="stat-value">${totalCaught} caught</span></div>
        <div class="stat-row"><span class="stat-label">SCORE</span><span class="stat-value ${sc > 60 ? 'good' : sc > 30 ? 'warn' : 'bad'}">${sc}%</span></div>
      </div>
    `
  }, true);
  await clearScene();
  
  // VALENTINE
  Audio.heart();
  Particles.petal(30);
  VFX.flash('rgba(216,80,128,.1)', 600);
  
  await showScene({
    html: `
      <div class="minji-container">
        <div class="minji-avatar">
          <div class="minji-ring"></div>
          ${SVG.minjiAvatar('love')}
        </div>
      </div>
      <div class="valentine-container">
        <div class="valentine-heart">${SVG.valentineHeart(90)}</div>
        <div class="valentine-question">"Hey... will you be my Valentine?"</div>
        <div class="valentine-options">
          <button class="valentine-btn yes" onclick="answerValentine('yes')">
            Yes <span class="preview">Of course. Always.</span>
          </button>
          <button class="valentine-btn" onclick="answerValentine('hesitate')">
            I... <span class="preview">[Hesitate]</span>
          </button>
          <button class="valentine-btn" onclick="answerValentine('ask_time')">
            It's not even February <span class="preview">[Deflect with humor]</span>
          </button>
        </div>
      </div>
    `
  });
  
  if (Voice.enabled) await Voice.speak("Hey... will you be my Valentine?");
  
  document.querySelectorAll('.valentine-btn').forEach(btn => {
    btn.addEventListener('mousemove', e => {
      const rect = btn.getBoundingClientRect();
      btn.style.setProperty('--mx', ((e.clientX - rect.left) / rect.width * 100) + '%');
      btn.style.setProperty('--my', ((e.clientY - rect.top) / rect.height * 100) + '%');
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIGHT PATH
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function runFightPath() {
  Music.toggle();
  VFX.vignette(true);
  
  Sheepy.show('sad');
  Sheepy.text('You made it through. But...');
  await sleep(2500);
  
  await showScene({
    html: `
      <div class="scene-title">THE RUBBLE</div>
      <div class="scene-text">The Wall lies in pieces around you.</div>
      <div class="scene-text">You broke through. You <span class="gold">made it</span>.</div>
      <div class="scene-text damage">But something feels... missing.</div>
      <div class="scene-text memory">The parts of you that built the Wall are still in those stones.</div>
    `
  }, true);
  
  await clearScene();
  
  await showScene({
    html: `
      <div class="letter-container">
        <div class="letter-text">
          Force works. It always has.<br><br>
          But it leaves marks. On both sides.<br><br>
          The Wall is down. The question is: what did you lose breaking it?
          And can you find those pieces again?
        </div>
        <div class="letter-signature">â€” Sheepy ğŸ‘</div>
      </div>
    `
  }, true);
  
  await clearScene();
  
  const fightCons = State.fightCount > 5
    ? `Your guard is higher now. You chose violence <span class="damage">${State.fightCount} times</span>.<br><br><span class="damage">That muscle memory doesn't fade easily.</span>`
    : `You fought when you had to. The Wall is down.<br><br><span class="memory">But the scars remain.</span>`;
  
  await showScene({ html: `<div class="scene-text">${fightCons}</div>` }, true);
  await clearScene();
  
  Audio.bloom();
  await showScene({
    html: `
      <div class="scene-title">SALVAGE</div>
      <div class="scene-text">Some memories survived the impact.</div>
      <div class="scene-text memory">Try to catch what remains.</div>
    `
  }, true);
  await clearScene();
  
  const gameResult = await runMiniGame();
  await sleep(500);
  
  const totalCaught = State.moments.filter(m => m.caught).length;
  
  await showScene({
    html: `
      <div class="scene-text">You caught <span class="gold">${totalCaught}</span> moments.</div>
      <div class="scene-text memory">But the ground is uneven where the Wall stood.</div>
      <div style="display:flex;justify-content:center;margin:20px 0">${SVG.bloomingFlower(70)}</div>
      <div class="scene-text echo">Something small is growing in the rubble.</div>
    `
  }, true);
  await clearScene();
  
  Sheepy.hide();
  
  await showScene({
    html: `
      <div class="minji-container">
        <div class="minji-avatar">
          <div class="minji-ring"></div>
          ${SVG.minjiAvatar('neutral')}
        </div>
        <div class="minji-name">MINJI</div>
        <div class="minji-status"><span class="dot"></span>online</div>
      </div>
      <div class="scene-text her" style="margin-top:30px">"You seem... different lately."</div>
    `
  }, true);
  await clearScene();
  
  await showScene({
    html: `<div class="scene-text her">"Something happened. I can feel it.<br><br>You broke through something, didn't you?"</div>`
  }, true);
  await clearScene();
  
  const herFightResponse = State.guard > 60
    ? `"I've been trying to reach you. But it's like...<br><br><span class="damage">there's still a wall, even now.</span><br><br>I don't know how to help someone who won't let me in."`
    : `"Whatever you faced... I'm glad you're here.<br><br><span class="memory">Just... be gentle with yourself, okay?"</span>`;
  
  await showScene({ html: `<div class="scene-text her">${herFightResponse}</div>` });
  if (Voice.enabled) await Voice.speak(herFightResponse.replace(/<[^>]*>/g, ''));
  await waitForTap();
  await clearScene();
  
  const sc = State.getRelationshipScore();
  await showScene({
    html: `
      <div class="scene-title">THE AFTERMATH</div>
      <div class="stats-container">
        <div class="stats-title">WHAT REMAINS</div>
        <div class="stat-row"><span class="stat-label">TRUST</span><span class="stat-value ${State.trust > 50 ? 'good' : 'warn'}">${State.trust}%</span></div>
        <div class="stat-row"><span class="stat-label">GUARD</span><span class="stat-value bad">${State.guard}%</span></div>
        <div class="stat-row"><span class="stat-label">SYNC</span><span class="stat-value">${State.sync}%</span></div>
        <div class="stat-row"><span class="stat-label">WALL</span><span class="stat-value bad">BROKEN</span></div>
        <div class="stat-row"><span class="stat-label">METHOD</span><span class="stat-value warn">FORCE</span></div>
        <div class="stat-row"><span class="stat-label">FIGHTS</span><span class="stat-value bad">${State.fightCount || '?'}</span></div>
        <div class="stat-row"><span class="stat-label">SCORE</span><span class="stat-value ${sc > 40 ? 'warn' : 'bad'}">${sc}%</span></div>
      </div>
    `
  }, true);
  await clearScene();
  
  Audio.hope();
  Particles.petal(12);
  
  await showScene({
    html: `
      <div class="minji-container">
        <div class="minji-avatar">
          <div class="minji-ring"></div>
          ${SVG.minjiAvatar('neutral')}
        </div>
      </div>
      <div class="valentine-container">
        <div class="valentine-heart">${SVG.valentineHeart(75)}</div>
        <div class="valentine-question">"Hey... will you be my Valentine?"</div>
        <div class="valentine-options">
          <button class="valentine-btn yes" onclick="answerValentine('yes')">
            Yes <span class="preview">I want to try.</span>
          </button>
          <button class="valentine-btn" onclick="answerValentine('not_ready')">
            I'm not ready <span class="preview">[Honest]</span>
          </button>
          <button class="valentine-btn" onclick="answerValentine('dont_deserve')">
            I don't deserve that <span class="preview">[Self-doubt]</span>
          </button>
        </div>
      </div>
    `
  });
  
  if (Voice.enabled) await Voice.speak("Hey... will you be my Valentine?");
  
  document.querySelectorAll('.valentine-btn').forEach(btn => {
    btn.addEventListener('mousemove', e => {
      const rect = btn.getBoundingClientRect();
      btn.style.setProperty('--mx', ((e.clientX - rect.left) / rect.width * 100) + '%');
      btn.style.setProperty('--my', ((e.clientY - rect.top) / rect.height * 100) + '%');
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEFEAT PATH
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function runDefeatPath() {
  VFX.vignette(true);
  
  Audio.sadness();
  Sheepy.show('grieving');
  Sheepy.text("Some walls... don't come down.");
  await sleep(3000);
  
  await showScene({
    html: `
      <div class="scene-title">THE THORNS REMAIN</div>
      <div class="scene-text damage">You couldn't break through.</div>
      <div class="scene-text">The Wall still stands. The thorns grow thicker.</div>
      <div class="scene-text memory">Some barriers outlast the people who built them.</div>
      <div style="display:flex;justify-content:center;margin:20px 0">${SVG.wiltedFlower(120)}</div>
    `
  }, true);
  await clearScene();
  
  await showScene({
    html: `
      <div class="letter-container">
        <div class="letter-text">
          I'm sorry. Not every story has a happy ending.<br><br>
          But every ending has meaning.<br><br>
          You tried. You showed up. That's more than the version of you
          from before Side A ever would have done.
        </div>
        <div class="letter-signature">â€” Sheepy ğŸ‘</div>
      </div>
    `
  }, true);
  await clearScene();
  
  Audio.sadness();
  await showScene({
    html: `
      <div class="scene-title">THE GHOST OF WHAT COULD HAVE BEEN</div>
      <div class="scene-text echo">You wonder what would have happened if:</div>
      <div class="scene-text memory">You had talked more instead of fighting.</div>
      <div class="scene-text memory">You had listened to your own patterns.</div>
      <div class="scene-text memory">You had let yourself be vulnerable.</div>
    `
  }, true);
  await clearScene();
  
  const ghostMemory = State.has('e_voice_shared')
    ? `You still have her voice note saved. You play it sometimes.<br><br><span class="her">"You saved it? That's..."</span><br><br>She never finished that sentence.`
    : `You remember the notification at 2:47 PM.<br><br><span class="memory">A Tuesday that could have split your life in two.</span><br><br>But the Wall was too strong.`;
  
  await showScene({ html: `<div class="scene-text">${ghostMemory}</div>` });
  Audio.memory();
  await waitForTap();
  await clearScene();
  
  Sheepy.show('hopeful');
  Sheepy.text('But the next version of you...');
  Audio.hope();
  
  await showScene({
    html: `
      <div class="scene-text gold">The next version of you will be stronger.</div>
      <div class="scene-text gold">The next version will know the Wall's weakness.</div>
      <div class="scene-text gold">The next version will try again.</div>
      <div class="scene-text memory">This is just one attempt. Not the final one.</div>
      <div style="display:flex;justify-content:center;margin:20px 0">${SVG.bloomingFlower(60)}</div>
    `
  }, true);
  await clearScene();
  
  const sc = State.getRelationshipScore();
  await showScene({
    html: `
      <div class="scene-title">LESSONS LEARNED</div>
      <div class="stats-container">
        <div class="stats-title">WHAT HAPPENED</div>
        <div class="stat-row"><span class="stat-label">TRUST</span><span class="stat-value bad">${State.trust}%</span></div>
        <div class="stat-row"><span class="stat-label">GUARD</span><span class="stat-value bad">${State.guard}%</span></div>
        <div class="stat-row"><span class="stat-label">SYNC</span><span class="stat-value bad">${State.sync}%</span></div>
        <div class="stat-row"><span class="stat-label">WALL</span><span class="stat-value bad">STANDING</span></div>
        <div class="stat-row"><span class="stat-label">PHASE</span><span class="stat-value bad">${State.phases.length > 0 ? Math.max(...State.phases) : 1}</span></div>
        <div class="stat-row"><span class="stat-label">TURNS</span><span class="stat-value">${State.turns}</span></div>
        <div class="stat-row"><span class="stat-label">SCORE</span><span class="stat-value bad">${sc}%</span></div>
      </div>
    `
  }, true);
  await clearScene();
  
  Audio.sadness();
  Sheepy.hide();
  
  await showScene({
    html: `
      <div class="scene-title damage">THE MESSAGE NEVER COMES</div>
      <div class="scene-text">She doesn't ask.</div>
      <div class="scene-text">Maybe she sensed the Wall from the other side.</div>
      <div class="scene-text">Maybe the timing was never right.</div>
      <div class="scene-text memory">Or maybe... you weren't ready to receive it.</div>
      <div class="heartbeat-container">${SVG.heartbeat(400, 60, '#5a5550', 3)}</div>
    `
  }, true);
  
  await clearScene();
  showEnding('defeat');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VALENTINE ANSWER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.answerValentine = async function(answer) {
  State.valentineAnswer = answer;
  Audio.select();
  
  document.querySelectorAll('.valentine-btn').forEach(b => {
    b.disabled = true;
    const btnText = b.textContent.toLowerCase();
    if (btnText.includes(answer === 'yes' ? 'yes' : answer === 'hesitate' ? 'i...' :
        answer === 'ask_time' ? 'february' : answer === 'not_ready' ? 'ready' : 'deserve')) {
      b.classList.add('selected');
    } else {
      b.classList.add('fade');
    }
  });
  
  await sleep(1200);
  await clearScene();
  
  let response, ending;
  
  if (answer === 'yes') {
    Audio.heart();
    VFX.flash('rgba(216,80,128,.12)', 500);
    response = `
      <div class="scene-text her">"Really?"</div>
      <div class="scene-text her">"Like... <span class="gold">really</span> really?"</div>
      <div class="scene-text memory">Her voice cracks. Just a little.</div>
      <div class="scene-text her">"I've been wanting to ask you that for... a while now."</div>
    `;
    ending = 'yes';
  } else if (answer === 'hesitate') {
    response = `
      <div class="scene-text her">"You don't have to answer right now."</div>
      <div class="scene-text memory">She waits. She doesn't push.</div>
      <div class="scene-text her">"But... think about it? Please?"</div>
    `;
    ending = 'hesitate';
  } else if (answer === 'ask_time') {
    response = `
      <div class="scene-text her">"LOL okay fair."</div>
      <div class="scene-text her">"But <span class="gold">seriously</span> though... whenever you're ready."</div>
      <div class="scene-text memory">She laughs. The tension breaks like light through glass.</div>
      <div class="scene-text her">"I'll ask again. In February. When it's socially acceptable."</div>
    `;
    ending = 'humor';
  } else if (answer === 'not_ready') {
    response = `
      <div class="scene-text her">"Oh."</div>
      <div class="scene-text memory">A pause. Not uncomfortable. Just... real.</div>
      <div class="scene-text her">"Okay. That's honest. I respect that."</div>
      <div class="scene-text her">"I'll be here. <span class="memory">When you are.</span>"</div>
    `;
    ending = 'not_ready';
  } else if (answer === 'dont_deserve') {
    response = `
      <div class="scene-text her">"Hey."</div>
      <div class="scene-text damage">"Don't say that."</div>
      <div class="scene-text her">"You faced yourself. That's more than most people ever do."</div>
      <div class="scene-text memory">"Deserving isn't the question. <span class="gold">Readiness</span> is."</div>
    `;
    ending = 'self_doubt';
  }
  
  await showScene({ html: response });
  if (Voice.enabled) {
    const cleanText = response.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
    await Voice.speak(cleanText, 0.78, 1.1);
  }
  await waitForTap();
  await clearScene();
  
  // Final moment for positive endings
  if (ending === 'yes' || ending === 'humor') {
    Audio.heart();
    Particles.init();
    Particles.petal(45);
    VFX.flash('rgba(216,80,128,.15)', 600);
    
    await showScene({
      html: `
        <div class="scene-title gold">SHE SAYS:</div>
        <div class="scene-text her">"Then it's settled."</div>
        <div class="scene-text her">"You're mine now. <span class="gold">No take-backs.</span>"</div>
        <div class="scene-text memory">She sends a photo. It's blurry. It's imperfect.<br>It's her smiling.</div>
        <div style="display:flex;justify-content:center;margin:20px 0">${SVG.bloomingFlower(100)}</div>
      `
    });
    if (Voice.enabled) await Voice.speak("Then it's settled. You're mine now. No take-backs.");
    await waitForTap();
    await clearScene();
  }
  
  await sleep(800);
  showEnding(ending);
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENDING DISPLAY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function showEnding(type) {
  Music.fadeOut(5);
  Particles.stop();
  Particles.clear();
  $('main-container').classList.remove('show');
  Sheepy.hide();
  
  const score = State.getRelationshipScore();
  const icon = $('ending-icon');
  const title = $('ending-title');
  const body = $('ending-body');
  const song = $('ending-song');
  const nav = $('ending-nav');
  
  if (type === 'yes') {
    icon.innerHTML = SVG.bloomingFlower(90);
    title.textContent = 'BLOOM';
    title.style.color = 'var(--gold-glow)';
    body.innerHTML = `
      You said yes.<br><br>
      Not because you were certain. Not because it was easy.<br>
      But because some things are worth the risk.<br><br>
      <span class="her">The thorns part. What grows next is up to you both.</span>
    `;
    song.innerHTML = 'â™ª Now playing: BURNER BOY â€” her favorite song';
  } else if (type === 'hesitate') {
    icon.innerHTML = SVG.bloomingFlower(70);
    title.textContent = 'THE SEED';
    title.style.color = 'var(--bloom-pale)';
    body.innerHTML = `
      You hesitated.<br><br>
      Not a no. Not a yes. Just... a pause.<br>
      Sometimes the most honest answer is <span class="gold">"I need time."</span><br><br>
      <span class="memory">She's still there. Waiting. That means something.</span>
    `;
  } else if (type === 'humor') {
    icon.textContent = 'ğŸ˜„';
    icon.style.fontSize = 'clamp(3rem,10vw,5rem)';
    title.textContent = 'THE LAUGH';
    title.style.color = 'var(--pink-soft)';
    body.innerHTML = `
      You made her laugh.<br><br>
      In a moment that could have been heavy, you chose light.<br>
      Sometimes that's its own kind of yes.<br><br>
      <span class="her">"See you in February, then."</span>
    `;
    song.innerHTML = 'â™ª She saved BURNER BOY to your shared playlist';
  } else if (type === 'not_ready') {
    icon.innerHTML = `<svg viewBox="0 0 60 60" width="60" height="60">
      <circle cx="30" cy="30" r="25" fill="none" stroke="var(--gold-glow)" stroke-width="2" stroke-dasharray="4 4" opacity=".5">
        <animateTransform attributeName="transform" type="rotate" from="0 30 30" to="360 30 30" dur="20s" repeatCount="indefinite"/>
      </circle>
      <text x="30" y="38" text-anchor="middle" font-size="24">â³</text>
    </svg>`;
    title.textContent = 'NOT YET';
    title.style.color = 'var(--gold-glow)';
    body.innerHTML = `
      You were honest.<br><br>
      The hardest thing to say: <span class="gold">"I'm not ready."</span><br>
      The bravest thing she did: Listen.<br><br>
      <span class="memory">Not every ending is a door closing. Some are just... a pause.</span>
    `;
  } else if (type === 'self_doubt') {
    icon.innerHTML = SVG.valentineHeart(60);
    title.textContent = 'THE CRACK';
    title.style.color = 'var(--bloom-glow)';
    body.innerHTML = `
      You don't believe you deserve this.<br><br>
      Maybe that's the real Wall. Not the one you faced.<br>
      But the one inside that says <span class="damage">you're not enough</span>.<br><br>
      <span class="her">She sees something in you. Even if you can't.</span>
    `;
  } else {
    icon.innerHTML = SVG.wiltedFlower(80);
    title.textContent = 'THE WILTED GARDEN';
    title.style.color = 'var(--dim)';
    body.innerHTML = `
      Some walls don't come down in one lifetime.<br><br>
      This was one attempt. One version of the story.<br>
      The next you will be stronger. Wiser. More ready.<br><br>
      <span class="memory">The seeds remember the rain. Even when nothing blooms.</span>
    `;
  }
  
  nav.innerHTML = `<a href="index.html">â† RETURN TO ARCHIVE</a>`;
  
  State.flags.add('tape4_complete');
  State.flags.add(`tape4_ending_${type}`);
  State.save();
  
  await sleep(500);
  $('ending-container').classList.add('show');
  
  if (type === 'yes' || type === 'humor') {
    await sleep(3000);
    Particles.init();
    Particles.petal(10);
  }
}

// Start
boot();
</script>
</body>
</html>
