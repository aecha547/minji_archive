<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SIDE D: BLOOM</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3CradialGradient id='bloom' cx='50%25' cy='50%25'%3E%3Cstop offset='0%25' stop-color='%23d87895' stop-opacity='.9'/%3E%3Cstop offset='100%25' stop-color='%23802845' stop-opacity='.5'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='32' height='32' fill='%23050505'/%3E%3Ccircle cx='16' cy='16' r='10' fill='url(%23bloom)'/%3E%3Cellipse cx='10' cy='10' rx='3' ry='5' fill='%23d87895' transform='rotate(-45 10 10)'/%3E%3Cellipse cx='22' cy='10' rx='3' ry='5' fill='%23d87895' transform='rotate(45 22 10)'/%3E%3Cellipse cx='10' cy='22' rx='3' ry='5' fill='%23d87895' transform='rotate(45 10 22)'/%3E%3Cellipse cx='22' cy='22' rx='3' ry='5' fill='%23d87895' transform='rotate(-45 22 22)'/%3E%3C/svg%3E">
<style>
@import url('https://fonts.googleapis.com/css2?family=VT323&family=Caveat:wght@400;600;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Space+Mono:wght@400;700&family=DM+Serif+Display:ital@0;1&display=swap');

:root {
  --bg-deep: #010101; --bg: #030303;
  --bloom-deep: #2a0a15; --bloom: #5a1830; --bloom-light: #8a2850;
  --bloom-glow: #d85080; --bloom-pale: #f8a0c0;
  --gold: #907030; --gold-glow: #e0c080;
  --pink-deep: #5a1025; --pink: #802845; --pink-soft: #d87895; --pink-glow: #ff5080;
  --white: #e0dcd5; --dim: #5a5550; --trust: #4a8040;
  --font-crt: 'VT323', monospace; --font-hand: 'Caveat', cursive;
  --font-serif: 'Cormorant Garamond', serif; --font-body: 'EB Garamond', serif;
  --font-display: 'DM Serif Display', serif;
  --ease: cubic-bezier(.4,0,.2,1);
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; overflow: hidden; background: var(--bg-deep);
  font-family: var(--font-body); color: var(--white);
  -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }

/* â•â•â• NOISE / CRT â•â•â• */
#noise-layer{position:fixed;inset:0;z-index:2;pointer-events:none;opacity:.04;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  animation:noiseShift .5s steps(5) infinite}
@keyframes noiseShift{0%,100%{transform:translate(0)}25%{transform:translate(-2%,-2%)}50%{transform:translate(2%,0)}75%{transform:translate(-1%,2%)}}

.crt-screen{position:relative;overflow:hidden;min-height:100vh}
.crt-screen::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.12) 2px,rgba(0,0,0,.12) 4px);pointer-events:none;z-index:100}
.crt-screen::after{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center,transparent 50%,rgba(0,0,0,.7) 100%);pointer-events:none;z-index:101}
.scan-bar{position:fixed;top:0;left:0;width:100%;height:8px;background:linear-gradient(180deg,transparent,rgba(216,80,128,.04),transparent);opacity:.5;z-index:102;pointer-events:none;animation:scanbar 8s linear infinite}
@keyframes scanbar{from{top:-8%}to{top:108%}}

/* â•â•â• FLASH OVERLAYS â•â•â• */
#flash-overlay{position:fixed;inset:0;z-index:200;pointer-events:none;opacity:0;transition:opacity .15s ease}
#flash-overlay.active{opacity:1}
#vignette{position:fixed;inset:0;z-index:150;pointer-events:none;opacity:0;transition:opacity 3s;
  background:radial-gradient(ellipse at center,transparent 20%,rgba(0,0,0,.95) 100%)}
#vignette.active{opacity:1}

/* â•â•â• PARTICLE CONTAINER â•â•â• */
#particle-container{position:fixed;inset:0;z-index:180;pointer-events:none;overflow:hidden}
.particle{position:absolute;border-radius:50%;pointer-events:none}
@keyframes pFly{0%{opacity:1;transform:translate(0) scale(1)}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0)}}
.petal{position:absolute;width:8px;height:12px;border-radius:50% 0 50% 0;pointer-events:none;opacity:0}
@keyframes petalFall{0%{transform:translateY(-20px) rotate(0);opacity:0}10%{opacity:.6}100%{transform:translateY(100vh) rotate(360deg);opacity:0}}
.sparkle{position:absolute;width:4px;height:4px;border-radius:50%;pointer-events:none}
@keyframes sparklePop{0%{transform:scale(0);opacity:1}50%{transform:scale(2);opacity:.7}100%{transform:scale(0);opacity:0}}

/* â•â•â• LOADING â•â•â• */
#loading-overlay{position:fixed;inset:0;z-index:9999;background:var(--bg-deep);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;opacity:1;transition:opacity 3s var(--ease)}
#loading-overlay.hidden{opacity:0;pointer-events:none}
.bloom-loading{width:clamp(100px,26vw,140px);height:clamp(100px,26vw,140px);animation:bloomPulse 4s ease-in-out infinite}
@keyframes bloomPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
#loading-overlay h1{font-family:var(--font-display);font-size:clamp(1.4rem,5vw,2rem);font-weight:400;color:var(--bloom-glow);letter-spacing:5px;text-shadow:0 0 60px var(--bloom);text-align:center;margin-top:24px;animation:titleGlow 4s ease-in-out infinite}
@keyframes titleGlow{0%,100%{opacity:.6;text-shadow:0 0 40px var(--bloom)}50%{opacity:1;text-shadow:0 0 80px var(--bloom-glow)}}
#loading-overlay .sub{font-family:var(--font-hand);font-size:clamp(1rem,2.8vw,1.3rem);color:var(--bloom-pale);margin-top:10px;opacity:.45}
.boot-text{color:var(--bloom-light);font-family:var(--font-crt);font-size:clamp(11px,1.8vw,13px);margin-top:40px;text-align:left;width:min(340px,84vw);line-height:2.4;min-height:180px;white-space:pre-wrap}
.boot-cursor{display:inline-block;width:8px;height:1.1em;background:var(--bloom-light);vertical-align:text-bottom;margin-left:2px;animation:blink .9s step-end infinite}
@keyframes blink{50%{opacity:0}}

/* â•â•â• MAIN CONTAINER â•â•â• */
.main-container{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:70px 20px 20px;z-index:10;opacity:0;transition:opacity 2s}
.main-container.show{opacity:1}

/* â•â•â• HEADER â•â•â• */
.header{position:fixed;top:0;left:0;right:0;z-index:50;display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:linear-gradient(180deg,rgba(0,0,0,.9),transparent);pointer-events:none}
.header>*{pointer-events:auto}
.back-btn{color:var(--dim);text-decoration:none;font-family:var(--font-crt);font-size:.85rem;transition:all .5s;padding:5px 10px;border-radius:5px}
.back-btn:hover{color:var(--bloom-glow);text-shadow:0 0 18px var(--bloom);background:rgba(90,24,48,.15)}
.tape-label{background:linear-gradient(180deg,#f5efe5,#d8d0c0);color:#1a1510;padding:4px 12px;font-family:var(--font-crt);font-size:.6rem;text-transform:uppercase;letter-spacing:2px;border:1px solid #888;box-shadow:0 4px 12px rgba(0,0,0,.5)}
.status-text{font-family:var(--font-crt);font-size:11px;color:var(--dim);letter-spacing:1px}

/* â•â•â• CONTROL BUTTONS â•â•â• */
.control-buttons{position:fixed;top:10px;right:10px;z-index:200;display:flex;gap:5px}
.ctrl-btn{background:rgba(0,0,0,.75);border:1px solid #2a2520;border-radius:5px;color:var(--dim);font-family:var(--font-crt);font-size:11px;padding:4px 10px;cursor:pointer;transition:all .4s;min-height:30px}
.ctrl-btn:hover,.ctrl-btn.on{color:var(--bloom-glow);border-color:var(--bloom);box-shadow:0 0 10px rgba(216,80,128,.2)}
.ctrl-btn.music-on{color:var(--pink-soft);border-color:var(--pink);animation:musicP 2.5s ease-in-out infinite}
@keyframes musicP{0%,100%{box-shadow:0 0 6px rgba(216,120,149,.1)}50%{box-shadow:0 0 14px rgba(216,120,149,.25)}}

/* â•â•â• SCENE DISPLAY â•â•â• */
.scene-container{max-width:580px;width:100%;text-align:center;padding:20px}
.scene-title{font-family:var(--font-display);font-size:clamp(1.5rem,5vw,2.2rem);color:var(--bloom-glow);letter-spacing:4px;margin-bottom:20px;opacity:0;transform:translateY(20px);transition:all 1.5s var(--ease)}
.scene-title.show{opacity:1;transform:translateY(0)}
.scene-text{font-family:var(--font-serif);font-size:clamp(1rem,2.8vw,1.3rem);line-height:2.4;color:var(--white);margin-bottom:24px;opacity:0;transform:translateY(15px);transition:all 1.2s var(--ease) .2s}
.scene-text.show{opacity:1;transform:translateY(0)}
.scene-text .her{color:var(--pink-soft);text-shadow:0 0 30px rgba(216,120,149,.4)}
.scene-text .me{color:var(--gold-glow);font-style:italic}
.scene-text .memory{color:var(--bloom-pale);font-style:italic;font-size:.9em;opacity:.8}
.scene-text .crack{text-decoration:line-through;text-decoration-color:var(--bloom-glow);opacity:.6}
.scene-text .gold{color:var(--gold-glow)}
.scene-text .damage{color:var(--bloom-glow)}
.scene-text .echo{color:var(--dim);font-style:italic}

.scene-subtitle{font-family:var(--font-hand);font-size:clamp(1rem,2.5vw,1.3rem);color:var(--bloom-pale);margin-bottom:30px;opacity:.7}

/* â•â•â• SHEEPY â•â•â• */
#sheepy{position:fixed;bottom:20px;left:20px;z-index:40;display:flex;flex-direction:column;align-items:center;gap:8px;opacity:0;transform:translateY(20px);transition:all 1s var(--ease)}
#sheepy.show{opacity:1;transform:translateY(0)}
.sheepy-sprite{width:clamp(60px,14vw,80px);height:clamp(60px,14vw,80px)}
.sheepy-text{font-family:var(--font-hand);font-size:clamp(.8rem,1.8vw,1rem);color:var(--bloom-pale);text-align:center;max-width:130px;line-height:1.5}

/* â•â•â• MINJI DISPLAY â•â•â• */
.minji-container{position:relative;margin:30px auto;opacity:0;transform:scale(.9);transition:all 1.5s var(--ease)}
.minji-container.show{opacity:1;transform:scale(1)}
.minji-avatar{width:clamp(120px,30vw,180px);height:clamp(120px,30vw,180px);border-radius:50%;background:radial-gradient(circle at 30% 30%,var(--bloom-light),var(--bloom-deep));margin:0 auto;display:flex;align-items:center;justify-content:center;box-shadow:0 0 60px rgba(216,80,128,.3),inset 0 0 30px rgba(0,0,0,.5);position:relative;overflow:hidden}
.minji-avatar::before{content:'';position:absolute;inset:0;border-radius:50%;border:2px solid var(--bloom-glow);opacity:.5}
.minji-icon{font-size:clamp(3rem,8vw,4.5rem)}
.minji-name{font-family:var(--font-display);font-size:clamp(1rem,3vw,1.4rem);color:var(--bloom-pale);margin-top:16px;letter-spacing:3px}
.minji-status{font-family:var(--font-hand);font-size:clamp(.8rem,2vw,1rem);color:var(--dim);margin-top:4px}

/* Voice indicator */
.voice-indicator{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;background:rgba(90,24,48,.3);border:1px solid var(--bloom);border-radius:20px;margin-top:16px;opacity:0;transition:opacity .5s}
.voice-indicator.show{opacity:1}
.voice-waves{display:flex;gap:2px;align-items:center}
.voice-wave{width:3px;height:12px;background:var(--bloom-glow);border-radius:2px;animation:wave .4s ease-in-out infinite}
.voice-wave:nth-child(2){animation-delay:.1s;height:16px}
.voice-wave:nth-child(3){animation-delay:.2s;height:10px}
.voice-wave:nth-child(4){animation-delay:.3s;height:14px}
.voice-wave:nth-child(5){animation-delay:.15s;height:8px}
@keyframes wave{0%,100%{transform:scaleY(1)}50%{transform:scaleY(.5)}}
.voice-text{font-family:var(--font-crt);font-size:.8rem;color:var(--bloom-pale);letter-spacing:1px}

/* â•â•â• CHOICES â•â•â• */
.choices-container{max-width:480px;margin:30px auto 0;opacity:0;transform:translateY(20px);transition:all 1s var(--ease) .3s}
.choices-container.show{opacity:1;transform:translateY(0)}
.choice-btn{width:100%;padding:16px 24px;margin-bottom:12px;background:linear-gradient(145deg,rgba(42,10,21,.9),rgba(20,5,10,.95));border:2px solid var(--bloom-light);border-radius:10px;color:var(--white);font-family:var(--font-serif);font-size:clamp(.95rem,2.5vw,1.15rem);text-align:left;cursor:pointer;transition:all .4s var(--ease);position:relative;overflow:hidden}
.choice-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(216,80,128,.08),transparent);transform:translateX(-100%);transition:transform .7s}
.choice-btn:hover::before{transform:translateX(100%)}
.choice-btn:hover{border-color:var(--bloom-glow);transform:translateX(6px);box-shadow:0 0 25px rgba(216,80,128,.2)}
.choice-btn .preview{display:block;font-size:.75rem;color:var(--dim);margin-top:6px;font-family:var(--font-hand)}
.choice-btn.selected{border-color:var(--gold-glow);background:linear-gradient(145deg,rgba(144,112,48,.2),rgba(90,70,30,.1))}

/* â•â•â• MINI GAME: THE MOMENT â•â•â• */
.minigame-container{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.95);display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 1.5s}
.minigame-container.active{opacity:1;pointer-events:auto}
.minigame-title{font-family:var(--font-display);font-size:clamp(1.2rem,4vw,1.6rem);color:var(--gold-glow);letter-spacing:4px;margin-bottom:20px}
.minigame-area{width:clamp(280px,70vw,400px);height:clamp(280px,70vw,400px);border:3px solid var(--bloom);border-radius:50%;position:relative;background:radial-gradient(circle,rgba(90,24,48,.2),rgba(5,5,5,.95));overflow:hidden}
.minigame-target{position:absolute;width:30px;height:30px;border-radius:50%;background:var(--pink-soft);box-shadow:0 0 20px var(--pink-glow);cursor:pointer;transition:transform .2s;opacity:0}
.minigame-target.show{opacity:1}
.minigame-target:hover{transform:scale(1.2)}
.minigame-instruction{font-family:var(--font-hand);font-size:1.1rem;color:var(--bloom-pale);margin-top:20px;text-align:center}
.minigame-progress{display:flex;gap:6px;margin-top:16px}
.minigame-dot{width:12px;height:12px;border-radius:50%;background:var(--bloom-deep);border:1px solid var(--bloom)}
.minigame-dot.filled{background:var(--bloom-glow);box-shadow:0 0 8px var(--bloom-glow)}

/* â•â•â• MINI GAME: TYPING HER NAME â•â•â• */
.typing-game{max-width:400px;margin:20px auto}
.typing-display{font-family:var(--font-display);font-size:clamp(2rem,6vw,3rem);color:var(--bloom-pale);letter-spacing:8px;margin-bottom:20px;min-height:60px}
.typing-display .typed{color:var(--gold-glow)}
.typing-display .cursor{animation:cursorBlink .8s step-end infinite;color:var(--bloom-glow)}
@keyframes cursorBlink{50%{opacity:0}}
.typing-hint{font-family:var(--font-hand);font-size:1rem;color:var(--dim)}
.typing-input{opacity:0;position:absolute}

/* â•â•â• STATS DISPLAY â•â•â• */
.stats-container{max-width:400px;margin:30px auto;padding:20px;background:rgba(42,10,21,.4);border:1px solid var(--bloom-deep);border-radius:12px;opacity:0;transform:translateY(20px);transition:all 1s var(--ease)}
.stats-container.show{opacity:1;transform:translateY(0)}
.stats-title{font-family:var(--font-crt);font-size:.9rem;color:var(--bloom-pale);letter-spacing:2px;margin-bottom:16px;text-align:center}
.stat-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(90,24,48,.3);font-family:var(--font-crt);font-size:.85rem}
.stat-label{color:var(--dim)}
.stat-value{color:var(--white)}
.stat-value.good{color:var(--trust)}
.stat-value.warn{color:var(--gold-glow)}
.stat-value.bad{color:var(--bloom-glow)}

/* â•â•â• VALENTINE QUESTION â•â•â• */
.valentine-container{max-width:500px;margin:30px auto;opacity:0;transform:scale(.95);transition:all 1.5s var(--ease)}
.valentine-container.show{opacity:1;transform:scale(1)}
.valentine-question{font-family:var(--font-hand);font-size:clamp(1.3rem,4vw,1.8rem);color:var(--pink-soft);text-align:center;line-height:2;margin-bottom:30px}
.valentine-heart{font-size:4rem;text-align:center;margin-bottom:20px;animation:heartBeat 1.5s ease-in-out infinite}
@keyframes heartBeat{0%,100%{transform:scale(1)}15%{transform:scale(1.15)}30%{transform:scale(1)}45%{transform:scale(1.1)}}
.valentine-options{display:flex;flex-direction:column;gap:16px;max-width:350px;margin:0 auto}
.valentine-btn{padding:18px 24px;background:linear-gradient(145deg,rgba(90,24,48,.6),rgba(40,10,20,.8));border:2px solid var(--bloom-light);border-radius:12px;color:var(--white);font-family:var(--font-serif);font-size:1.1rem;cursor:pointer;transition:all .4s}
.valentine-btn:hover{border-color:var(--bloom-glow);box-shadow:0 0 30px rgba(216,80,128,.25);transform:translateY(-3px)}
.valentine-btn.yes{border-color:var(--trust)}
.valentine-btn.yes:hover{border-color:#80c080;box-shadow:0 0 30px rgba(74,128,64,.3)}

/* â•â•â• ENDING SCREEN â•â•â• */
.ending-container{position:fixed;inset:0;z-index:400;background:var(--bg-deep);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px;opacity:0;pointer-events:none;transition:opacity 3s}
.ending-container.show{opacity:1;pointer-events:auto}
.ending-icon{font-size:clamp(4rem,12vw,6rem);margin-bottom:24px;animation:endingPulse 3s ease-in-out infinite}
@keyframes endingPulse{0%,100%{transform:scale(1);opacity:.8}50%{transform:scale(1.05);opacity:1}}
.ending-title{font-family:var(--font-display);font-size:clamp(1.4rem,5vw,2rem);color:var(--gold-glow);letter-spacing:4px;margin-bottom:16px;text-align:center}
.ending-body{font-family:var(--font-serif);font-size:clamp(1rem,3vw,1.2rem);color:var(--bloom-pale);line-height:2.2;text-align:center;max-width:500px;margin-bottom:30px}
.ending-song{font-family:var(--font-hand);font-size:1.1rem;color:var(--pink-soft);margin-top:20px;opacity:.8}
.ending-nav{margin-top:30px;display:flex;gap:16px;flex-wrap:wrap;justify-content:center}
.ending-nav a{color:var(--dim);font-family:var(--font-crt);text-decoration:none;border:1px solid #2a2520;padding:10px 20px;border-radius:6px;transition:all .4s;font-size:.85rem}
.ending-nav a:hover{color:var(--bloom-glow);border-color:var(--bloom)}
.ending-nav a.locked{opacity:.4;pointer-events:none;border-color:#1a1a1a;color:#333;position:relative}
.ending-nav a.locked::after{content:'ğŸ”’';position:absolute;top:-8px;right:-8px;font-size:.7rem}

/* â•â•â• TAPE 5 LOCKED â•â•â• */
.tape5-locked{margin-top:40px;text-align:center;opacity:0;transition:opacity 1s}
.tape5-locked.show{opacity:1}
.tape5-icon{width:60px;height:60px;border-radius:8px;background:rgba(30,30,30,.8);border:1px solid #333;display:flex;align-items:center;justify-content:center;margin:0 auto;filter:grayscale(1) brightness(.4)}
.tape5-label{font-family:var(--font-crt);font-size:.7rem;color:#444;letter-spacing:2px;margin-top:8px}
.tape5-hint{font-family:var(--font-hand);font-size:.8rem;color:#333;margin-top:4px}

/* â•â•â• RESPONSIVE â•â•â• */
@media(max-width:500px){
.header{padding:10px 14px}
.main-container{padding:60px 16px 16px}
.scene-container{padding:16px}
.choice-btn{padding:14px 18px}
#sheepy{bottom:14px;left:14px}
}
</style>
</head>
<body>

<!-- Flash Overlay -->
<div id="flash-overlay"></div>
<div id="vignette"></div>

<!-- Particle Container -->
<div id="particle-container"></div>

<!-- Loading Overlay -->
<div id="loading-overlay">
  <svg class="bloom-loading" viewBox="0 0 100 100">
    <defs>
      <radialGradient id="bloomGrad" cx="50%" cy="50%">
        <stop offset="0%" stop-color="#d85080"/>
        <stop offset="100%" stop-color="#5a1830"/>
      </radialGradient>
      <filter id="bloomGlow"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
    </defs>
    <circle cx="50" cy="50" r="28" fill="url(#bloomGrad)" filter="url(#bloomGlow)">
      <animate attributeName="r" values="28;30;28" dur="3s" repeatCount="indefinite"/>
    </circle>
    <ellipse cx="50" cy="25" rx="8" ry="15" fill="#d87895" transform="rotate(-20 50 50)"><animate attributeName="ry" values="15;17;15" dur="3s" repeatCount="indefinite"/></ellipse>
    <ellipse cx="50" cy="25" rx="8" ry="15" fill="#d87895" transform="rotate(20 50 50)"><animate attributeName="ry" values="15;17;15" dur="3s" repeatCount="indefinite" begin=".5s"/></ellipse>
    <ellipse cx="50" cy="25" rx="8" ry="15" fill="#d87895" transform="rotate(70 50 50)"><animate attributeName="ry" values="15;17;15" dur="3s" repeatCount="indefinite" begin="1s"/></ellipse>
    <ellipse cx="50" cy="25" rx="8" ry="15" fill="#d87895" transform="rotate(110 50 50)"><animate attributeName="ry" values="15;17;15" dur="3s" repeatCount="indefinite" begin="1.5s"/></ellipse>
    <ellipse cx="50" cy="25" rx="8" ry="15" fill="#d87895" transform="rotate(160 50 50)"><animate attributeName="ry" values="15;17;15" dur="3s" repeatCount="indefinite" begin="2s"/></ellipse>
  </svg>
  <h1>SIDE D: BLOOM</h1>
  <div class="sub">what the seeds became</div>
  <div class="boot-text" id="boot-text"></div>
</div>

<!-- Main CRT Screen -->
<div class="crt-screen" id="crt-screen">
  <div class="scan-bar"></div>
  <div id="noise-layer"></div>

  <div class="header">
    <a href="index.html" class="back-btn">â—€ EJECT</a>
    <div class="tape-label">SIDE D: BLOOM</div>
    <div class="status-text" id="status-text">ANALYZING...</div>
  </div>

  <div class="control-buttons">
    <button class="ctrl-btn" id="audio-btn">â™ª SFX OFF</button>
    <button class="ctrl-btn" id="music-btn">â™« MUSIC OFF</button>
    <button class="ctrl-btn" id="voice-btn">ğŸ”Š VOICE OFF</button>
  </div>

  <audio id="bgm" loop preload="auto"><source src="Wgft BURNER BOY.mp3" type="audio/mpeg"></audio>

  <div id="sheepy">
    <div class="sheepy-sprite" id="sheepy-sprite"></div>
    <div class="sheepy-text" id="sheepy-text"></div>
  </div>

  <div class="main-container" id="main-container">
    <div class="scene-container" id="scene-container">
      <!-- Dynamic content inserted here -->
    </div>
  </div>
</div>

<!-- Mini Game: The Moment -->
<div class="minigame-container" id="minigame-container">
  <div class="minigame-title">CATCH THE MOMENTS</div>
  <div class="minigame-area" id="minigame-area"></div>
  <div class="minigame-instruction" id="minigame-instruction">Tap the memories as they appear</div>
  <div class="minigame-progress" id="minigame-progress"></div>
</div>

<!-- Ending Container -->
<div class="ending-container" id="ending-container">
  <div class="ending-icon" id="ending-icon"></div>
  <div class="ending-title" id="ending-title"></div>
  <div class="ending-body" id="ending-body"></div>
  <div class="ending-song" id="ending-song"></div>
  <div class="ending-nav" id="ending-nav"></div>
  <div class="tape5-locked" id="tape5-locked">
    <div class="tape5-icon">
      <svg width="32" height="32" viewBox="0 0 32 32"><rect x="4" y="8" width="24" height="16" rx="2" fill="#222"/><rect x="8" y="12" width="16" height="8" rx="1" fill="#111"/><circle cx="12" cy="16" r="2" fill="#333"/><circle cx="20" cy="16" r="2" fill="#333"/></svg>
    </div>
    <div class="tape5-label">SIDE E: ???</div>
    <div class="tape5-hint">the future holds more</div>
  </div>
</div>

<script>
'use strict';

const $ = id => document.getElementById(id);
const sleep = ms => new Promise(r => setTimeout(r, ms));
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
const pick = arr => arr[Math.floor(Math.random() * arr.length)];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE - Load everything from tape1/2/3
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const State = {
  trust: 0, guard: 0, sync: 0, soil: 'barren',
  flags: new Set(),
  ending: null, // 'mercy', 'fight', 'defeat'
  turns: 0, damageDealt: 0, damageTaken: 0, grazes: 0, maxStreak: 0,
  phases: [],
  determinationUsed: false,
  voiceEnabled: false,
  moments: [], // Collected during mini-game
  valentineAnswer: null,
  
  load() {
    try {
      const saved = JSON.parse(localStorage.getItem('seed_archive_v3') || '{}');
      if (saved.tape1) {
        this.trust = saved.tape1.trust || 0;
        this.guard = saved.tape1.guard || 0;
        this.soil = saved.tape1.soil || 'barren';
        if (saved.tape1.flags) saved.tape1.flags.forEach(f => this.flags.add(f));
      }
      if (saved.tape2) {
        this.sync = saved.tape2.sync || 0;
        this.trust = Math.max(this.trust, saved.tape2.trust || 0);
        this.guard = Math.max(this.guard, saved.tape2.guard || 0);
        if (saved.tape2.flags) saved.tape2.flags.forEach(f => this.flags.add(f));
      }
      if (saved.tape3) {
        this.ending = saved.tape3.ending || 'defeat';
        this.turns = saved.tape3.turns || 0;
        this.damageDealt = saved.tape3.damageDealt || 0;
        this.damageTaken = saved.tape3.damageTaken || 0;
        this.grazes = saved.tape3.grazes || 0;
        this.maxStreak = saved.tape3.maxStreak || 0;
        this.phases = saved.tape3.phases || [];
        this.determinationUsed = saved.tape3.determinationUsed || false;
        if (saved.tape3.flags) saved.tape3.flags.forEach(f => this.flags.add(f));
      }
    } catch(e) { console.log('No previous state found'); }
  },
  
  has(id) { return this.flags.has(id); },
  
  save() {
    try {
      const s = JSON.parse(localStorage.getItem('seed_archive_v3') || '{}');
      s.tape4 = {
        complete: true,
        valentine: this.valentineAnswer,
        moments: this.moments,
        trust: this.trust,
        guard: this.guard,
        sync: this.sync,
        soil: this.soil,
        flags: [...this.flags]
      };
      localStorage.setItem('seed_archive_v3', JSON.stringify(s));
    } catch(e) {}
  },
  
  // Calculate overall "health" of the relationship
  getRelationshipScore() {
    let score = 0;
    score += this.trust * 0.4;
    score -= this.guard * 0.3;
    score += this.sync * 0.3;
    if (this.ending === 'mery') score += 20;
    if (this.ending === 'fight') score -= 10;
    if (this.ending === 'defeat') score -= 30;
    if (this.has('e_voice_shared')) score += 5;
    if (this.has('e_sunrise_together')) score += 5;
    if (this.has('e_physical_contact')) score += 5;
    if (this.has('e_door_closed')) score -= 5;
    if (this.has('e_pushed_away')) score -= 5;
    return clamp(Math.round(score), 0, 100);
  }
};

State.load();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIO
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Snd = {
  ctx: null, master: null, on: false,
  init() { if(this.ctx)return; this.ctx = new(window.AudioContext||window.webkitAudioContext)(); this.master = this.ctx.createGain(); this.master.gain.value = 0; this.master.connect(this.ctx.destination); },
  resume() { if(this.ctx?.state==='suspended')this.ctx.resume(); },
  vol(v, t=.5) { if(!this.master)return; const n=this.ctx.currentTime; this.master.gain.cancelScheduledValues(n); this.master.gain.setValueAtTime(this.master.gain.value,n); this.master.gain.linearRampToValueAtTime(v,n+t); },
  _osc(freq, dur, type='sine', vol=.05, delay=0) {
    if(!this.ctx||!this.on)return;
    const t=this.ctx.currentTime+delay, o=this.ctx.createOscillator(), g=this.ctx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+.015); g.gain.exponentialRampToValueAtTime(.001,t+dur);
    o.connect(g); g.connect(this.master); o.start(t); o.stop(t+dur+.05);
  },
  type() { this._osc(400+Math.random()*200,.02,'triangle',.015); },
  click() { this._osc(350,.06,'sine',.05); },
  select() { this._osc(300,.15,'sine',.05); this._osc(450,.12,'sine',.04,.06); },
  bloom() { [300,380,460,540].forEach((f,i)=>this._osc(f,.6,'sine',.04,i*.12)); },
  heart() { [250,320,400,480,560].forEach((f,i)=>this._osc(f,.8,'sine',.04,i*.15)); },
  memory() { this._osc(440,.4,'sine',.03); this._osc(550,.3,'sine',.025,.1); },
  sadness() { [200,180,160,140].forEach((f,i)=>this._osc(f,.6,'sine',.04,i*.2)); },
  hope() { [300,380,460,540,620].forEach((f,i)=>this._osc(f,.6,'sine',.035,i*.12)); },
  ensure() { this.init(); this.resume(); if(!this.on){this.on=true;this.vol(.5,1.2);$('audio-btn').textContent='â™ª SFX ON';$('audio-btn').classList.add('on');} },
  toggle() { this.init();this.resume();this.on=!this.on; if(this.on){this.vol(.5,1);$('audio-btn').textContent='â™ª SFX ON';$('audio-btn').classList.add('on');}else{this.vol(0,.6);$('audio-btn').textContent='â™ª SFX OFF';$('audio-btn').classList.remove('on');} }
};

const Music = {
  el: $('bgm'), playing: false,
  toggle() {
    if(this.playing){this.el.pause();this.playing=false;$('music-btn').textContent='â™« MUSIC OFF';$('music-btn').classList.remove('music-on');}
    else{this.el.volume=.2;const p=this.el.play();if(p)p.then(()=>{this.playing=true;$('music-btn').textContent='â™« BURNER â–¸';$('music-btn').classList.add('music-on');}).catch(()=>{});}
  },
  fadeOut(dur=3) {
    if(!this.playing)return;
    const start=this.el.volume,steps=40,step=start/steps;let i=0;
    const iv=setInterval(()=>{i++;this.el.volume=Math.max(0,start-step*i);if(i>=steps){clearInterval(iv);this.el.pause();this.playing=false;}},dur*1000/steps);
  }
};

$('audio-btn').onclick = () => Snd.toggle();
$('music-btn').onclick = () => Music.toggle();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TTS VOICE - Her voice
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Voice = {
  synth: null, voice: null, enabled: false, speaking: false,
  
  init() {
    if (!('speechSynthesis' in window)) return false;
    this.synth = window.speechSynthesis;
    
    // Try to find a good female voice
    const voices = this.synth.getVoices();
    // Prefer Japanese or soft female voices
    this.voice = voices.find(v => v.lang.includes('ja') && v.name.includes('Female')) ||
                  voices.find(v => v.name.includes('Samantha')) ||
                  voices.find(v => v.name.includes('Karen')) ||
                  voices.find(v => v.name.includes('Female')) ||
                  voices.find(v => v.lang.includes('en')) ||
                  voices[0];
    
    return !!this.voice;
  },
  
  speak(text, rate = 0.85, pitch = 1.1) {
    if (!this.enabled || !this.synth || !this.voice) return Promise.resolve();
    
    return new Promise(resolve => {
      // Cancel any ongoing speech
      this.synth.cancel();
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.voice = this.voice;
      utterance.rate = rate;
      utterance.pitch = pitch;
      utterance.volume = 0.8;
      
      this.speaking = true;
      showVoiceIndicator(true);
      
      utterance.onend = () => {
        this.speaking = false;
        showVoiceIndicator(false);
        resolve();
      };
      
      utterance.onerror = () => {
        this.speaking = false;
        showVoiceIndicator(false);
        resolve();
      };
      
      this.synth.speak(utterance);
    });
  },
  
  stop() {
    if (this.synth) this.synth.cancel();
    this.speaking = false;
    showVoiceIndicator(false);
  },
  
  toggle() {
    this.enabled = !this.enabled;
    $('voice-btn').textContent = this.enabled ? 'ğŸ”Š VOICE ON' : 'ğŸ”Š VOICE OFF';
    $('voice-btn').classList.toggle('on', this.enabled);
    return this.enabled;
  }
};

// Wait for voices to load
if ('speechSynthesis' in window) {
  speechSynthesis.onvoiceschanged = () => Voice.init();
  setTimeout(() => Voice.init(), 100);
}

$('voice-btn').onclick = () => Voice.toggle();

function showVoiceIndicator(show) {
  const indicator = document.querySelector('.voice-indicator');
  if (indicator) {
    if (show) indicator.classList.add('show');
    else indicator.classList.remove('show');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VFX
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const VFX = {
  flash(color = 'rgba(216,80,128,.2)', dur = 150) {
    const el = $('flash-overlay');
    el.style.background = color;
    el.classList.add('active');
    setTimeout(() => el.classList.remove('active'), dur);
  },
  
  particles(x, y, count = 8, color = '#d85080') {
    const c = $('particle-container');
    for (let i = 0; i < count; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      const sz = rand(3, 7);
      p.style.cssText = `left:${x}px;top:${y}px;width:${sz}px;height:${sz}px;background:${color};--tx:${rand(-60,60)}px;--ty:${rand(-60,60)}px;animation:pFly ${rand(.4,.8)}s ease-out forwards`;
      c.appendChild(p);
      setTimeout(() => p.remove(), 1000);
    }
  },
  
  sparkles(x, y, count = 5, color = '#fff') {
    const c = $('particle-container');
    for (let i = 0; i < count; i++) {
      const s = document.createElement('div');
      s.className = 'sparkle';
      s.style.cssText = `left:${x + rand(-30,30)}px;top:${y + rand(-30,30)}px;background:${color};animation:sparklePop ${rand(.3,.6)}s ease-out forwards;animation-delay:${rand(0,.2)}s`;
      c.appendChild(s);
      setTimeout(() => s.remove(), 800);
    }
  },
  
  // Falling petals
  startPetals(count = 15) {
    const c = $('particle-container');
    for (let i = 0; i < count; i++) {
      const p = document.createElement('div');
      p.className = 'petal';
      p.style.cssText = `left:${rand(5,95)}%;background:var(--pink-soft);animation:petalFall ${rand(8,15)}s linear infinite;animation-delay:${rand(0,8)}s`;
      c.appendChild(p);
    }
  },
  
  stopPetals() {
    document.querySelectorAll('.petal').forEach(p => p.remove());
  },
  
  vignette(on = true) {
    if (on) $('vignette').classList.add('active');
    else $('vignette').classList.remove('active');
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHEEPY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Sheepy = {
  moods: {
    nervous: 'M-6 6 Q-4 3 0 5 Q4 7 6 5',
    peaceful: 'M-6 6 Q0 10 6 6',
    happy: 'M-7 4 Q0 14 7 4',
    sad: 'M-7 8 Q0 2 7 8',
    hopeful: 'M-6 5 Q0 9 6 5',
    proud: 'M-6 3 Q0 12 6 3',
    crying: 'M-6 9 Q0 2 6 9',
    love: 'M-6 4 Q-3 10 0 8 Q3 10 6 4'
  },
  
  svg(mood, size = 70) {
    const m = this.moods[mood] || this.moods.nervous;
    const faceColor = mood === 'love' ? '#ffe0e8' : mood === 'happy' ? '#fff0f0' : '#ffeef2';
    return `<svg width="${size}" height="${size}" viewBox="0 0 120 120">
      <ellipse cx="60" cy="78" rx="38" ry="30" fill="#e4dcd0"/>
      <ellipse cx="36" cy="70" rx="14" ry="12" fill="#faf8f5"/>
      <ellipse cx="84" cy="70" rx="14" ry="12" fill="#faf8f5"/>
      <ellipse cx="60" cy="32" rx="22" ry="18" fill="${faceColor}"/>
      <ellipse cx="30" cy="22" rx="8" ry="6" fill="#d8a0b0" transform="rotate(-20 30 22)"/>
      <ellipse cx="90" cy="22" rx="8" ry="6" fill="#d8a0b0" transform="rotate(20 90 22)"/>
      <ellipse cx="48" cy="30" rx="5" ry="6" fill="#1a1a1a"><animate attributeName="ry" values="6;6;1;6;6" keyTimes="0;.4;.5;.6;1" dur="4s" repeatCount="indefinite"/></ellipse>
      <ellipse cx="72" cy="30" rx="5" ry="6" fill="#1a1a1a"><animate attributeName="ry" values="6;6;1;6;6" keyTimes="0;.4;.5;.6;1" dur="4s" repeatCount="indefinite"/></ellipse>
      <circle cx="49" cy="28" r="2" fill="#fff"/><circle cx="73" cy="28" r="2" fill="#fff"/>
      <ellipse cx="60" cy="44" rx="4" ry="3" fill="#b8a098"/>
      <g transform="translate(60 52)"><path d="${m}" stroke="#a89088" stroke-width="2.5" fill="none" stroke-linecap="round"/></g>
      ${mood === 'love' ? '<text x="75" y="30" font-size="14" fill="#ff5080">â™¡</text>' : ''}
    </svg>`;
  },
  
  show(mood) { $('sheepy-sprite').innerHTML = this.svg(mood); $('sheepy').classList.add('show'); },
  hide() { $('sheepy').classList.remove('show'); },
  text(t) { $('sheepy-text').textContent = t; }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCENE RENDERING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function showScene(content) {
  const container = $('scene-container');
  container.innerHTML = content.html;
  $('main-container').classList.add('show');
  
  // Animate elements
  await sleep(100);
  const title = container.querySelector('.scene-title');
  if (title) { await sleep(300); title.classList.add('show'); }
  
  const texts = container.querySelectorAll('.scene-text');
  for (const t of texts) {
    await sleep(400);
    t.classList.add('show');
    if (content.speak && t.classList.contains('her')) {
      await Voice.speak(t.textContent.replace(/[<>]/g, ''));
    }
  }
  
  const miniji = container.querySelector('.minji-container');
  if (miniji) { await sleep(500); miniji.classList.add('show'); }
  
  const stats = container.querySelector('.stats-container');
  if (stats) { await sleep(300); stats.classList.add('show'); }
  
  const valentine = container.querySelector('.valentine-container');
  if (valentine) { await sleep(500); valentine.classList.add('show'); }
  
  const choices = container.querySelector('.choices-container');
  if (choices) { await sleep(600); choices.classList.add('show'); }
  
  await sleep(500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DIALOGUE SYSTEM with Voice
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function showDialogue(text, speaker = null) {
  const container = $('scene-container');
  container.innerHTML = `<div class="scene-text">${text}</div>`;
  $('main-container').classList.add('show');
  
  await sleep(100);
  const t = container.querySelector('.scene-text');
  t.classList.add('show');
  
  if (speaker === 'her' && Voice.enabled) {
    const cleanText = text.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
    await Voice.speak(cleanText);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MINI GAME: CATCH THE MOMENTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const momentMemories = [
  { text: 'The notification at 2:47 PM', flag: 'finger_slip' },
  { text: 'Her voice note at 3am', flag: 'e_voice_shared' },
  { text: 'The sunrise you almost missed', flag: 'e_sunrise_together' },
  { text: 'Three seconds of contact', flag: 'e_physical_contact' },
  { text: 'When she laughed at your joke', flag: 'e_shared_laughter' },
  { text: 'The moment you opened up', flag: 'e_moment_opened' },
  { text: 'When you almost said it', flag: 'e_hesitated' },
  { text: 'Her typing indicator at midnight', flag: null },
  { text: 'The streak you kept alive', flag: 'e_snapchat_daily' },
  { text: 'When you pushed her away', flag: 'e_pushed_away', negative: true },
  { text: 'The door you closed', flag: 'e_door_closed', negative: true },
];

async function runMiniGame() {
  return new Promise(resolve => {
    const container = $('minigame-container');
    const area = $('minigame-area');
    const progress = $('minigame-progress');
    
    container.classList.add('active');
    area.innerHTML = '';
    progress.innerHTML = '';
    
    const totalMoments = 7;
    let caught = 0;
    let missed = 0;
    State.moments = [];
    
    // Create progress dots
    for (let i = 0; i < totalMoments; i++) {
      const dot = document.createElement('div');
      dot.className = 'minigame-dot';
      progress.appendChild(dot);
    }
    
    const spawnMoment = (index) => {
      if (index >= totalMoments) {
        setTimeout(() => {
          container.classList.remove('active');
          resolve({ caught, missed });
        }, 500);
        return;
      }
      
      const memory = pick(momentMemories);
      const target = document.createElement('div');
      target.className = 'minigame-target';
      target.textContent = 'ğŸ’«';
      target.title = memory.text;
      
      // Random position
      const size = area.offsetWidth - 50;
      target.style.left = rand(20, size) + 'px';
      target.style.top = rand(20, size) + 'px';
      target.classList.add('show');
      
      const handleCatch = (e) => {
        e.preventDefault();
        e.stopPropagation();
        caught++;
        Snd.memory();
        VFX.sparkles(e.clientX, e.clientY, 5, '#d87895');
        progress.children[index].classList.add('filled');
        State.moments.push({ text: memory.text, caught: true, negative: memory.negative });
        target.remove();
        setTimeout(() => spawnMoment(index + 1), 300);
      };
      
      target.addEventListener('click', handleCatch);
      target.addEventListener('touchend', handleCatch, { passive: false });
      
      area.appendChild(target);
      
      // Auto-remove after timeout
      setTimeout(() => {
        if (target.parentNode) {
          missed++;
          State.moments.push({ text: memory.text, caught: false, negative: memory.negative });
          target.remove();
          spawnMoment(index + 1);
        }
      }, 2500);
    };
    
    setTimeout(() => spawnMoment(0), 500);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT SEQUENCE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function typeBootLine(el, text, spd = 18) {
  for (let i = 0; i < text.length; i++) { el.textContent += text[i]; Snd.type(); await sleep(spd); }
  el.textContent += '\n';
}

async function boot() {
  const bt = $('boot-text');
  VFX.startPetals(10);
  
  await sleep(1200);
  await typeBootLine(bt, '> SEED ARCHIVE v3.0', 14);
  await sleep(300);
  await typeBootLine(bt, '> LOADING SIDE D: BLOOM...', 16);
  await sleep(250);
  
  Snd.ensure();
  
  // Show journey summary
  await typeBootLine(bt, '> JOURNEY SUMMARY:', 14);
  await sleep(150);
  await typeBootLine(bt, `  SOIL: ${State.soil.toUpperCase()}`, 12);
  await sleep(100);
  await typeBootLine(bt, `  WALL: ${State.ending ? State.ending.toUpperCase() : 'UNKNOWN'}`, 12);
  await sleep(100);
  await typeBootLine(bt, `  TURNS SURVIVED: ${State.turns}`, 12);
  await sleep(100);
  await typeBootLine(bt, `  TRUST: ${State.trust} | GUARD: ${State.guard} | SYNC: ${State.sync}`, 12);
  await sleep(200);
  
  // Special flags
  if (State.has('e_voice_shared')) await typeBootLine(bt, '> â™ª VOICE SHARED', 14);
  if (State.has('e_sunrise_together')) await typeBootLine(bt, '> â˜€ SUNRISE TOGETHER', 14);
  if (State.has('e_physical_contact')) await typeBootLine(bt, '> âœ‹ TOUCH MEMORY', 14);
  if (State.has('e_mercy_ending')) await typeBootLine(bt, '> â™¡ WALL FREED', 14);
  if (State.has('e_fight_ending')) await typeBootLine(bt, '> âœ• WALL BROKEN', 14);
  if (State.determinationUsed) await typeBootLine(bt, '> ğŸ’« DETERMINATION SPENT', 14);
  
  const score = State.getRelationshipScore();
  await sleep(200);
  await typeBootLine(bt, `> RELATIONSHIP SCORE: ${score}`, 14);
  await sleep(300);
  await typeBootLine(bt, '> INITIALIZING BLOOM SEQUENCE...', 16);
  await sleep(400);
  await typeBootLine(bt, '> READY.', 22);
  
  const cur = document.createElement('span');
  cur.className = 'boot-cursor';
  bt.appendChild(cur);
  
  await sleep(1800);
  $('loading-overlay').classList.add('hidden');
  await sleep(2500);
  
  // Start based on ending
  runStory();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN STORY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function runStory() {
  $('status-text').textContent = 'REFLECTING...';
  
  // Determine which story path
  if (State.ending === 'mercy') {
    await runMercyPath();
  } else if (State.ending === 'fight') {
    await runFightPath();
  } else {
    await runDefeatPath();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MERCY PATH - The Beautiful Ending
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function runMercyPath() {
  Music.toggle();
  $('status-text').textContent = 'BLOOMING';
  VFX.vignette(false);
  Sheepy.show('love');
  Sheepy.text('You did it beautifully.');
  
  // Opening
  await showScene({
    html: `
      <div class="scene-title">THE GATE OPENS</div>
      <div class="scene-text">The Wall you builtâ€”no, <span class="me">the Wall you understood</span>â€”</div>
      <div class="scene-text">It doesn't block you anymore.</div>
      <div class="scene-text">It never really was about keeping people out.</div>
      <div class="scene-text memory">It was about learning who you wanted to let in.</div>
    `
  });
  
  await sleep(4000);
  
  // Sheepy reflection
  await showDialogue(`<span class="me">Sheepy whispers:</span> <span class="memory">"You chose to understand instead of destroy. That matters more than you know."</span>`);
  await sleep(3000);
  
  // Mini game: relive moments
  await showDialogue(`<div class="scene-text">Close your eyes. Remember how it felt.</div>`);
  await sleep(2000);
  
  const gameResult = await runMiniGame();
  
  // Reflect on moments caught
  const caughtPositive = State.moments.filter(m => m.caught && !m.negative).length;
  const caughtNegative = State.moments.filter(m => m.caught && m.negative).length;
  
  await showDialogue(`<div class="scene-text">You caught ${caughtPositive} beautiful moments.</div>
    <div class="scene-text memory">${caughtNegative > 0 ? `And ${caughtNegative} painful ones. Both are yours.` : 'All light. No shadows.'}</div>`);
  await sleep(3500);
  
  // Show Minji
  Sheepy.hide();
  await showScene({
    html: `
      <div class="minji-container">
        <div class="minji-avatar"><span class="minji-icon">ğŸ‘¤</span></div>
        <div class="minji-name">MINJI</div>
        <div class="minji-status">online</div>
        <div class="voice-indicator">
          <div class="voice-waves">
            <div class="voice-wave"></div>
            <div class="voice-wave"></div>
            <div class="voice-wave"></div>
            <div class="voice-wave"></div>
            <div class="voice-wave"></div>
          </div>
          <span class="voice-text">speaking...</span>
        </div>
      </div>
      <div class="scene-text her" style="margin-top:30px">"Hey. You're still awake."</div>
    `,
    speak: true
  });
  
  await sleep(3000);
  
  // Her dialogue based on trust/sync
  let herDialogue;
  if (State.trust > 60 && State.sync > 60) {
    herDialogue = `"I can tell something's different. You seem... lighter.<br><br>Sheepy told me you faced yourself. That takes courage."`;
  } else if (State.trust > 40) {
    herDialogue = `"You've been quiet lately. But it's a good quiet.<br><br>Like you're finally listening to something."`;
  } else {
    herDialogue = `"I was worried about you. But you seem okay.<br><br>More than okay, actually."`;
  }
  
  await showDialogue(`<div class="scene-text her">${herDialogue}</div>`);
  await sleep(4000);
  
  // Deep moment
  await showDialogue(`
    <div class="scene-text her">"Can I tell you something?"</div>
  `);
  await sleep(2000);
  
  const confession = State.has('e_voice_shared') 
    ? `"That voice note you saved? I know you listen to it sometimes.<br><br>I listen to yours too.<br><br><span class="memory">Every night before I sleep."</span>`
    : `"When you added me back that day... I wasn't sure if you would.<br><br>I refreshed the app twelve times.<br><br><span class="memory">I'm glad you did."</span>`;
  
  await showDialogue(`<div class="scene-text her">${confession}</div>`);
  await sleep(4000);
  
  // Stats display
  await showScene({
    html: `
      <div class="scene-title">YOUR JOURNEY</div>
      <div class="stats-container show">
        <div class="stats-title">WHAT YOU BUILT</div>
        <div class="stat-row"><span class="stat-label">TRUST</span><span class="stat-value ${State.trust > 50 ? 'good' : ''}">${State.trust}%</span></div>
        <div class="stat-row"><span class="stat-label">GUARD</span><span class="stat-value ${State.guard > 50 ? 'bad' : 'good'}">${State.guard}%</span></div>
        <div class="stat-row"><span class="stat-label">SYNC</span><span class="stat-value ${State.sync > 50 ? 'good' : ''}">${State.sync}%</span></div>
        <div class="stat-row"><span class="stat-label">WALL</span><span class="stat-value good">FREED</span></div>
        <div class="stat-row"><span class="stat-label">MOMENTS</span><span class="stat-value">${State.moments.filter(m => m.caught).length} caught</span></div>
        <div class="stat-row"><span class="stat-label">GRAZES</span><span class="stat-value">${State.grazes} close calls</span></div>
        <div class="stat-row"><span class="stat-label">SCORE</span><span class="stat-value ${State.getRelationshipScore() > 50 ? 'good' : 'warn'}">${State.getRelationshipScore()}%</span></div>
      </div>
    `
  });
  
  await sleep(5000);
  
  // THE QUESTION
  Snd.heart();
  VFX.startPetals(25);
  
  await showScene({
    html: `
      <div class="minji-container show">
        <div class="minji-avatar"><span class="minji-icon">ğŸ’•</span></div>
        <div class="minji-name">MINJI</div>
      </div>
      <div class="valentine-container show">
        <div class="valentine-heart">ğŸ’Œ</div>
        <div class="valentine-question">"Hey... will you be my Valentine?"</div>
        <div class="valentine-options">
          <button class="valentine-btn yes" onclick="answerValentine('yes')">
            Yes
            <span class="preview">Of course. Always.</span>
          </button>
          <button class="valentine-btn" onclick="answerValentine('hesitate')">
            I...
            <span class="preview">[Hesitate]</span>
          </button>
          <button class="valentine-btn" onclick="answerValentine('ask_time')">
            It's not even February
            <span class="preview">[Deflect with humor]</span>
          </button>
        </div>
      </div>
    `
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIGHT PATH - The Bittersweet Ending
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function runFightPath() {
  Music.toggle();
  $('status-text').textContent = 'SCARRED';
  VFX.vignette(true);
  Sheepy.show('sad');
  Sheepy.text('You made it through. But...');
  
  await showScene({
    html: `
      <div class="scene-title">THE RUBBLE</div>
      <div class="scene-text">The Wall lies in pieces around you.</div>
      <div class="scene-text">You broke through. You made it.</div>
      <div class="scene-text damage">But something feels... missing.</div>
      <div class="scene-text memory">The parts of you that built the Wall are still in those stones.</div>
    `
  });
  
  await sleep(4500);
  
  await showDialogue(`<span class="me">Sheepy whispers:</span> <span class="memory">"Force works. But it leaves marks. On both sides."</span>`);
  await sleep(3000);
  
  // Show consequences of fighting
  const fightConsequence = State.fightCount > 5
    ? `Your guard is higher now. You chose violence ${State.fightCount} times.<br><br><span class="damage">That muscle memory doesn't fade easily.</span>`
    : `You fought when you had to. The Wall is down.<br><br><span class="memory">But the scars remain.</span>`;
  
  await showDialogue(`<div class="scene-text">${fightConsequence}</div>`);
  await sleep(3500);
  
  // Mini game - fewer moments, heavier
  const gameResult = await runMiniGame();
  
  await showDialogue(`<div class="scene-text">You caught ${State.moments.filter(m => m.caught).length} moments.</div>
    <div class="scene-text memory">But the ground is uneven where the Wall stood.</div>`);
  await sleep(3000);
  
  // Minji appears, but different
  Sheepy.hide();
  await showScene({
    html: `
      <div class="minji-container">
        <div class="minji-avatar"><span class="minji-icon">ğŸ‘¤</span></div>
        <div class="minji-name">MINJI</div>
        <div class="minji-status">online</div>
      </div>
      <div class="scene-text her" style="margin-top:30px">"You seem... different lately."</div>
    `
  });
  
  await sleep(3000);
  
  await showDialogue(`<div class="scene-text her">"Something happened. I can feel it.<br><br>You broke through something, didn't you?"</div>`);
  await sleep(3500);
  
  const herFightResponse = State.guard > 60
    ? `"I've been trying to reach you. But it's like...<br><br><span class="damage">there's a wall, even now."</span><br><br>I don't know how to help someone who won't let me in.`
    : `"Whatever you faced... I'm glad you're here.<br><br><span class="memory">Just... be gentle with yourself, okay?"</span>`;
  
  await showDialogue(`<div class="scene-text her">${herFightResponse}</div>`);
  await sleep(4000);
  
  // Stats
  await showScene({
    html: `
      <div class="scene-title">THE AFTERMATH</div>
      <div class="stats-container show">
        <div class="stats-title">WHAT REMAINS</div>
        <div class="stat-row"><span class="stat-label">TRUST</span><span class="stat-value ${State.trust > 50 ? 'good' : 'warn'}">${State.trust}%</span></div>
        <div class="stat-row"><span class="stat-label">GUARD</span><span class="stat-value bad">${State.guard}%</span></div>
        <div class="stat-row"><span class="stat-label">SYNC</span><span class="stat-value">${State.sync}%</span></div>
        <div class="stat-row"><span class="stat-label">WALL</span><span class="stat-value bad">BROKEN</span></div>
        <div class="stat-row"><span class="stat-label">METHOD</span><span class="stat-value warn">FORCE</span></div>
        <div class="stat-row"><span class="stat-label">FIGHTS</span><span class="stat-value bad">${State.fightCount || 'Unknown'}</span></div>
        <div class="stat-row"><span class="stat-label">SCORE</span><span class="stat-value ${State.getRelationshipScore() > 40 ? 'warn' : 'bad'}">${State.getRelationshipScore()}%</span></div>
      </div>
    `
  });
  
  await sleep(5000);
  
  // Valentine - harder path
  Snd.hope();
  
  await showScene({
    html: `
      <div class="minji-container show">
        <div class="minji-avatar"><span class="minji-icon">ğŸ’Œ</span></div>
      </div>
      <div class="valentine-container show">
        <div class="valentine-heart">ğŸ’•</div>
        <div class="valentine-question">"Hey... will you be my Valentine?"</div>
        <div class="valentine-options">
          <button class="valentine-btn yes" onclick="answerValentine('yes')">
            Yes
            <span class="preview">I want to try.</span>
          </button>
          <button class="valentine-btn" onclick="answerValentine('not_ready')">
            I'm not ready
            <span class="preview">[Honest]</span>
          </button>
          <button class="valentine-btn" onclick="answerValentine('dont_deserve')">
            I don't deserve that
            <span class="preview">[Self-doubt]</span>
          </button>
        </div>
      </div>
    `
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEFEAT PATH - The Painful Truth
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function runDefeatPath() {
  $('status-text').textContent = 'WILTED';
  VFX.vignette(true);
  Sheepy.show('crying');
  Sheepy.text('Some walls... don\'t come down.');
  
  Snd.sadness();
  
  await showScene({
    html: `
      <div class="scene-title">THE THORNS REMAIN</div>
      <div class="scene-text damage">You couldn't break through.</div>
      <div class="scene-text">The Wall still stands. The thorns grow thicker.</div>
      <div class="scene-text memory">Some barriers outlast the people who built them.</div>
    `
  });
  
  await sleep(4000);
  
  await showDialogue(`<span class="me">Sheepy whispers:</span> <span class="memory">"I'm sorry. Not every story has a happy ending.<br>But every ending has meaning."</span>`);
  await sleep(3500);
  
  // What could have been
  await showDialogue(`
    <div class="scene-text">You wonder what would have happened if:</div>
    <div class="scene-text memory">You had talked more instead of fighting.</div>
    <div class="scene-text memory">You had listened to your own patterns.</div>
    <div class="scene-text memory">You had let yourself be vulnerable.</div>
  `);
  
  await sleep(4000);
  
  // The ghost of a memory
  const ghostMemory = State.has('e_voice_shared')
    ? `You still have her voice note saved. You play it sometimes.<br><br><span class="her">"You saved it? That's..."</span><br><br>She never finished that sentence.`
    : `You remember the notification at 2:47 PM.<br><br><span class="memory">A Tuesday that could have split your life in two.</span><br><br>But the Wall was too strong.`;
  
  await showDialogue(`<div class="scene-text">${ghostMemory}</div>`);
  await sleep(4000);
  
  // One last message
  Sheepy.show('hopeful');
  Sheepy.text('But the next version of you...');
  
  await showDialogue(`
    <div class="scene-text gold">The next version of you will be stronger.</div>
    <div class="scene-text gold">The next version will know the Wall's weakness.</div>
    <div class="scene-text gold">The next version will try again.</div>
    <div class="scene-text memory">This is just one attempt. Not the final one.</div>
  `);
  
  await sleep(4500);
  
  // Stats - showing the failure
  await showScene({
    html: `
      <div class="scene-title">LESSONS LEARNED</div>
      <div class="stats-container show">
        <div class="stats-title">WHAT HAPPENED</div>
        <div class="stat-row"><span class="stat-label">TRUST</span><span class="stat-value bad">${State.trust}%</span></div>
        <div class="stat-row"><span class="stat-label">GUARD</span><span class="stat-value bad">${State.guard}%</span></div>
        <div class="stat-row"><span class="stat-label">SYNC</span><span class="stat-value bad">${State.sync}%</span></div>
        <div class="stat-row"><span class="stat-label">WALL</span><span class="stat-value bad">STANDING</span></div>
        <div class="stat-row"><span class="stat-label">PHASE REACHED</span><span class="stat-value bad">${State.phases.length > 0 ? Math.max(...State.phases) : 1}</span></div>
        <div class="stat-row"><span class="stat-label">TURNS</span><span class="stat-value">${State.turns}</span></div>
        <div class="stat-row"><span class="stat-label">SCORE</span><span class="stat-value bad">${State.getRelationshipScore()}%</span></div>
      </div>
    `
  });
  
  await sleep(4000);
  
  // No Valentine - the question never comes
  Snd.sadness();
  
  await showScene({
    html: `
      <div class="scene-title damage">THE MESSAGE NEVER COMES</div>
      <div class="scene-text">She doesn't ask.</div>
      <div class="scene-text">Maybe she sensed the Wall from the other side.</div>
      <div class="scene-text">Maybe the timing was never right.</div>
      <div class="scene-text memory">Or maybe... you weren't ready to receive it.</div>
    `
  });
  
  await sleep(4000);
  
  // Ending
  showEnding('defeat');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VALENTINE ANSWER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.answerValentine = async function(answer) {
  State.valentineAnswer = answer;
  Snd.select();
  
  document.querySelectorAll('.valentine-btn').forEach(b => {
    b.disabled = true;
    if (b.textContent.toLowerCase().includes(answer)) b.classList.add('selected');
  });
  
  await sleep(1000);
  
  let response, ending;
  
  if (answer === 'yes') {
    response = `
      <div class="scene-text her">"Really?"</div>
      <div class="scene-text her">"Like... really really?"</div>
      <div class="scene-text memory">Her voice cracks. Just a little.</div>
      <div class="scene-text her">"I've been wanting to ask you that for... a while now."</div>
    `;
    ending = 'yes';
  } else if (answer === 'hesitate') {
    response = `
      <div class="scene-text her">"You don't have to answer right now."</div>
      <div class="scene-text memory">She waits. She doesn't push.</div>
      <div class="scene-text her">"But... think about it? Please?"</div>
    `;
    ending = 'hesitate';
  } else if (answer === 'ask_time') {
    response = `
      <div class="scene-text her">"LOL okay fair."</div>
      <div class="scene-text her">"But seriously though... whenever you're ready."</div>
      <div class="scene-text memory">She laughs. The tension breaks.</div>
      <div class="scene-text her">"I'll ask again. In February. When it's socially acceptable."</div>
    `;
    ending = 'humor';
  } else if (answer === 'not_ready') {
    response = `
      <div class="scene-text her">"Oh."</div>
      <div class="scene-text memory">A pause. Not uncomfortable. Just... real.</div>
      <div class="scene-text her">"Okay. That's honest. I respect that."</div>
      <div class="scene-text her">"I'll be here. When you are."</div>
    `;
    ending = 'not_ready';
  } else if (answer === 'dont_deserve') {
    response = `
      <div class="scene-text her">"Hey."</div>
      <div class="scene-text damage">"Don't say that."</div>
      <div class="scene-text her">"You faced yourself. That's more than most people ever do."</div>
      <div class="scene-text memory">"Deserving isn't the question. Readiness is."</div>
    `;
    ending = 'self_doubt';
  }
  
  await showDialogue(response);
  await sleep(4000);
  
  // Final moment
  if (ending === 'yes' || ending === 'humor') {
    Snd.heart();
    VFX.startPetals(40);
    VFX.flash('rgba(216,80,128,.15)', 500);
    
    await showDialogue(`
      <div class="scene-title gold">SHE SAYS:</div>
      <div class="scene-text her">"Then it's settled."</div>
      <div class="scene-text her">"You're mine now. No take-backs."</div>
      <div class="scene-text memory">She sends a photo. It's blurry. It's imperfect. It's her smiling.</div>
    `);
  }
  
  await sleep(3000);
  
  // Show ending
  showEnding(ending);
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENDING DISPLAY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function showEnding(type) {
  Music.fadeOut(4);
  VFX.stopPetals();
  $('main-container').classList.remove('show');
  
  const score = State.getRelationshipScore();
  const icon = $('ending-icon');
  const title = $('ending-title');
  const body = $('ending-body');
  const song = $('ending-song');
  const nav = $('ending-nav');
  const tape5 = $('tape5-locked');
  
  if (type === 'yes') {
    icon.textContent = 'ğŸŒ¸';
    title.textContent = 'BLOOM';
    title.style.color = 'var(--gold-glow)';
    body.innerHTML = `
      You said yes.<br><br>
      Not because you were certain. Not because it was easy.<br>
      But because some things are worth the risk.<br><br>
      <span class="her">The thorns part. What grows next is up to you both.</span>
    `;
    song.innerHTML = 'â™ª Now playing: BURNER BOY â€” her favorite song';
  } else if (type === 'hesitate') {
    icon.textContent = 'ğŸŒ±';
    title.textContent = 'THE SEED';
    title.style.color = 'var(--bloom-pale)';
    body.innerHTML = `
      You hesitated.<br><br>
      Not a no. Not a yes. Just... a pause.<br>
      Sometimes the most honest answer is "I need time."<br><br>
      <span class="memory">She's still there. Waiting. That means something.</span>
    `;
  } else if (type === 'humor') {
    icon.textContent = 'ğŸ˜„';
    title.textContent = 'THE LAUGH';
    title.style.color = 'var(--pink-soft)';
    body.innerHTML = `
      You made her laugh.<br><br>
      In a moment that could have been heavy, you chose light.<br>
      Sometimes that's its own kind of yes.<br><br>
      <span class="her">"See you in February, then."</span>
    `;
  } else if (type === 'not_ready') {
    icon.textContent = 'â³';
    title.textContent = 'NOT YET';
    title.style.color = 'var(--gold-glow)';
    body.innerHTML = `
      You were honest.<br><br>
      The hardest thing to say: "I'm not ready."<br>
      The bravest thing she did: Listen.<br><br>
      <span class="memory">Not every ending is a door closing. Some are just... a pause.</span>
    `;
  } else if (type === 'self_doubt') {
    icon.textContent = 'ğŸ’”';
    title.textContent = 'THE CRACK';
    title.style.color = 'var(--bloom-glow)';
    body.innerHTML = `
      You don't believe you deserve this.<br><br>
      Maybe that's the real Wall. Not the one you faced.<br>
      But the one inside that says you're not enough.<br><br>
      <span class="her">She sees something in you. Even if you can't.</span>
    `;
  } else {
    // Defeat ending
    icon.textContent = 'ğŸ¥€';
    title.textContent = 'THE WILTED GARDEN';
    title.style.color = 'var(--dim)';
    body.innerHTML = `
      Some walls don't come down in one lifetime.<br><br>
      This was one attempt. One version of the story.<br>
      The next you will be stronger. Wiser. More ready.<br><br>
      <span class="memory">The seeds remember the rain. Even when nothing blooms.</span>
    `;
  }
  
  // Navigation
  nav.innerHTML = `
    <a href="index.html">â† RETURN TO ARCHIVE</a>
  `;
  
  // Tape 5 locked icon
  tape5.classList.add('show');
  
  State.save();
  
  // Show ending
  await sleep(1000);
  $('ending-container').classList.add('show');
}

// Start
boot();
</script>
</body>
</html>
